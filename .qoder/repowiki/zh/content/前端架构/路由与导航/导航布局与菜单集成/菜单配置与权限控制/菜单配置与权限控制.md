# 菜单配置与权限控制

<cite>
**本文档引用文件**  
- [menu.ts](file://frontend/src/config/menu.ts)
- [permissions.ts](file://frontend/src/utils/permissions.ts)
- [menuIcons.tsx](file://frontend/src/config/menuIcons.tsx)
- [useAppStore.ts](file://frontend/src/store/useAppStore.ts)
- [MainLayout.tsx](file://frontend/src/layouts/MainLayout.tsx)
- [router/index.tsx](file://frontend/src/router/index.tsx)
- [PermissionService.ts](file://backend/src/services/PermissionService.ts)
- [position-permissions.ts](file://backend/src/routes/v2/position-permissions.ts)
- [permissions.ts](file://backend/src/utils/permissions.ts)
- [permission.ts](file://backend/src/middleware/permission.ts)
- [PrivateRoute.tsx](file://frontend/src/router/PrivateRoute.tsx)
</cite>

## 目录
1. [菜单系统概述](#菜单系统概述)
2. [动态菜单生成机制](#动态菜单生成机制)
3. [权限控制实现](#权限控制实现)
4. [页面标题与路径映射](#页面标题与路径映射)
5. [菜单分组与后端权限体系](#菜单分组与后端权限体系)
6. [敏感菜单项访问控制](#敏感菜单项访问控制)
7. [系统架构与数据流](#系统架构与数据流)

## 菜单系统概述

本系统采用基于用户角色和权限的动态菜单生成机制，通过前端配置与后端权限体系的紧密结合，实现细粒度的菜单可见性控制。菜单系统主要由以下几个核心组件构成：`buildMenuItems`函数负责根据用户权限动态生成菜单项；`hasPermission`工具函数实现权限检查；`pageTitles`对象为每个路由提供友好的页面标题；`KEY_TO_PATH`和`PATH_TO_KEY`双向映射表实现菜单key与URL路径的精准转换。

**Section sources**
- [menu.ts](file://frontend/src/config/menu.ts#L5-L313)

## 动态菜单生成机制

`buildMenuItems`函数是菜单系统的核心，它根据用户信息动态生成菜单项。该函数接收用户信息作为参数，返回符合用户权限的菜单配置。菜单生成过程遵循以下逻辑：

1. **我的工作台**：对所有用户可见，包含个人中心、请假、报销等基础功能。
2. **财务管理**：根据用户在财务模块的权限动态显示相关菜单项，如新建记账、收支明细等。
3. **人力资源**：根据用户职位和权限显示相应的HR功能，如人员管理、薪资发放等。
4. **站点管理**：根据用户对站点信息和账单的查看权限决定是否显示相关菜单。
5. **资产管理**：根据用户对固定资产和租房管理的权限动态生成菜单。
6. **报表中心**：根据用户报表查看权限，分组显示财务、往来和运营报表。
7. **系统设置**：仅对具有相应权限的用户显示，如项目管理、权限管理等。

```mermaid
flowchart TD
Start([开始]) --> CheckUserInfo["检查用户信息"]
CheckUserInfo --> UserInfoValid{"用户信息有效?"}
UserInfoValid --> |否| ReturnEmpty["返回空菜单"]
UserInfoValid --> |是| BuildMyCenter["构建我的工作台菜单"]
BuildMyCenter --> BuildFinance["构建财务管理菜单"]
BuildFinance --> BuildHR["构建人力资源菜单"]
BuildHR --> BuildSites["构建站点管理菜单"]
BuildSites --> BuildAssets["构建资产管理菜单"]
BuildAssets --> BuildReports["构建报表中心菜单"]
BuildReports --> BuildSystem["构建系统设置菜单"]
BuildSystem --> CombineMenus["合并所有菜单项"]
CombineMenus --> ReturnResult["返回最终菜单配置"]
ReturnEmpty --> End([结束])
ReturnResult --> End
```

**Diagram sources**
- [menu.ts](file://frontend/src/config/menu.ts#L64-L247)

**Section sources**
- [menu.ts](file://frontend/src/config/menu.ts#L64-L247)

## 权限控制实现

权限控制通过`hasPermission`工具函数实现，该函数基于用户的职位权限系统进行权限检查。权限结构采用三级模型：模块（module）、子模块（subModule）和操作（action）。函数实现逻辑如下：

1. 首先检查用户职位是否存在权限配置。
2. 检查指定模块是否存在权限定义。
3. 如果只检查模块权限，则返回true。
4. 检查指定子模块是否存在权限定义。
5. 如果只检查子模块权限，则返回子模块权限数组是否非空。
6. 最后检查具体操作权限是否包含在权限数组中。

```mermaid
flowchart TD
Start([函数入口]) --> CheckPosition["检查用户职位权限"]
CheckPosition --> PositionValid{"职位权限存在?"}
PositionValid --> |否| ReturnFalse["返回false"]
PositionValid --> |是| CheckModule["检查模块权限"]
CheckModule --> ModuleValid{"模块权限存在?"}
ModuleValid --> |否| ReturnFalse
ModuleValid --> |是| CheckSubModule["检查子模块参数"]
CheckSubModule --> SubModuleProvided{"提供子模块?"}
SubModuleProvided --> |否| ReturnTrue["返回true"]
SubModuleProvided --> |是| CheckSubModulePerms["检查子模块权限"]
CheckSubModulePerms --> SubModulePermsValid{"子模块权限有效?"}
SubModulePermsValid --> |否| ReturnFalse
SubModulePermsValid --> |是| CheckAction["检查操作参数"]
CheckAction --> ActionProvided{"提供操作?"}
ActionProvided --> |否| ReturnSubModuleNotEmpty["返回子模块权限非空"]
ActionProvided --> |是| CheckActionInPerms["检查操作是否在权限中"]
CheckActionInPerms --> ActionInPerms{"操作在权限中?"}
ActionInPerms --> |否| ReturnFalse
ActionInPerms --> |是| ReturnTrue
ReturnFalse --> End([函数退出])
ReturnTrue --> End
```

**Diagram sources**
- [permissions.ts](file://frontend/src/utils/permissions.ts#L21-L43)

**Section sources**
- [permissions.ts](file://frontend/src/utils/permissions.ts#L21-L43)
- [menu.ts](file://frontend/src/config/menu.ts#L2)

## 页面标题与路径映射

系统通过`pageTitles`对象为每个路由提供友好的页面标题，提升用户体验。同时，通过`KEY_TO_PATH`和`PATH_TO_KEY`双向映射表实现菜单key与URL路径的精准转换。

`pageTitles`对象定义了菜单key与中文标题的映射关系，如`'flow-create'`对应`'新建记账'`。这种设计使得页面标题的维护更加集中和方便。

`KEY_TO_PATH`映射表将菜单key转换为实际的URL路径，如`'flow-create'`映射到`'/finance/flows/create'`。`PATH_TO_KEY`则是反向映射，通过`Object.entries(KEY_TO_PATH).reduce`方法动态生成，实现了路径到菜单key的快速查找。

```mermaid
classDiagram
class pageTitles {
+Record<string, string>
+my-center : 个人中心
+flow-create : 新建记账
+flows : 收支明细
+account-transfer : 账户转账
+import : 数据导入
+borrowings : 借款管理
+ar : 应收账款
+ap : 应付账款
}
class KEY_TO_PATH {
+Record<string, string>
+my-center : /my/center
+flow-create : /finance/flows/create
+flows : /finance/flows
+account-transfer : /finance/transfer
+import : /finance/import
+borrowings : /finance/borrowings
+ar : /finance/ar
+ap : /finance/ap
}
class PATH_TO_KEY {
+Record<string, string>
+/my/center : my-center
+/finance/flows/create : flow-create
+/finance/flows : flows
+/finance/transfer : account-transfer
+/finance/import : import
+/finance/borrowings : borrowings
+/finance/ar : ar
+/finance/ap : ap
}
KEY_TO_PATH --> PATH_TO_KEY : "通过reduce生成"
```

**Diagram sources**
- [menu.ts](file://frontend/src/config/menu.ts#L5-L313)

**Section sources**
- [menu.ts](file://frontend/src/config/menu.ts#L5-L313)

## 菜单分组与后端权限体系

菜单系统与后端权限体系紧密对应，形成了完整的权限控制闭环。前端菜单分组逻辑与后端权限模块一一对应：

1. **财务管理**：对应后端`finance`模块，包含`flow`、`transfer`、`borrowing`等子模块。
2. **人力资源**：对应后端`hr`模块，包含`employee`、`salary`、`leave`等子模块。
3. **站点管理**：对应后端`site`模块，包含`info`、`bill`等子模块。
4. **资产管理**：对应后端`asset`模块，包含`fixed`、`rental`等子模块。
5. **报表中心**：对应后端`report`模块，包含各类报表查看权限。
6. **系统设置**：对应后端`system`模块，包含`department`、`category`、`position`等子模块。

后端通过`PermissionService`类实现权限检查，结合用户职位层级和部门信息，确保数据访问的安全性。权限中间件`requirePermission`在路由层面进行权限验证，与前端菜单权限检查形成双重保障。

```mermaid
graph TB
subgraph "前端"
A[菜单分组]
A --> B[财务管理]
A --> C[人力资源]
A --> D[站点管理]
A --> E[资产管理]
A --> F[报表中心]
A --> G[系统设置]
end
subgraph "后端"
H[权限模块]
H --> I[finance]
H --> J[hr]
H --> K[site]
H --> L[asset]
H --> M[report]
H --> N[system]
end
B --> I
C --> J
D --> K
E --> L
F --> M
G --> N
```

**Diagram sources**
- [menu.ts](file://frontend/src/config/menu.ts#L14-L61)
- [permissions.ts](file://backend/src/utils/permissions.ts#L99-L125)

**Section sources**
- [menu.ts](file://frontend/src/config/menu.ts#L14-L61)
- [permissions.ts](file://backend/src/utils/permissions.ts#L99-L125)
- [PermissionService.ts](file://backend/src/services/PermissionService.ts#L6-L147)

## 敏感菜单项访问控制

系统对敏感菜单项实施严格的访问控制策略，确保只有授权用户才能访问关键功能。主要控制策略包括：

1. **系统管理菜单**：只有`hq_manager`（总部主管）职位的用户才能看到权限管理、IP白名单、审计日志等敏感菜单项。
2. **数据导入功能**：需要同时具备财务权限和负责人权限，防止普通财务人员随意导入数据。
3. **财务基础数据管理**：整合为"财务设置"菜单，只有具有系统模块部门管理权限的用户才能访问。
4. **审批功能**：只有`canManageSubordinates`为1的管理者才能看到"我的审批"菜单。

这些控制策略通过前端`buildMenuItems`函数中的条件判断实现，与后端权限体系保持一致，形成前后端协同的权限控制机制。

```mermaid
flowchart TD
Start([开始]) --> CheckPositionCode["检查职位代码"]
CheckPositionCode --> IsHQManager{"职位是hq_manager?"}
IsHQManager --> |是| ShowSystemMenu["显示系统管理菜单"]
IsHQManager --> |否| CheckFinanceRole["检查财务角色"]
CheckFinanceRole --> IsFinance{"角色是finance?"}
IsFinance --> |是| CheckDirector["检查是否是director"]
IsFinance --> |否| CheckDirector
CheckDirector --> IsDirector{"角色是director?"}
IsDirector --> |是| ShowImportMenu["显示数据导入菜单"]
IsDirector --> |否| CheckCanManage["检查管理权限"]
CheckCanManage --> CanManage{"canManageSubordinates=1?"}
CanManage --> |是| ShowApprovalsMenu["显示我的审批菜单"]
CanManage --> |否| HideMenus["隐藏敏感菜单"]
ShowSystemMenu --> End([结束])
ShowImportMenu --> End
ShowApprovalsMenu --> End
HideMenus --> End
```

**Diagram sources**
- [menu.ts](file://frontend/src/config/menu.ts#L236-L241)
- [menu.ts](file://frontend/src/config/menu.ts#L104-L106)
- [menu.ts](file://frontend/src/config/menu.ts#L76-L78)

**Section sources**
- [menu.ts](file://frontend/src/config/menu.ts#L236-L241)
- [menu.ts](file://frontend/src/config/menu.ts#L104-L106)
- [menu.ts](file://frontend/src/config/menu.ts#L76-L78)

## 系统架构与数据流

整个菜单系统的架构和数据流如下图所示：

```mermaid
sequenceDiagram
participant User as "用户"
participant Frontend as "前端"
participant Backend as "后端"
User->>Frontend : 登录系统
Frontend->>Backend : 发送认证请求
Backend-->>Frontend : 返回用户信息和权限
Frontend->>Frontend : 存储用户信息(useAppStore)
Frontend->>Frontend : 调用buildMenuItems生成菜单
Frontend->>Frontend : 根据权限过滤菜单项
Frontend->>User : 显示个性化菜单
User->>Frontend : 点击菜单项
Frontend->>Frontend : 通过KEY_TO_PATH获取路径
Frontend->>Frontend : 导航到对应页面
Frontend->>Backend : 请求页面数据
Backend->>Backend : 通过hasPermission验证权限
Backend-->>Frontend : 返回数据
Frontend-->>User : 显示页面内容
```

**Diagram sources**
- [useAppStore.ts](file://frontend/src/store/useAppStore.ts#L43-L89)
- [MainLayout.tsx](file://frontend/src/layouts/MainLayout.tsx#L14-L286)
- [router/index.tsx](file://frontend/src/router/index.tsx#L165-L256)
- [permission.ts](file://backend/src/middleware/permission.ts#L12-L19)

**Section sources**
- [useAppStore.ts](file://frontend/src/store/useAppStore.ts#L43-L89)
- [MainLayout.tsx](file://frontend/src/layouts/MainLayout.tsx#L14-L286)
- [router/index.tsx](file://frontend/src/router/index.tsx#L165-L256)
- [permission.ts](file://backend/src/middleware/permission.ts#L12-L19)