# 员工选择器

<cite>
**本文档引用的文件**  
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx)
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts)
- [employee.schema.ts](file://frontend/src/validations/employee.schema.ts)
- [LeaveManagementPage.tsx](file://frontend/src/features/hr/pages/LeaveManagementPage.tsx)
- [SalaryPaymentsPage.tsx](file://frontend/src/features/hr/pages/SalaryPaymentsPage.tsx)
- [permissions.ts](file://frontend/src/utils/permissions.ts)
- [useBusinessData.ts](file://frontend/src/hooks/useBusinessData.ts)
</cite>

## 目录
1. [简介](#简介)
2. [核心功能与实现](#核心功能与实现)
3. [多维度搜索与状态过滤](#多维度搜索与状态过滤)
4. [在HR核心流程中的使用模式](#在hr核心流程中的使用模式)
5. [权限系统集成](#权限系统集成)
6. [Zod验证规则](#zod验证规则)
7. [复杂表单中的嵌套使用示例](#复杂表单中的嵌套使用示例)

## 简介
`EmployeeSelect` 是一个封装了员工选择逻辑的前端组件，用于在表单中统一选择员工信息。该组件支持按姓名、工号、部门等多维度搜索，并集成在职、离职等状态过滤功能。它广泛应用于薪资发放、请假申请等HR核心流程中，确保用户只能选择其权限范围内的员工，并通过Zod实现必填、唯一性等校验规则。

## 核心功能与实现

`EmployeeSelect` 组件基于 Ant Design 的 `Select` 组件进行封装，结合 `useEmployees` Hook 获取员工数据，支持自定义标签格式化和部门信息显示。其核心功能包括：

- 支持仅显示活跃员工（`activeOnly`）
- 可选显示部门信息（`showDepartment`）
- 自定义标签格式化函数（`formatLabel`）
- 集成搜索功能，支持按标签过滤

该组件通过 `useEmployees` Hook 获取员工列表，并根据配置项对选项进行格式化处理，最终渲染为下拉选择器。

**本节来源**  
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx#L1-L74)

## 多维度搜索与状态过滤

`EmployeeSelect` 组件通过 `useEmployees` Hook 实现多维度搜索与状态过滤功能。该 Hook 接收 `status` 和 `activeOnly` 参数，用于过滤员工状态。

### 状态过滤逻辑
组件默认仅显示活跃员工（`activeOnly = true`），即 `active = 1` 且 `status ≠ 'resigned'` 的员工。此逻辑在 `useEmployees` 和 `useBusinessData` 中均有实现：

```ts
.filter((e: any) => !activeOnly || (e.active === 1 && e.status !== 'resigned'))
```

### 搜索维度
组件支持通过以下字段进行搜索：
- 员工姓名（`name`）
- 部门名称（`departmentName`）
- 工号（`id`）

搜索功能由 Ant Design 的 `Select` 组件原生支持，通过 `optionFilterProp="label"` 实现基于标签的过滤。

**本节来源**  
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx#L36)
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts#L20-L33)
- [useBusinessData.ts](file://frontend/src/hooks/useBusinessData.ts#L118-L135)

## 在HR核心流程中的使用模式

`EmployeeSelect` 组件在HR核心流程中被广泛使用，主要体现在薪资发放和请假申请两个场景。

### 薪资发放流程
在 `SalaryPaymentsPage` 中，虽然未直接使用 `EmployeeSelect`，但其数据源和权限控制逻辑一致。薪资发放流程涉及多个角色（财务、HR）的协作，通过状态机管理薪资单的生命周期。

### 请假申请流程
在 `LeaveManagementPage` 中，`EmployeeSelect` 被直接用于新建请假申请的表单中：

```tsx
<Form.Item name="employeeId" label="员工">
  <EmployeeSelect placeholder="请选择员工" />
</Form.Item>
```

该组件在此场景中支持单选配置，用户选择员工后可填写请假类型、时间、原因等信息。流程包括：
1. 员工提交请假申请
2. 管理者或HR审批
3. 状态更新与记录

**本节来源**  
- [LeaveManagementPage.tsx](file://frontend/src/features/hr/pages/LeaveManagementPage.tsx#L479)
- [SalaryPaymentsPage.tsx](file://frontend/src/features/hr/pages/SalaryPaymentsPage.tsx)

## 权限系统集成

`EmployeeSelect` 组件与系统的权限系统深度集成，确保用户只能选择其可访问范围内的员工。

### 权限控制机制
权限系统基于职位（Position）的权限配置，通过 `usePermissions` Hook 提供权限检查功能：

```ts
export function usePermissions() {
  const { userInfo: user } = useAppStore()
  // ...
  return {
    hasPermission,
    isManager,
    isFinance,
    isHR,
    // ...
  }
}
```

### 数据访问控制
员工数据的访问受以下权限控制：
- **HR人员**：可查看所有员工
- **部门管理者**：可查看本部门员工
- **普通员工**：仅可查看自己

此控制逻辑在后端API层面实现，前端组件通过调用受权限保护的接口获取数据。

**本节来源**  
- [permissions.ts](file://frontend/src/utils/permissions.ts)
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts)

## Zod验证规则

系统使用 Zod 进行表单验证，`employee.schema.ts` 文件定义了员工相关操作的验证规则。

### 必填校验
在创建员工时，姓名、部门、职位等字段为必填项：

```ts
name: z.string().min(1, '请输入姓名'),
orgDepartmentId: z.string().min(1, '请选择部门'),
positionId: z.string().min(1, '请选择职位'),
```

### 唯一性校验
唯一性校验由后端实现，前端通过API响应处理冲突。例如，在创建员工时，若工号重复，后端返回 `409 Conflict` 状态码。

### 其他校验
- 日期字段：使用 `dayjs` 验证有效性
- 密码一致性：通过 `.refine()` 方法验证两次输入的密码是否一致

**本节来源**  
- [employee.schema.ts](file://frontend/src/validations/employee.schema.ts)

## 复杂表单中的嵌套使用示例

`EmployeeSelect` 组件可在复杂表单中嵌套使用，典型场景包括员工信息编辑、薪资配置等。

### 员工信息编辑表单
在 `EditEmployeeModal` 中，`EmployeeSelect` 可与其他表单组件结合使用：

```tsx
<Form.Item name="managerId" label="直属上级">
  <EmployeeSelect placeholder="请选择直属上级" showDepartment={true} />
</Form.Item>
```

### 薪资配置表单
在薪资配置场景中，可结合 `CurrencySelect` 和 `AmountInput` 实现多币种薪资设置：

```tsx
<Form.Item name="bonusRecipientId" label="奖金接收人">
  <EmployeeSelect placeholder="请选择员工" />
</Form.Item>
```

此类嵌套使用确保了表单的一致性和用户体验的统一。

**本节来源**  
- [EditEmployeeModal.tsx](file://frontend/src/features/employees/components/modals/EditEmployeeModal.tsx)
- [SalaryConfigModal.tsx](file://frontend/src/features/employees/components/modals/SalaryConfigModal.tsx)