# 表单组件

<cite>
**本文档引用的文件**  
- [AccountSelect.tsx](file://frontend/src/components/form/AccountSelect.tsx)
- [CurrencySelect.tsx](file://frontend/src/components/form/CurrencySelect.tsx)
- [AmountInput.tsx](file://frontend/src/components/form/AmountInput.tsx)
- [DepartmentSelect.tsx](file://frontend/src/components/form/DepartmentSelect.tsx)
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx)
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts)
- [useCurrencies.ts](file://frontend/src/hooks/business/useCurrencies.ts)
- [useDepartments.ts](file://frontend/src/hooks/business/useDepartments.ts)
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts)
- [EmployeeForm.tsx](file://frontend/src/features/employees/components/forms/EmployeeForm.tsx)
- [SalaryPaymentsPage.tsx](file://frontend/src/features/hr/pages/SalaryPaymentsPage.tsx)
- [useZodForm.ts](file://frontend/src/hooks/forms/useZodForm.ts)
- [salary.schema.ts](file://frontend/src/validations/salary.schema.ts)
- [employee.schema.ts](file://frontend/src/validations/employee.schema.ts)
</cite>

## 目录
1. [引言](#引言)
2. [核心表单组件分析](#核心表单组件分析)
3. [数据加载与缓存机制](#数据加载与缓存机制)
4. [表单验证与UI联动](#表单验证与ui联动)
5. [实际应用场景](#实际应用场景)
6. [结论](#结论)

## 引言
本文档系统阐述财务系统中领域专用表单控件的封装原则与工程实践。重点解析AccountSelect、CurrencySelect、AmountInput、DepartmentSelect和EmployeeSelect等核心组件的实现机制，分析其在员工管理、薪资发放等业务场景中的应用模式。

## 核心表单组件分析

### AccountSelect账户选择器
AccountSelect组件封装了账户下拉选择的逻辑，通过useAccounts Hook实现账户数据的异步加载和缓存管理。组件支持按币种过滤账户、显示币种信息等配置选项，并提供onAccountChange回调以获取账户信息。

**组件特性**：
- 支持按币种过滤账户
- 可自定义账户标签格式化
- 提供账户选择回调
- 内置搜索过滤功能

```mermaid
flowchart TD
Start([AccountSelect初始化]) --> LoadData["调用useAccounts Hook加载数据"]
LoadData --> CheckLoading{"数据加载中?"}
CheckLoading --> |是| ShowLoading["显示加载状态"]
CheckLoading --> |否| FilterData["根据filterByCurrency过滤账户"]
FilterData --> FormatOptions["格式化为Select选项"]
FormatOptions --> Render["渲染Select组件"]
Render --> End([组件渲染完成])
```

**组件源码**
- [AccountSelect.tsx](file://frontend/src/components/form/AccountSelect.tsx)

### CurrencySelect币种选择器
CurrencySelect组件实现了币种选择功能，通过useCurrencies Hook获取币种数据。组件支持仅显示币种代码或完整名称，并可自定义标签格式。

**组件特性**：
- 支持codeOnly模式
- 可自定义币种标签格式化
- 内置搜索过滤
- 智能弹出容器定位

```mermaid
flowchart TD
Start([CurrencySelect初始化]) --> LoadData["调用useCurrencies Hook加载数据"]
LoadData --> CheckLoading{"数据加载中?"}
CheckLoading --> |是| ShowLoading["显示加载状态"]
CheckLoading --> |否| FormatOptions["格式化为Select选项"]
FormatOptions --> CheckCodeOnly{"codeOnly模式?"}
CheckCodeOnly --> |是| UseCode["使用币种代码作为标签"]
CheckCodeOnly --> |否| UseFull["使用完整名称作为标签"]
UseCode --> Render
UseFull --> Render
Render --> End([组件渲染完成])
```

**组件源码**
- [CurrencySelect.tsx](file://frontend/src/components/form/CurrencySelect.tsx)

### AmountInput金额输入框
AmountInput组件封装了金额输入的逻辑，提供实时格式化、精度控制和正负值校验功能。

**组件特性**：
- 支持千分位分隔
- 可配置小数位数
- 支持负数输入
- 币种符号显示

```mermaid
flowchart TD
Start([AmountInput初始化]) --> SetProps["设置组件属性"]
SetProps --> CheckPrecision["检查precision属性"]
CheckPrecision --> CheckNegative["检查allowNegative属性"]
CheckNegative --> CheckCurrency["检查currency属性"]
CheckCurrency --> Render["渲染InputNumber组件"]
Render --> End([组件渲染完成])
```

**组件源码**
- [AmountInput.tsx](file://frontend/src/components/form/AmountInput.tsx)

### DepartmentSelect部门选择器
DepartmentSelect组件实现了部门选择功能，通过useDepartments Hook获取部门数据。

**组件特性**：
- 支持自定义部门标签格式化
- 内置搜索过滤
- 支持树形结构展示

```mermaid
flowchart TD
Start([DepartmentSelect初始化]) --> LoadData["调用useDepartments Hook加载数据"]
LoadData --> CheckLoading{"数据加载中?"}
CheckLoading --> |是| ShowLoading["显示加载状态"]
CheckLoading --> |否| FormatOptions["格式化为Select选项"]
FormatOptions --> Render["渲染Select组件"]
Render --> End([组件渲染完成])
```

**组件源码**
- [DepartmentSelect.tsx](file://frontend/src/components/form/DepartmentSelect.tsx)

### EmployeeSelect员工选择器
EmployeeSelect组件实现了员工选择功能，通过useEmployees Hook获取员工数据。

**组件特性**：
- 支持仅显示活跃员工
- 可显示部门信息
- 支持自定义员工标签格式化
- 内置搜索过滤

```mermaid
flowchart TD
Start([EmployeeSelect初始化]) --> LoadData["调用useEmployees Hook加载数据"]
LoadData --> CheckLoading{"数据加载中?"}
CheckLoading --> |是| ShowLoading["显示加载状态"]
CheckLoading --> |否| FilterData["根据activeOnly过滤员工"]
FilterData --> FormatOptions["格式化为Select选项"]
FormatOptions --> Render["渲染Select组件"]
Render --> End([组件渲染完成])
```

**组件源码**
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx)

## 数据加载与缓存机制

### useAccounts Hook实现
useAccounts Hook负责账户数据的异步加载和缓存管理，采用React Query进行数据获取和状态管理。

**核心功能**：
- 支持多种过滤条件（activeOnly, currency, accountType, search）
- 数据缓存时间配置
- 查询键依赖管理
- 数据选择器（select）处理

```mermaid
sequenceDiagram
participant Component as "表单组件"
participant Hook as "useAccounts"
participant Query as "React Query"
participant API as "后端API"
Component->>Hook : 调用useAccounts(filters)
Hook->>Query : 查询['accounts', filters]
alt 缓存命中
Query-->>Hook : 返回缓存数据
else 缓存未命中
Query->>API : 发起HTTP请求
API-->>Query : 返回账户数据
Query->>Query : 应用select函数处理数据
Query-->>Hook : 返回处理后的数据
end
Hook-->>Component : 返回账户列表和加载状态
```

**Hook源码**
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts)

### useCurrencies Hook实现
useCurrencies Hook负责币种数据的异步加载，支持启用状态过滤。

**核心功能**：
- 支持activeOnly过滤
- 数据缓存管理
- 选项格式化

```mermaid
sequenceDiagram
participant Component as "表单组件"
participant Hook as "useCurrencies"
participant Query as "React Query"
participant API as "后端API"
Component->>Hook : 调用useCurrencies(activeOnly)
Hook->>Query : 查询['currencies', activeOnly]
alt 缓存命中
Query-->>Hook : 返回缓存数据
else 缓存未命中
Query->>API : 发起HTTP请求
API-->>Query : 返回币种数据
Query->>Query : 过滤启用的币种
Query-->>Hook : 返回过滤后的数据
end
Hook-->>Component : 返回币种列表和加载状态
```

**Hook源码**
- [useCurrencies.ts](file://frontend/src/hooks/business/useCurrencies.ts)

### useDepartments Hook实现
useDepartments Hook负责部门数据的加载，提供基础的部门列表查询功能。

**核心功能**：
- 部门列表查询
- 数据缓存（1小时）
- 选项格式化

```mermaid
sequenceDiagram
participant Component as "表单组件"
participant Hook as "useDepartments"
participant Query as "React Query"
participant API as "后端API"
Component->>Hook : 调用useDepartments()
Hook->>Query : 查询['departments']
alt 缓存命中
Query-->>Hook : 返回缓存数据
else 缓存未命中
Query->>API : 发起HTTP请求
API-->>Query : 返回部门数据
Query-->>Hook : 返回处理后的数据
end
Hook-->>Component : 返回部门列表和加载状态
```

**Hook源码**
- [useDepartments.ts](file://frontend/src/hooks/business/useDepartments.ts)

### useEmployees Hook实现
useEmployees Hook负责员工数据的加载，支持多种过滤条件。

**核心功能**：
- 支持状态过滤
- 支持活跃状态过滤
- 支持搜索过滤
- 数据缓存管理

```mermaid
sequenceDiagram
participant Component as "表单组件"
participant Hook as "useEmployees"
participant Query as "React Query"
participant API as "后端API"
Component->>Hook : 调用useEmployees(filter)
Hook->>Query : 查询['employees', filter]
alt 缓存命中
Query-->>Hook : 返回缓存数据
else 缓存未命中
Query->>API : 发起HTTP请求
API-->>Query : 返回员工数据
Query-->>Hook : 返回处理后的数据
end
Hook-->>Component : 返回员工列表和加载状态
```

**Hook源码**
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts)

## 表单验证与UI联动

### zod schema验证机制
系统采用zod作为表单验证库，通过useZodForm Hook实现表单验证与UI的联动。

**验证流程**：
1. 定义zod schema
2. 使用useZodForm创建表单实例
3. 调用validateWithZod进行验证
4. 错误信息自动显示在表单中

```mermaid
flowchart TD
Start([表单提交]) --> Validate["调用validateWithZod"]
Validate --> GetValues["获取表单值"]
GetValues --> ZodValidate["使用Zod验证"]
ZodValidate --> CheckSuccess{"验证成功?"}
CheckSuccess --> |是| ReturnData["返回验证后的数据"]
CheckSuccess --> |否| TransformError["转换Zod错误为Antd Form错误"]
TransformError --> SetFields["调用form.setFields设置错误"]
SetFields --> ThrowError["抛出验证失败异常"]
ReturnData --> End([验证成功])
ThrowError --> End([验证失败])
```

**Hook源码**
- [useZodForm.ts](file://frontend/src/hooks/forms/useZodForm.ts)

### 验证规则示例
#### 薪资发放验证规则
```mermaid
erDiagram
salaryPaymentGenerateSchema {
number year "年份"
number month "月份"
}
salaryPaymentTransferSchema {
string accountId "账户ID"
}
salaryPaymentAllocationSchema {
array allocations "币种分配"
}
salaryPaymentConfirmSchema {
string payment_voucher_path "凭证路径"
}
salaryPaymentGenerateSchema ||--o{ salaryPaymentTransferSchema : "后续操作"
salaryPaymentTransferSchema ||--o{ salaryPaymentAllocationSchema : "后续操作"
salaryPaymentAllocationSchema ||--o{ salaryPaymentConfirmSchema : "后续操作"
```

**验证源码**
- [salary.schema.ts](file://frontend/src/validations/salary.schema.ts)

#### 员工管理验证规则
```mermaid
erDiagram
createEmployeeSchema {
string name "姓名"
string project_id "项目ID"
string orgDepartmentId "部门ID"
string positionId "职位ID"
any joinDate "入职日期"
any regularDate "转正日期"
any birthday "生日"
string personalEmail "个人邮箱"
}
updateEmployeeSchema {
string name "姓名"
any project_id "项目ID"
any orgDepartmentId "部门ID"
any positionId "职位ID"
any joinDate "入职日期"
any regularDate "转正日期"
any birthday "生日"
any email "邮箱"
}
employeeRegularizeSchema {
any regularDate "转正日期"
}
employeeLeaveSchema {
any leaveDate "离职日期"
string leaveType "离职类型"
string leaveReason "离职原因"
}
createEmployeeSchema ||--o{ updateEmployeeSchema : "更新"
updateEmployeeSchema ||--o{ employeeRegularizeSchema : "转正"
updateEmployeeSchema ||--o{ employeeLeaveSchema : "离职"
```

**验证源码**
- [employee.schema.ts](file://frontend/src/validations/employee.schema.ts)

## 实际应用场景

### 员工管理场景
在员工管理页面中，多个表单组件协同工作，实现完整的员工信息管理功能。

```mermaid
flowchart TD
subgraph "员工管理表单"
A[部门选择] --> B[组织部门选择]
B --> C[职位选择]
C --> D[入职日期选择]
D --> E[转正日期选择]
E --> F[联系方式输入]
F --> G[薪资配置]
G --> H[补贴配置]
end
A --> |依赖| B
B --> |依赖| C
C --> |验证| D
D --> |验证| E
E --> |数据| F
F --> |数据| G
G --> |数据| H
```

**应用场景源码**
- [EmployeeForm.tsx](file://frontend/src/features/employees/components/forms/EmployeeForm.tsx)

### 薪资发放场景
在薪资发放页面中，表单组件与验证规则紧密结合，确保薪资发放流程的准确性和安全性。

```mermaid
sequenceDiagram
participant User as "用户"
participant Page as "薪资发放页面"
participant Form as "表单组件"
participant Validation as "验证规则"
User->>Page : 打开薪资发放页面
Page->>Form : 渲染表单组件
Form->>Form : 加载账户、币种数据
User->>Form : 输入薪资发放信息
Form->>Validation : 触发验证
Validation->>Validation : 检查金额、账户等
alt 验证通过
Validation-->>Form : 允许提交
Form->>User : 显示提交按钮
else 验证失败
Validation-->>Form : 返回错误信息
Form->>User : 显示错误提示
end
User->>Form : 提交表单
Form->>Validation : 再次验证
Validation-->>Form : 验证结果
Form->>Page : 处理提交
```

**应用场景源码**
- [SalaryPaymentsPage.tsx](file://frontend/src/features/hr/pages/SalaryPaymentsPage.tsx)

## 结论
本文档详细分析了财务系统中领域专用表单控件的封装原则与工程实践。通过useAccounts、useCurrencies等Hook实现了数据的异步加载和缓存管理，通过zod schema实现了表单验证与UI的联动。这些组件在员工管理、薪资发放等场景中得到了有效应用，提高了开发效率和用户体验。