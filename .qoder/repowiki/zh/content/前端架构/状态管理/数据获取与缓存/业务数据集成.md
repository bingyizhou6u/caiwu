# 业务数据集成

<cite>
**本文档引用的文件**  
- [useBusinessData.ts](file://frontend/src/hooks/useBusinessData.ts)
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts)
- [useFlows.ts](file://frontend/src/hooks/business/useFlows.ts)
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts)
- [useCurrencies.ts](file://frontend/src/hooks/business/useCurrencies.ts)
- [useDepartments.ts](file://frontend/src/hooks/business/useDepartments.ts)
- [useCategories.ts](file://frontend/src/hooks/business/useCategories.ts)
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts)
- [cache.ts](file://frontend/src/config/cache.ts)
- [api.ts](file://frontend/src/config/api.ts)
- [business.ts](file://frontend/src/types/business.ts)
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx)
- [CurrencySelect.tsx](file://frontend/src/components/form/CurrencySelect.tsx)
- [AccountSelect.tsx](file://frontend/src/components/form/AccountSelect.tsx)
- [DepartmentSelect.tsx](file://frontend/src/components/form/DepartmentSelect.tsx)
</cite>

## 目录
1. [引言](#引言)
2. [核心数据获取机制](#核心数据获取机制)
3. [useApiQuery 统一查询接口](#useapiquery-统一查询接口)
4. [主数据查询Hook实现](#主数据查询hook实现)
5. [业务数据查询Hook实现](#业务数据查询hook实现)
6. [数据选择器组件集成](#数据选择器组件集成)
7. [缓存策略与失效机制](#缓存策略与失效机制)
8. [错误处理与加载状态](#错误处理与加载状态)
9. [实际应用场景](#实际应用场景)
10. [总结](#总结)

## 引言

本文档系统阐述了财务系统中业务数据集成的实现机制，重点分析各类业务Hook如何基于`useApiQuery`实现数据获取。文档详细解释了`useEmployees`、`useFlows`等Hook如何定义查询键、配置缓存策略并处理特定业务数据，以及`useBusinessData`如何抽象主数据查询逻辑，为表单选择器等通用组件提供统一的数据访问接口。通过实际代码示例展示员工、财务流水、账户、币种、部门等核心业务数据的获取模式，说明数据选择器（select）的转换逻辑和缓存失效策略。

## 核心数据获取机制

系统采用React Query作为数据获取和状态管理的核心库，通过自定义Hook封装数据获取逻辑，实现数据获取、缓存、错误处理和后台刷新的统一管理。核心机制包括：

- **查询键（Query Key）**：使用数组定义查询键，支持参数化查询，确保不同参数的查询结果独立缓存
- **数据选择（Select）**：通过`select`函数对原始API响应进行转换，提取和格式化所需数据
- **缓存时间（Stale Time）**：根据数据类型配置不同的缓存策略，优化性能和数据新鲜度
- **查询失效（Invalidation）**：在数据变更后自动失效相关查询，触发数据刷新

**Section sources**
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L1-L102)

## useApiQuery 统一查询接口

`useApiQuery`是系统中所有数据获取Hook的基础，封装了React Query的`useQuery`功能，提供统一的数据获取接口。

```mermaid
flowchart TD
A["useApiQuery<T>(key, url, options)"] --> B["queryKey: Array.isArray(key) ? key : [key]"]
A --> C["queryFn: async () => await apiClient.get<T>(url)"]
A --> D["enabled: options?.enabled"]
A --> E["staleTime: options?.staleTime"]
A --> F["select: options?.select"]
A --> G["placeholderData: options?.keepPreviousData ? keepPreviousData : options?.placeholderData"]
A --> H["retry: options?.retry"]
B --> I["React Query useQuery"]
C --> I
D --> I
E --> I
F --> I
G --> I
H --> I
I --> J["返回查询结果: data, isLoading, error, refetch等"]
```

**Diagram sources**
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L11-L41)

**Section sources**
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L1-L102)

## 主数据查询Hook实现

主数据是指变化频率较低的基础数据，如币种、类别、部门等。系统为每种主数据提供了专门的Hook，遵循统一的设计模式。

### 币种数据查询

`useCurrencies` Hook用于获取币种数据，支持按激活状态过滤。

```mermaid
classDiagram
class useCurrencies {
+activeOnly : boolean
+queryKey : ['currencies', activeOnly]
+url : api.currencies + ?activeOnly=true/false
+select : (data) => filter active currencies
+staleTime : CACHE_TIME.MASTER_DATA
}
useCurrencies --> useApiQuery : "extends"
```

**Diagram sources**
- [useCurrencies.ts](file://frontend/src/hooks/business/useCurrencies.ts#L15-L31)
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L11-L41)

**Section sources**
- [useCurrencies.ts](file://frontend/src/hooks/business/useCurrencies.ts#L1-L122)
- [cache.ts](file://frontend/src/config/cache.ts#L7-L8)

### 类别数据查询

`useCategories` Hook用于获取收入和支出类别数据，支持按类别类型过滤。

```mermaid
classDiagram
class useCategories {
+kind : 'income' | 'expense'
+queryKey : ['categories', kind]
+url : api.categories
+select : (data) => filter by kind
+staleTime : CACHE_TIME.MASTER_DATA
}
useCategories --> useApiQuery : "extends"
```

**Diagram sources**
- [useCategories.ts](file://frontend/src/hooks/business/useCategories.ts#L14-L26)
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L11-L41)

**Section sources**
- [useCategories.ts](file://frontend/src/hooks/business/useCategories.ts#L1-L90)
- [cache.ts](file://frontend/src/config/cache.ts#L7-L8)

### 部门数据查询

`useDepartments` Hook用于获取部门数据，提供基础查询和选项格式化功能。

```mermaid
classDiagram
class useDepartments {
+queryKey : ['departments']
+url : api.departments
+select : (data) => map to raw list
+staleTime : 60 * 60 * 1000
}
class useDepartmentOptions {
+includeHQ : boolean
+queryKey : ['departments', 'options', includeHQ]
+select : (data) => map to SelectOption[]
}
useDepartments --> useApiQuery : "extends"
useDepartmentOptions --> useApiQuery : "extends"
```

**Diagram sources**
- [useDepartments.ts](file://frontend/src/hooks/business/useDepartments.ts#L18-L49)
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L11-L41)

**Section sources**
- [useDepartments.ts](file://frontend/src/hooks/business/useDepartments.ts#L1-L97)
- [cache.ts](file://frontend/src/config/cache.ts#L7-L8)

## 业务数据查询Hook实现

业务数据是指变化频率较高的操作数据，如员工、财务流水等。这些Hook通常包含更复杂的查询逻辑和数据处理。

### 员工数据查询

`useEmployees` Hook用于获取员工数据，支持多种过滤条件。

```mermaid
classDiagram
class EmployeeFilter {
+status : string
+activeOnly : boolean
+search : string
}
class useEmployees {
+filter : EmployeeFilter
+params : URLSearchParams
+queryKey : ['employees', filter]
+url : api.employees + ?status=&activeOnly=&search=
+select : (data) => filter active employees
+staleTime : 5 * 60 * 1000
}
useEmployees --> useApiQuery : "extends"
EmployeeFilter --> useEmployees
```

**Diagram sources**
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts#L20-L33)
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L11-L41)

**Section sources**
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts#L1-L212)
- [api.ts](file://frontend/src/config/api.ts#L91-L98)

### 财务流水数据查询

`useFlows` Hook用于获取财务流水数据，支持分页查询和数据预处理。

```mermaid
classDiagram
class useFlows {
+page : number
+pageSize : number
+queryKey : ['flows', page, pageSize]
+url : api.flows + ?page=&pageSize=
+select : (data) => format voucherUrls
+staleTime : CACHE_TIME.TRANSACTION_DATA
+placeholderData : keepPreviousData
}
useFlows --> useApiQuery : "extends"
```

**Diagram sources**
- [useFlows.ts](file://frontend/src/hooks/business/useFlows.ts#L8-L27)
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L11-L41)

**Section sources**
- [useFlows.ts](file://frontend/src/hooks/business/useFlows.ts#L1-L77)
- [cache.ts](file://frontend/src/config/cache.ts#L13-L14)

### 账户数据查询

`useAccounts` Hook用于获取账户数据，支持多种过滤条件和选项格式化。

```mermaid
classDiagram
class useAccounts {
+filters : { activeOnly, currency, accountType, search }
+params : URLSearchParams
+queryKey : ['accounts', filters]
+url : api.accounts + ?active=&currency=&accountType=&search=
+select : (data) => map to Account[]
+staleTime : CACHE_TIME.BUSINESS_DATA
}
class useAccountOptions {
+currency : string
+queryKey : ['accounts', 'options', currency]
+select : (data) => filter by currency and map to SelectOption[]
}
useAccounts --> useApiQuery : "extends"
useAccountOptions --> useApiQuery : "extends"
```

**Diagram sources**
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts#L15-L49)
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L11-L41)

**Section sources**
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts#L1-L129)
- [cache.ts](file://frontend/src/config/cache.ts#L10-L11)

## 数据选择器组件集成

系统提供了一系列数据选择器组件，将业务Hook与UI组件（如Ant Design的Select）集成，简化表单开发。

### 员工选择器

`EmployeeSelect`组件封装了员工选择逻辑，提供统一的UI和数据格式。

```mermaid
sequenceDiagram
participant Component as "EmployeeSelect"
participant Hook as "useEmployees"
participant Query as "React Query"
participant API as "API Client"
Component->>Hook : 调用 useEmployees({ activeOnly, status })
Hook->>Query : 使用 queryKey=['employees', filter]
Query->>API : 发送 GET 请求到 /api/v2/employees
API-->>Query : 返回员工数据
Query-->>Hook : 返回查询结果
Hook->>Component : 返回 data, isLoading
Component->>Component : 格式化选项 (name + department)
Component-->>用户 : 渲染下拉选择器
```

**Diagram sources**
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx#L36-L62)
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts#L20-L33)

**Section sources**
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx#L1-L74)
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts#L20-L33)

### 币种选择器

`CurrencySelect`组件封装了币种选择逻辑，支持代码和名称显示。

```mermaid
sequenceDiagram
participant Component as "CurrencySelect"
participant Hook as "useCurrencies"
participant Query as "React Query"
participant API as "API Client"
Component->>Hook : 调用 useCurrencies()
Hook->>Query : 使用 queryKey=['currencies']
Query->>API : 发送 GET 请求到 /api/v2/currencies
API-->>Query : 返回币种数据
Query-->>Hook : 返回查询结果
Hook->>Component : 返回 data, isLoading
Component->>Component : 格式化选项 (code - name)
Component-->>用户 : 渲染下拉选择器
```

**Diagram sources**
- [CurrencySelect.tsx](file://frontend/src/components/form/CurrencySelect.tsx#L32-L60)
- [useCurrencies.ts](file://frontend/src/hooks/business/useCurrencies.ts#L15-L31)

**Section sources**
- [CurrencySelect.tsx](file://frontend/src/components/form/CurrencySelect.tsx#L1-L81)
- [useCurrencies.ts](file://frontend/src/hooks/business/useCurrencies.ts#L15-L31)

### 账户选择器

`AccountSelect`组件封装了账户选择逻辑，支持币种过滤和选择回调。

```mermaid
sequenceDiagram
participant Component as "AccountSelect"
participant Hook as "useAccounts"
participant Query as "React Query"
participant API as "API Client"
Component->>Hook : 调用 useAccounts()
Hook->>Query : 使用 queryKey=['accounts', filters]
Query->>API : 发送 GET 请求到 /api/v2/accounts
API-->>Query : 返回账户数据
Query-->>Hook : 返回查询结果
Hook->>Component : 返回 data, isLoading
Component->>Component : 过滤账户 (按币种)
Component->>Component : 格式化选项 (name [currency])
Component-->>用户 : 渲染下拉选择器
```

**Diagram sources**
- [AccountSelect.tsx](file://frontend/src/components/form/AccountSelect.tsx#L46-L92)
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts#L15-L49)

**Section sources**
- [AccountSelect.tsx](file://frontend/src/components/form/AccountSelect.tsx#L1-L104)
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts#L15-L49)

### 部门选择器

`DepartmentSelect`组件封装了部门选择逻辑，提供简单的部门选择功能。

```mermaid
sequenceDiagram
participant Component as "DepartmentSelect"
participant Hook as "useDepartments"
participant Query as "React Query"
participant API as "API Client"
Component->>Hook : 调用 useDepartments()
Hook->>Query : 使用 queryKey=['departments']
Query->>API : 发送 GET 请求到 /api/v2/departments
API-->>Query : 返回部门数据
Query-->>Hook : 返回查询结果
Hook->>Component : 返回 data, isLoading
Component->>Component : 格式化选项 (name)
Component-->>用户 : 渲染下拉选择器
```

**Diagram sources**
- [DepartmentSelect.tsx](file://frontend/src/components/form/DepartmentSelect.tsx#L29-L53)
- [useDepartments.ts](file://frontend/src/hooks/business/useDepartments.ts#L18-L30)

**Section sources**
- [DepartmentSelect.tsx](file://frontend/src/components/form/DepartmentSelect.tsx#L1-L64)
- [useDepartments.ts](file://frontend/src/hooks/business/useDepartments.ts#L18-L30)

## 缓存策略与失效机制

系统采用分层缓存策略，根据数据类型和变化频率配置不同的缓存时间。

### 缓存时间配置

```mermaid
graph TD
A["缓存时间配置"] --> B["主数据: 1小时"]
A --> C["业务数据: 30分钟"]
A --> D["交易数据: 5分钟"]
A --> E["报表数据: 10分钟"]
A --> F["实时数据: 0"]
B --> G["币种、类别、部门等"]
C --> H["员工、账户、供应商等"]
D --> I["流水、单据、审批等"]
E --> J["各类报表"]
F --> K["状态检查、实时监控等"]
```

**Diagram sources**
- [cache.ts](file://frontend/src/config/cache.ts#L5-L20)

**Section sources**
- [cache.ts](file://frontend/src/config/cache.ts#L1-L21)

### 查询失效机制

当数据发生变更时，系统通过`useMutation`的`onSuccess`回调自动失效相关查询。

```mermaid
sequenceDiagram
participant Component as "UI组件"
participant Mutation as "useMutation"
participant QueryClient as "QueryClient"
participant API as "API Client"
Component->>Mutation : 触发变更操作
Mutation->>API : 发送 POST/PUT/DELETE 请求
API-->>Mutation : 返回操作结果
Mutation->>QueryClient : 调用 invalidateQueries
QueryClient->>QueryClient : 失效相关查询 (如 ['employees'])
QueryClient->>Query : 触发数据刷新
Query->>API : 重新获取数据
API-->>Query : 返回最新数据
Query-->>Component : 更新UI
```

**Diagram sources**
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts#L37-L45)
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts#L81-L88)

**Section sources**
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts#L36-L47)
- [useAccounts.ts](file://frontend/src/hooks/business/useAccounts.ts#L80-L91)

## 错误处理与加载状态

系统通过React Query的内置机制处理错误和加载状态，提供一致的用户体验。

### 查询状态管理

```mermaid
stateDiagram-v2
[*] --> Idle
Idle --> Loading : "开始查询"
Loading --> Success : "查询成功"
Loading --> Error : "查询失败"
Success --> Loading : "重新查询"
Error --> Loading : "重试查询"
Loading --> Success : "重试成功"
Loading --> Error : "重试失败"
state Success {
[*] --> DataAvailable
DataAvailable --> [*]
}
state Error {
[*] --> ErrorState
ErrorState --> [*]
}
state Loading {
[*] --> Fetching
Fetching --> [*]
}
```

**Diagram sources**
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L26-L40)

**Section sources**
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L1-L102)

### 错误处理策略

系统在`useApiQuery`中配置了重试机制，并在组件中通过`error`状态显示错误信息。

```mermaid
flowchart TD
A["发起API请求"] --> B{"请求成功?"}
B --> |是| C["返回数据"]
B --> |否| D["记录错误"]
D --> E{"是否需要重试?"}
E --> |是| F["等待重试间隔"]
F --> A
E --> |否| G["返回错误状态"]
G --> H["UI显示错误信息"]
```

**Diagram sources**
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L39-L40)

**Section sources**
- [useApiQuery.ts](file://frontend/src/utils/useApiQuery.ts#L1-L102)

## 实际应用场景

### 员工管理页面

在员工管理页面中，`useEmployees` Hook用于获取员工列表，支持搜索和状态过滤。

```mermaid
flowchart TD
A["员工管理页面"] --> B["使用 useEmployees Hook"]
B --> C["查询参数: status, activeOnly, search"]
C --> D["查询键: ['employees', filter]"]
D --> E["API: /api/v2/employees"]
E --> F["数据转换: 过滤离职员工"]
F --> G["返回员工列表"]
G --> H["渲染员工表格"]
```

**Section sources**
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts#L20-L33)

### 财务流水页面

在财务流水页面中，`useFlows` Hook用于获取分页的流水数据，支持后台刷新。

```mermaid
flowchart TD
A["财务流水页面"] --> B["使用 useFlows Hook"]
B --> C["分页参数: page, pageSize"]
C --> D["查询键: ['flows', page, pageSize]"]
D --> E["API: /api/v2/flows"]
E --> F["数据转换: 格式化凭证URL"]
F --> G["返回分页数据"]
G --> H["渲染流水表格"]
```

**Section sources**
- [useFlows.ts](file://frontend/src/hooks/business/useFlows.ts#L8-L27)

### 表单创建场景

在表单创建场景中，各种选择器组件用于选择关联数据。

```mermaid
flowchart TD
A["创建财务流水表单"] --> B["使用 AccountSelect"]
A --> C["使用 CategorySelect"]
A --> D["使用 EmployeeSelect"]
A --> E["使用 CurrencySelect"]
B --> F["获取账户列表"]
C --> G["获取类别列表"]
D --> H["获取员工列表"]
E --> I["获取币种列表"]
F --> J["渲染账户下拉"]
G --> K["渲染类别下拉"]
H --> L["渲染员工下拉"]
I --> M["渲染币种下拉"]
```

**Section sources**
- [AccountSelect.tsx](file://frontend/src/components/form/AccountSelect.tsx#L46-L92)
- [EmployeeSelect.tsx](file://frontend/src/components/form/EmployeeSelect.tsx#L36-L62)
- [CurrencySelect.tsx](file://frontend/src/components/form/CurrencySelect.tsx#L32-L60)

## 总结

本系统通过`useApiQuery`统一的数据获取接口，实现了业务数据的高效集成。核心要点包括：

1. **分层缓存策略**：根据数据类型配置不同的缓存时间，平衡性能和数据新鲜度
2. **参数化查询**：使用数组作为查询键，支持复杂的查询参数
3. **数据转换**：通过`select`函数对原始数据进行格式化，满足UI需求
4. **自动刷新**：通过查询失效机制，在数据变更后自动刷新相关数据
5. **组件集成**：将数据获取逻辑与UI组件封装，提供易用的开发接口

这种架构设计使得业务数据获取变得简单、一致和可靠，为系统的可维护性和扩展性提供了坚实基础。