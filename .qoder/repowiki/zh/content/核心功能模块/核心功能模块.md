# 核心功能模块

<cite>
**本文档引用的文件**   
- [index.ts](file://backend/src/index.ts)
- [schema.ts](file://backend/src/db/schema.ts)
- [accounts.ts](file://backend/src/routes/v2/master-data/accounts.ts)
- [employees.ts](file://backend/src/routes/v2/employees.ts)
- [fixed-assets.ts](file://backend/src/routes/v2/fixed-assets.ts)
- [rental.ts](file://backend/src/routes/v2/rental.ts)
- [reports.ts](file://backend/src/routes/v2/reports.ts)
- [FinanceService.ts](file://backend/src/services/FinanceService.ts)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts)
- [FixedAssetService.ts](file://backend/src/services/FixedAssetService.ts)
- [RentalService.ts](file://backend/src/services/RentalService.ts)
- [ReportService.ts](file://backend/src/services/ReportService.ts)
- [SystemConfigService.ts](file://backend/src/services/SystemConfigService.ts)
- [main.tsx](file://frontend/src/main.tsx)
</cite>

## 目录
1. [财务管理](#财务管理)
2. [人事管理](#人事管理)
3. [固定资产管理](#固定资产管理)
4. [租赁管理](#租赁管理)
5. [报表系统](#报表系统)
6. [系统设置](#系统设置)

## 财务管理

财务管理模块是系统的核心，负责处理所有与资金流动相关的业务，包括账户管理、流水记录、转账、应收应付（AR/AP）以及借款管理。

### 业务目标
实现企业资金的精细化管理，确保每一笔收支都有据可查，提供准确的财务数据支持决策。

### 关键实体模型
- **账户 (accounts)**: 存储银行账户、现金账户等信息，包含账户名、类型、币种、期初余额等。
- **流水 (cash_flows)**: 记录每一笔收入或支出的详细信息，如业务日期、金额、交易类型、关联账户、分类、凭证等。
- **应收应付 (ar_ap_docs)**: 管理与客户（AR）和供应商（AP）的往来账款，记录发票、账期、金额和结算状态。
- **转账 (account_transfers)**: 记录不同账户之间的资金划转，包含转出/转入账户、金额、汇率和手续费。

### 主要操作流程
1.  **创建流水**: 用户在前端“流水管理”页面填写业务信息（如日期、金额、账户、分类等），提交后调用后端 `/api/v2/flows` 接口。
2.  **后端处理**: `FinanceService` 服务处理请求，通过乐观锁机制（`accounts` 表的 `version` 字段）确保账户余额计算的并发安全。系统会自动计算交易前后的余额，并生成凭证号。
3.  **红冲操作**: 对于错误的流水，支持“红冲”功能。该功能会生成一笔方向相反的流水记录，并在原始流水上标记已被冲正，确保财务数据的可追溯性。
4.  **应收应付管理**: 用户在“应收应付”页面创建账单，系统会跟踪其结算状态（未结清、部分结算、已结清）。当收到付款或支付款项时，通过“结算”功能关联流水，更新账单状态。

### 前后端协作方式
- **前端**: 使用 `useFlows.ts` 和 `useAR.ts`/`useAP.ts` 等自定义 Hook 与后端 API 交互，获取数据并更新状态。页面组件 `FlowsPage.tsx` 和 `ARPage.tsx`/`APPage.tsx` 负责渲染和用户交互。
- **后端**: 路由 `flows.ts` 和 `ar-ap.ts` 处理 HTTP 请求，调用 `FinanceService` 进行业务逻辑处理和数据库操作。服务层确保数据一致性和业务规则。

**Section sources**
- [index.ts](file://backend/src/index.ts#L27-L30)
- [schema.ts](file://backend/src/db/schema.ts#L139-L188)
- [FinanceService.ts](file://backend/src/services/FinanceService.ts#L20-L442)
- [flows.ts](file://backend/src/routes/v2/flows.ts)
- [ar-ap.ts](file://backend/src/routes/v2/ar-ap.ts)
- [FlowsPage.tsx](file://frontend/src/features/finance/pages/FlowsPage.tsx)
- [ARPage.tsx](file://frontend/src/features/finance/pages/ARPage.tsx)
- [APPage.tsx](file://frontend/src/features/finance/pages/APPage.tsx)
- [useFlows.ts](file://frontend/src/hooks/business/useFlows.ts)
- [useAR.ts](file://frontend/src/hooks/business/useAR.ts)
- [useAP.ts](file://frontend/src/hooks/business/useAP.ts)

## 人事管理

人事管理模块覆盖了员工从入职到离职的全生命周期管理，包括员工信息维护、薪资计算、请假审批等核心功能。

### 业务目标
实现人力资源的数字化管理，规范员工入职、转正、请假、离职等流程，自动化薪资计算，提升HR工作效率。

### 关键实体模型
- **员工 (employees)**: 存储员工的个人信息、职位、部门、入职日期、状态（试用、正式、离职）等。
- **职位 (positions)**: 定义组织内的职位，包含职级、职能角色和权限配置。
- **请假 (employee_leaves)**: 记录员工的请假申请，包括类型、起止日期、天数、状态（待审批、已批准、已拒绝）。
- **薪资 (employee_salaries)**: 存储员工的基础薪资信息，按试用期和正式期分别设置。

### 主要操作流程
1.  **员工入职**: HR 在“员工管理”页面创建新员工。系统会自动生成公司邮箱，并创建用户账号（需激活）。同时，会创建一条“试用”状态的员工记录。
2.  **员工转正**: 当员工试用期满，HR 在员工详情页执行“转正”操作。系统会更新员工状态为“正式”，并记录转正日期。
3.  **请假审批**: 员工在“我的请假”页面提交请假申请。申请会进入审批流，上级或HR在“请假管理”页面进行审批，审批结果会更新 `employee_leaves` 表的状态。
4.  **薪资计算**: 系统根据员工的 `employee_salaries` 记录、出勤天数、请假天数等信息，自动计算每月应发工资。计算结果存储在 `salary_payments` 表中，等待财务发放。

### 前后端协作方式
- **前端**: 页面组件 `EmployeeManagementPage.tsx` 和 `MyLeavesPage.tsx` 提供操作界面。`useEmployees.ts` Hook 负责获取员工列表，`useLeaves.ts` Hook 负责请假相关的数据交互。
- **后端**: `employees.ts` 路由处理员工的增删改查和状态变更（如转正、离职）。`employee-leaves.ts` 路由处理请假申请。`EmployeeService` 服务是核心，负责业务逻辑和数据持久化。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L14-L48)
- [employees.ts](file://backend/src/routes/v2/employees.ts#L20-L601)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L11-L757)
- [EmployeeManagementPage.tsx](file://frontend/src/features/hr/pages/EmployeeManagementPage.tsx)
- [MyLeavesPage.tsx](file://frontend/src/features/my/pages/MyLeavesPage.tsx)
- [useEmployees.ts](file://frontend/src/hooks/business/useEmployees.ts)
- [useLeaves.ts](file://frontend/src/hooks/business/useLeaves.ts)

## 固定资产管理

固定资产管理模块用于跟踪企业固定资产的增减变动、折旧计算和资产调拨。

### 业务目标
实现固定资产的全生命周期管理，确保资产信息准确，自动化折旧计算，支持资产的采购、转移、报废和变卖。

### 关键实体模型
- **固定资产 (fixed_assets)**: 记录资产的核心信息，如资产编码、名称、类别、购入日期、原值、当前价值、使用状态、所属部门和保管人。
- **折旧记录 (fixed_asset_depreciations)**: 存储每次计提折旧的详细信息，包括折旧日期、金额、累计折旧和剩余价值。
- **资产变更 (fixed_asset_changes)**: 记录资产状态的每一次变更，如状态变更、部门转移、调拨、采购和变卖。

### 主要操作流程
1.  **资产采购**: 在“固定资产采购”页面录入资产信息。系统会同时创建 `fixed_assets` 记录，并生成一笔对应的“支出”流水，实现财务与资产的联动。
2.  **计提折旧**: 在“固定资产”列表页选择资产，点击“计提折旧”按钮。系统会根据预设的折旧方法和使用年限，计算当期折旧额，并创建 `fixed_asset_depreciations` 记录，同时更新资产的当前价值。
3.  **资产转移**: 在资产详情页执行“转移”操作。系统会更新资产的部门、站点或保管人信息，并在 `fixed_asset_changes` 表中记录变更详情。
4.  **资产变卖**: 在资产详情页执行“变卖”操作。系统会更新资产状态为“已出售”，并生成一笔“收入”流水，记录变卖所得。

### 前后端协作方式
- **前端**: `FixedAssetPurchasePage.tsx` 和 `FixedAssetsManagementPage.tsx` 页面提供操作入口。`useFixedAssets.ts` Hook 用于获取资产数据。
- **后端**: `fixed-assets.ts` 路由处理所有固定资产相关的API请求。`FixedAssetService` 服务负责核心业务逻辑，`FixedAssetDepreciationService` 和 `FixedAssetChangeService` 处理折旧和变更的特定逻辑。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L506-L574)
- [fixed-assets.ts](file://backend/src/routes/v2/fixed-assets.ts#L30-L800)
- [FixedAssetService.ts](file://backend/src/services/FixedAssetService.ts#L22-L607)
- [FixedAssetPurchasePage.tsx](file://frontend/src/features/assets/pages/FixedAssetPurchasePage.tsx)
- [FixedAssetsManagementPage.tsx](file://frontend/src/features/assets/pages/FixedAssetsManagementPage.tsx)
- [useFixedAssets.ts](file://frontend/src/hooks/business/useFixedAssets.ts)

## 租赁管理

租赁管理模块专注于管理公司的租赁物业，包括办公室、宿舍等，处理租金支付和宿舍分配。

### 业务目标
集中管理所有租赁合同和租金支付，自动化生成应付账单，跟踪宿舍分配情况。

### 关键实体模型
- **租赁物业 (rental_properties)**: 记录物业的基本信息，如物业编码、名称、类型（办公室、宿舍）、地址、租金、房东信息和租赁合同。
- **租金支付 (rental_payments)**: 记录每次租金支付的详细信息，包括支付日期、金额、关联的账户和流水。
- **宿舍分配 (dormitory_allocations)**: 记录员工宿舍的分配情况，包括员工、房间号、床位号和分配日期。

### 主要操作流程
1.  **创建物业**: 在“租赁管理”页面添加新的租赁物业信息。
2.  **生成应付账单**: 系统提供“生成应付账单”功能，会根据所有租赁物业的租金信息，为指定月份批量生成 `rental_payable_bills` 记录。
3.  **支付租金**: 当实际支付租金时，在“租赁付款”页面创建支付记录。系统会自动创建一笔“支出”流水，并将对应的应付账单状态标记为“已支付”。
4.  **宿舍分配**: 在宿舍物业的详情页，可以为员工分配宿舍。系统会创建 `dormitory_allocations` 记录。

### 前后端协作方式
- **前端**: `RentalManagementPage.tsx` 是主要操作页面。`useRentalPayments.ts` 和 `useRentalProperties.ts` Hook 用于数据交互。
- **后端**: `rental.ts` 路由是入口，它采用门面模式（Facade Pattern），将请求委托给 `RentalPropertyService`、`RentalPaymentService` 和 `DormitoryAllocationService` 三个具体的服务类进行处理。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L576-L673)
- [rental.ts](file://backend/src/routes/v2/rental.ts#L22-L851)
- [RentalService.ts](file://backend/src/services/RentalService.ts#L12-L161)
- [RentalManagementPage.tsx](file://frontend/src/features/assets/pages/RentalManagementPage.tsx)
- [useRentalPayments.ts](file://frontend/src/hooks/business/useRentalPayments.ts)
- [useRentalProperties.ts](file://frontend/src/hooks/business/useRentalProperties.ts)

## 报表系统

报表系统模块提供多维度的统计分析功能，帮助管理层了解财务状况和业务运营情况。

### 业务目标
将分散的业务数据整合为直观的统计报表，支持决策分析。

### 主要报表
- **财务类报表**: 
  - 项目现金流报表 (`/api/v2/reports/department-cash`)
  - AR/AP汇总与明细报表 (`/api/v2/reports/ar-summary`, `/api/v2/reports/ap-detail`)
  - 费用汇总与明细报表 (`/api/v2/reports/expense-summary`)
  - 账户余额报表 (`/api/v2/reports/account-balance`)
- **人事类报表**: 
  - 员工薪资报表 (`/api/v2/reports/employee-salary`)
  - 年假报表 (`/api/v2/reports/annual-leave`)
- **业务类报表**: 
  - 站点增长报表 (`/api/v2/reports/site-growth`)
  - 借款汇总报表 (`/api/v2/reports/borrowing-summary`)

### 前后端协作方式
- **前端**: 各类报表页面（如 `ReportARDetailPage.tsx`）通过 `useReports.ts` Hook 调用后端API获取数据，并使用图表库进行可视化展示。
- **后端**: `reports.ts` 路由处理所有报表请求。`ReportService` 作为门面服务，将请求分发给 `DashboardReportService`、`FinancialReportService` 和 `BusinessReportService` 等具体服务进行数据查询和计算。

**Section sources**
- [reports.ts](file://backend/src/routes/v2/reports.ts#L17-L833)
- [ReportService.ts](file://backend/src/services/ReportService.ts#L13-L84)
- [ReportARDetailPage.tsx](file://frontend/src/features/reports/pages/ReportARDetailPage.tsx)
- [useReports.ts](file://frontend/src/hooks/business/useReports.ts)

## 系统设置

系统设置模块负责管理系统的主数据和全局配置。

### 业务目标
提供一个集中的地方来配置和管理系统的基础数据和运行参数。

### 主数据配置
- **主数据管理**: 包括账户、分类、部门、职位、供应商、币种等基础数据的增删改查。这些数据在其他模块中被广泛引用。
- **权限管理**: 通过 `position-permissions.ts` 路由和 `PositionService` 服务，为不同职位配置细粒度的访问权限。
- **IP白名单**: 通过 `ip-whitelist.ts` 路由和 `IPWhitelistService` 服务，配置允许访问系统的IP地址范围。
- **系统参数**: 通过 `system-config.ts` 路由和 `SystemConfigService` 服务，读取和修改存储在 `system_config` 表中的键值对配置。

### 前后端协作方式
- **前端**: 各类管理页面（如 `AccountManagementPage.tsx`、`DepartmentManagementPage.tsx`）提供配置界面。
- **后端**: `master-data` 目录下的各个路由文件（如 `accounts.ts`、`departments.ts`）处理主数据请求。`SystemConfigService` 专门处理系统配置的读写。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L3-L9)
- [system-config.ts](file://backend/src/routes/v2/system-config.ts)
- [SystemConfigService.ts](file://backend/src/services/SystemConfigService.ts#L6-L60)
- [AccountManagementPage.tsx](file://frontend/src/features/system/pages/AccountManagementPage.tsx)
- [DepartmentManagementPage.tsx](file://frontend/src/features/system/pages/DepartmentManagementPage.tsx)