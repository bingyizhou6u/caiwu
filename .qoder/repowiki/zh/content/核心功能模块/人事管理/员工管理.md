# 员工管理

<cite>
**本文档引用文件**   
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts)
- [employees.ts](file://backend/src/routes/v2/employees.ts)
- [EmployeeManagementPage.tsx](file://frontend/src/features/hr/pages/EmployeeManagementPage.tsx)
- [EmployeeForm.tsx](file://frontend/src/features/employees/components/forms/EmployeeForm.tsx)
- [EmployeeFormModal.tsx](file://frontend/src/features/employees/components/modals/EmployeeFormModal.tsx)
- [schema.ts](file://backend/src/db/schema.ts)
- [EmailRoutingService.ts](file://backend/src/services/EmailRoutingService.ts)
- [EmailService.ts](file://backend/src/services/EmailService.ts)
- [employee.schema.ts](file://backend/src/schemas/employee.schema.ts)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [员工全生命周期管理](#员工全生命周期管理)
4. [员工状态机](#员工状态机)
5. [组织架构关联](#组织架构关联)
6. [前端操作流程](#前端操作流程)
7. [高级功能实现](#高级功能实现)
8. [常见问题解决方案](#常见问题解决方案)

## 简介
本系统提供完整的员工管理模块，涵盖员工从创建、转正、离职到复职的全生命周期管理。系统通过EmployeeService服务类实现核心业务逻辑，结合Cloudflare邮件路由服务实现企业邮箱自动配置，并通过前端组件提供直观的操作界面。员工状态采用状态机模式进行管理，确保状态转换的合法性。

## 核心组件

### EmployeeService
作为员工管理的核心服务类，EmployeeService负责处理所有员工相关的业务逻辑，包括创建、更新、状态变更等操作。该服务与数据库直接交互，并集成邮件服务以实现账号激活功能。

**Section sources**
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L11-L758)

### 员工数据模型
员工数据模型包含基本信息、组织架构信息和认证信息，统一存储在employees表中。该设计简化了用户与员工的关联管理。

```mermaid
erDiagram
EMPLOYEES {
string id PK
string email UK
string personal_email
string name
string position_id FK
string org_department_id FK
string department_id FK
string join_date
string status
integer active
string phone
string usdt_address
string emergency_contact
string emergency_phone
string address
string memo
string birthday
string regular_date
text work_schedule
integer annual_leave_cycle_months
integer annual_leave_days
integer created_at
integer updated_at
string password_hash
integer must_change_password
integer password_changed
string totp_secret
integer last_login_at
string activation_token
integer activation_expires_at
string reset_token
integer reset_expires_at
}
POSITIONS {
string id PK
string code UK
string name
integer level
string function_role
integer can_manage_subordinates
text permissions
integer active
}
DEPARTMENTS {
string id PK
string name
string code
integer active
}
ORG_DEPARTMENTS {
string id PK
string project_id FK
string parent_id
string name
string code
integer active
}
EMPLOYEES ||--o{ POSITIONS : "拥有"
EMPLOYEES ||--o{ DEPARTMENTS : "属于"
EMPLOYEES ||--o{ ORG_DEPARTMENTS : "组织部门"
```

**Diagram sources**
- [schema.ts](file://backend/src/db/schema.ts#L14-L48)
- [schema.ts](file://backend/src/db/schema.ts#L50-L63)
- [schema.ts](file://backend/src/db/schema.ts#L65-L74)
- [schema.ts](file://backend/src/db/schema.ts#L95-L109)

## 员工全生命周期管理

### 创建员工
创建员工是员工生命周期的起点，系统会自动完成以下操作：
1. 生成企业邮箱地址
2. 创建员工记录
3. 配置邮件路由规则
4. 生成账号激活令牌

```mermaid
sequenceDiagram
participant HR as HR人员
participant Frontend as 前端界面
participant Backend as 后端服务
participant Cloudflare as Cloudflare
HR->>Frontend : 填写员工信息并提交
Frontend->>Backend : 发送创建请求
Backend->>Backend : 检查邮箱冲突
Backend->>Backend : 生成企业邮箱
Backend->>Cloudflare : 创建邮件路由规则
Cloudflare-->>Backend : 返回创建结果
Backend->>Backend : 创建员工记录
Backend->>Backend : 生成激活令牌
Backend-->>Frontend : 返回创建结果
Frontend-->>HR : 显示创建成功
```

**Diagram sources**
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L20-L233)
- [employees.ts](file://backend/src/routes/v2/employees.ts#L184-L241)

### 转正员工
员工试用期结束后，HR可执行转正操作，将员工状态从"试用"变更为"正式"。

```mermaid
sequenceDiagram
participant HR as HR人员
participant Frontend as 前端界面
participant Backend as 后端服务
HR->>Frontend : 发起转正操作
Frontend->>Backend : 发送转正请求
Backend->>Backend : 验证员工存在
Backend->>Backend : 更新员工状态为"正式"
Backend->>Backend : 记录转正日期
Backend-->>Frontend : 返回操作结果
Frontend-->>HR : 显示转正成功
```

**Diagram sources**
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L485-L502)
- [employees.ts](file://backend/src/routes/v2/employees.ts#L428-L440)

### 离职员工
当员工离职时，系统会更新其状态并禁用账号登录权限。

```mermaid
sequenceDiagram
participant HR as HR人员
participant Frontend as 前端界面
participant Backend as 后端服务
HR->>Frontend : 发起离职操作
Frontend->>Backend : 发送离职请求
Backend->>Backend : 验证员工存在
Backend->>Backend : 更新员工状态为"离职"
Backend->>Backend : 设置账号为禁用状态
Backend->>Backend : 记录离职原因
Backend-->>Frontend : 返回操作结果
Frontend-->>HR : 显示离职成功
```

**Diagram sources**
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L504-L535)
- [employees.ts](file://backend/src/routes/v2/employees.ts#L471-L483)

### 复职员工
已离职员工重新入职时，可执行复职操作，恢复其账号并更新入职日期。

```mermaid
sequenceDiagram
participant HR as HR人员
participant Frontend as 前端界面
participant Backend as 后端服务
HR->>Frontend : 发起复职操作
Frontend->>Backend : 发送复职请求
Backend->>Backend : 验证员工存在
Backend->>Backend : 更新员工状态为"试用"
Backend->>Backend : 启用账号登录权限
Backend->>Backend : 更新入职日期
Backend-->>Frontend : 返回操作结果
Frontend-->>HR : 显示复职成功
```

**Diagram sources**
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L537-L564)
- [employees.ts](file://backend/src/routes/v2/employees.ts#L514-L526)

## 员工状态机

### 状态定义
系统定义了三种主要员工状态：
- **试用** (probation): 新员工入职后的初始状态
- **正式** (regular): 试用期结束后的正式员工状态
- **离职** (resigned): 员工离职后的状态

### 状态转换规则
员工状态遵循严格的转换规则，确保业务流程的正确性。

```mermaid
stateDiagram-v2
[*] --> probation
probation --> regular : 转正
probation --> resigned : 离职
regular --> resigned : 离职
resigned --> probation : 复职
```

**Diagram sources**
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L160-L161)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L494-L495)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L513-L514)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L546-L547)

## 组织架构关联

### 部门与职位管理
员工与部门、职位之间存在明确的关联关系，支持灵活的组织架构管理。

```mermaid
classDiagram
class Employee {
+string id
+string name
+string email
+string personalEmail
+string joinDate
+string status
+integer active
+string departmentId
+string orgDepartmentId
+string positionId
}
class Department {
+string id
+string name
+string code
+integer active
}
class OrgDepartment {
+string id
+string projectId
+string parentId
+string name
+string code
+integer active
}
class Position {
+string id
+string code
+string name
+integer level
+string functionRole
+integer canManageSubordinates
+text permissions
+integer active
}
Employee --> Department : "属于"
Employee --> OrgDepartment : "组织部门"
Employee --> Position : "担任"
```

**Diagram sources**
- [schema.ts](file://backend/src/db/schema.ts#L14-L48)
- [schema.ts](file://backend/src/db/schema.ts#L50-L63)
- [schema.ts](file://backend/src/db/schema.ts#L65-L74)
- [schema.ts](file://backend/src/db/schema.ts#L95-L109)

## 前端操作流程

### 员工管理界面
HR人员通过员工管理界面进行员工信息维护，界面提供完整的操作功能。

```mermaid
flowchart TD
A[员工管理界面] --> B[员工列表]
B --> C[筛选员工]
C --> D[查看员工详情]
B --> E[新建员工]
B --> F[编辑员工]
B --> G[账号管理]
G --> H[发送激活邮件]
G --> I[重置密码]
G --> J[重置2FA]
D --> K[转正操作]
D --> L[离职操作]
D --> M[复职操作]
```

**Diagram sources**
- [EmployeeManagementPage.tsx](file://frontend/src/features/hr/pages/EmployeeManagementPage.tsx#L1-L367)

### 员工信息表单
员工信息表单采用多标签页设计，分类展示员工信息。

```mermaid
flowchart TD
A[员工信息表单] --> B[基本信息]
B --> C[姓名]
B --> D[邮箱]
B --> E[部门]
B --> F[职位]
B --> G[入职日期]
A --> H[联系方式]
H --> I[手机号]
H --> J[住址]
H --> K[紧急联系人]
H --> L[USDT地址]
```

**Diagram sources**
- [EmployeeForm.tsx](file://frontend/src/features/employees/components/forms/EmployeeForm.tsx#L1-L315)

## 高级功能实现

### 邮箱自动生成
系统根据员工姓名自动生成企业邮箱地址，避免重复。

```mermaid
flowchart TD
A[输入员工姓名] --> B[转换为邮箱前缀]
B --> C[检查邮箱冲突]
C --> |无冲突| D[使用基础邮箱]
C --> |有冲突| E[添加序号后缀]
E --> F[生成最终邮箱]
D --> G[返回邮箱地址]
F --> G
```

**Diagram sources**
- [EmailRoutingService.ts](file://backend/src/services/EmailRoutingService.ts#L39-L55)

### Cloudflare邮件路由集成
系统与Cloudflare邮件路由服务集成，实现邮件自动转发。

```mermaid
sequenceDiagram
participant System as 系统
participant Cloudflare as Cloudflare API
System->>Cloudflare : 创建邮件路由规则
Cloudflare->>Cloudflare : 验证目标邮箱
Cloudflare-->>System : 返回创建结果
alt 创建成功
System->>System : 记录路由创建状态
else 创建失败
System->>System : 记录错误日志
end
```

**Diagram sources**
- [EmailRoutingService.ts](file://backend/src/services/EmailRoutingService.ts#L119-L168)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L172-L183)

### 账号激活流程
新员工通过激活邮件设置初始密码，完成账号激活。

```mermaid
sequenceDiagram
participant HR as HR人员
participant System as 系统
participant Employee as 员工
participant Email as 邮件系统
HR->>System : 创建员工
System->>System : 生成激活令牌
System->>Email : 发送激活邮件
Email-->>Employee : 接收邮件
Employee->>System : 点击激活链接
System->>System : 验证令牌有效性
alt 令牌有效
System-->>Employee : 显示密码设置页面
Employee->>System : 设置新密码
System->>System : 激活账号
System-->>Employee : 显示激活成功
else 令牌过期
System-->>Employee : 显示令牌过期
end
```

**Diagram sources**
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L186-L202)
- [EmailService.ts](file://backend/src/services/EmailService.ts#L197-L247)

## 常见问题解决方案

### 邮箱冲突
当系统检测到邮箱地址冲突时，会自动生成带序号的邮箱地址。

**解决方案**:
1. 系统自动检测现有邮箱
2. 生成基础邮箱前缀
3. 检查冲突并添加序号
4. 返回唯一邮箱地址

**Section sources**
- [EmailRoutingService.ts](file://backend/src/services/EmailRoutingService.ts#L46-L52)

### 状态变更失败
状态变更失败通常由权限不足或状态转换不合法引起。

**解决方案**:
1. 检查操作者权限
2. 验证当前状态是否允许目标状态转换
3. 记录错误日志
4. 返回明确的错误信息

**Section sources**
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L486-L489)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L491-L499)