# 部署流程

<cite>
**本文档中引用的文件**  
- [wrangler.toml](file://backend/wrangler.toml)
- [email-worker/wrangler.toml](file://email-worker/wrangler.toml)
- [vite.config.ts](file://frontend/vite.config.ts)
- [functions/api/[[path]].ts](file://frontend/functions/api/[[path]].ts)
- [package.json](file://frontend/package.json)
</cite>

## 目录
1. [后端服务部署](#后端服务部署)
2. [前端构建流程](#前端构建流程)
3. [Cloudflare Pages 部署机制](#cloudflare-pages-部署机制)
4. [CI/CD 执行脚本示例](#cicd-执行脚本示例)

## 后端服务部署

caiwu-main项目的后端服务基于Cloudflare Workers平台构建，其核心配置由`backend/wrangler.toml`文件定义。该文件详细声明了Workers运行时所需的各种绑定资源，包括D1数据库、R2存储桶和KV命名空间。

在`wrangler.toml`中，通过`[[d1_databases]]`字段将名为`DB`的绑定与`caiwu-db`数据库实例关联，为应用提供结构化数据存储能力。同时，`[[r2_buckets]]`配置将`VOUCHERS`绑定至`caiwu-vouchers`存储桶，用于存放凭证等非结构化文件。会话管理则依赖于`[[kv_namespaces]]`，其中`SESSIONS_KV`绑定指向一个特定的KV命名空间ID，实现高效的状态存储。

此外，系统通过`[[services]]`字段集成了独立的邮件服务。`EMAIL_SERVICE`绑定指向名为`caiwu-email`的另一个Worker服务（即`email-worker`），实现了服务间的解耦与通信。邮件服务自身也在其`wrangler.toml`中通过`[[send_email]]`绑定了Cloudflare的内置邮件发送功能。

部署时，开发者需使用`wrangler deploy`命令将后端代码推送至Cloudflare Workers。在此过程中，必须确保所有环境变量（如`DB`、`SESSIONS_KV`）和密钥（如`AUTH_JWT_SECRET`）已通过`wrangler secret put`命令正确注入生产环境，以保证服务的安全性和正常运行。

**Section sources**
- [wrangler.toml](file://backend/wrangler.toml#L1-L45)
- [email-worker/wrangler.toml](file://email-worker/wrangler.toml#L1-L18)

## 前端构建流程

前端项目位于`frontend/`目录下，采用Vite作为构建工具，其构建行为由`vite.config.ts`文件配置。为了优化加载性能，构建流程中启用了代码分割（code splitting）策略。

在`vite.config.ts`的`build.rollupOptions.manualChunks`配置中，明确指定了多个独立的代码块，如`react-vendor`、`antd`、`vendor`等。这确保了第三方库能够被分离打包，从而提升浏览器的缓存效率和页面的初始加载速度。

同时，构建流程集成了`vite-plugin-compression`插件，用于生成压缩后的静态资源。该插件被配置为同时生成`gzip`（`.gz`）和`brotli`（`.br`）两种压缩格式的文件。这两种现代压缩算法能显著减小JavaScript、CSS等静态资源的体积，加快网络传输速度。

最终，所有构建产物（包括分割后的代码块和压缩文件）都会被输出到`dist`目录，为后续部署到Cloudflare Pages做好准备。

**Section sources**
- [vite.config.ts](file://frontend/vite.config.ts#L1-L48)

## Cloudflare Pages 部署机制

前端应用通过Cloudflare Pages进行部署，以实现快速、全球分发的静态网站托管。为了确保前后端在同一个域名下运行并正确处理跨域请求，项目利用了Cloudflare Pages Functions功能。

位于`frontend/functions/api/[[path]].ts`的文件是一个Pages Function，它充当了API请求的反向代理。当用户访问`/api/*`路径时，该函数会被触发。它会捕获原始请求，将其转发至后端Worker的生产地址（`https://caiwu-backend.bingyizhou6u.workers.dev`），并将响应结果返回给客户端。

此代理机制不仅统一了前后端的域名，避免了CORS（跨域资源共享）问题，还对响应头进行了关键处理。特别是，它会修改后端返回的`Set-Cookie`头，移除`domain`属性，并添加`Secure`和`SameSite=Lax`标志，以确保Cookie能在跨子域的场景下正确设置和传输。同时，函数会动态设置`Access-Control-Allow-Origin`和`Access-Control-Allow-Credentials`头，以支持凭证式请求。

**Section sources**
- [functions/api/[[path]].ts](file://frontend/functions/api/[[path]].ts#L1-L41)

## CI/CD 执行脚本示例

以下是一个完整的CI/CD执行脚本示例，涵盖了从依赖安装到最终部署的全过程。该脚本可集成到GitHub Actions等自动化平台中。

```bash
#!/bin/bash

# 1. 安装依赖
echo "安装后端依赖..."
cd backend
npm install

echo "安装前端依赖..."
cd ../frontend
npm install

# 2. 构建前端
echo "构建前端..."
npm run build

# 3. 部署后端服务 (需要 Wrangler CLI 和有效认证)
echo "部署后端 Workers..."
cd ../backend
# 设置生产环境密钥 (这些值应来自CI/CD环境变量)
echo "$CF_AUTH_JWT_SECRET" | wrangler secret put AUTH_JWT_SECRET
# 部署主后端服务
wrangler deploy
# 部署邮件服务
cd ../email-worker
wrangler deploy

# 4. Cloudflare Pages 会自动从 Git 触发部署
# 前端代码已构建在 frontend/dist 目录，Pages 会自动检测并部署
echo "部署完成。Cloudflare Pages 将自动处理前端部署。"
```

此脚本首先在`backend`和`frontend`目录下分别安装Node.js依赖。随后，进入`frontend`目录执行`npm run build`，该命令会触发Vite构建并生成`dist`目录。接着，脚本进入`backend`目录，使用`wrangler secret put`命令安全地注入JWT密钥等敏感信息，然后运行`wrangler deploy`将后端服务部署到Workers平台。邮件服务`email-worker`也以相同方式部署。最后，由于Cloudflare Pages通常与Git仓库集成，一旦代码推送到指定分支（如`main`），Pages会自动拉取代码并部署`frontend/dist`中的内容，从而完成整个CI/CD流程。

**Section sources**
- [package.json](file://frontend/package.json#L1-L45)
- [vite.config.ts](file://frontend/vite.config.ts#L1-L48)
- [wrangler.toml](file://backend/wrangler.toml#L1-L45)
- [email-worker/wrangler.toml](file://email-worker/wrangler.toml#L1-L18)