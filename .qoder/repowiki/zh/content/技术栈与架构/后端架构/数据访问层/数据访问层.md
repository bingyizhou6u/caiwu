# 数据访问层

<cite>
**本文引用的文件**
- [schema.ts](file://backend/src/db/schema.ts)
- [index.ts](file://backend/src/db/index.ts)
- [db.ts](file://backend/src/utils/db.ts)
- [sql.ts](file://backend/src/utils/sql.ts)
- [schema.sql](file://backend/src/db/schema.sql)
- [migration_performance_indexes.sql](file://backend/src/db/archive/migration_performance_indexes.sql)
- [fix_employees.sql](file://backend/src/db/archive/fix_employees.sql)
- [drizzle.config.ts](file://backend/drizzle.config.ts)
- [wrangler.toml](file://backend/wrangler.toml)
- [package.json](file://backend/package.json)
- [auth.ts](file://backend/src/routes/auth.ts)
- [employees.ts](file://backend/src/routes/employees.ts)
- [flows.ts](file://backend/src/routes/flows.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件系统性阐述基于 Drizzle ORM 的类型安全数据访问层设计，重点覆盖：
- schema.ts 中实体关系模型（用户、财务流水、组织架构等）的 TypeScript 定义与数据库表结构映射关系
- 类型推导在查询操作中的优势
- drizzle-orm/d1 适配器的初始化流程（createDb 函数）与 D1 数据库连接管理
- SQL 迁移脚本（migration_*.sql）的版本控制策略与执行机制，包括索引优化（migration_performance_indexes.sql）与数据修复脚本（fix_employees.sql）
- 自定义 SQL 查询工具（sql.ts）在复杂查询场景下的应用
- 数据库连接复用（getSession）的最佳实践

## 项目结构
后端采用分层架构，数据访问层由 Drizzle ORM + Cloudflare D1 提供支持，核心文件分布如下：
- schema.ts：定义所有实体表的 TypeScript 映射
- index.ts：Drizzle D1 适配器初始化入口
- db.ts：常用数据访问函数（会话、用户、员工、权限等）
- sql.ts：动态 SQL 构造与执行工具
- schema.sql：完整数据库表结构定义
- archive 下的迁移脚本：版本化演进与性能优化
- drizzle.config.ts：Drizzle Kit 配置
- wrangler.toml：Cloudflare Workers 绑定 D1 数据库
- routes/*：业务路由层调用数据访问层与 Drizzle 查询

```mermaid
graph TB
subgraph "数据访问层"
A["schema.ts<br/>实体定义"]
B["index.ts<br/>createDb 初始化"]
C["db.ts<br/>常用数据访问函数"]
D["sql.ts<br/>动态SQL工具"]
end
subgraph "数据库"
E["schema.sql<br/>表结构"]
F["archive/*.sql<br/>迁移/修复脚本"]
end
subgraph "运行时"
G["wrangler.toml<br/>D1 绑定"]
H["routes/*<br/>业务路由"]
end
A --> B
B --> C
B --> D
E --> F
G --> B
H --> C
H --> D
```

图表来源
- [schema.ts](file://backend/src/db/schema.ts#L1-L644)
- [index.ts](file://backend/src/db/index.ts#L1-L7)
- [db.ts](file://backend/src/utils/db.ts#L1-L314)
- [sql.ts](file://backend/src/utils/sql.ts#L1-L75)
- [schema.sql](file://backend/src/db/schema.sql#L1-L662)
- [migration_performance_indexes.sql](file://backend/src/db/archive/migration_performance_indexes.sql#L1-L42)
- [fix_employees.sql](file://backend/src/db/archive/fix_employees.sql#L1-L26)
- [wrangler.toml](file://backend/wrangler.toml#L1-L45)

章节来源
- [schema.ts](file://backend/src/db/schema.ts#L1-L644)
- [schema.sql](file://backend/src/db/schema.sql#L1-L662)
- [drizzle.config.ts](file://backend/drizzle.config.ts#L1-L8)
- [wrangler.toml](file://backend/wrangler.toml#L1-L45)

## 核心组件
- 实体定义（schema.ts）：以 sqliteTable 定义各业务表，字段类型与约束与 schema.sql 保持一致，确保类型安全与数据库一致性
- Drizzle 初始化（index.ts）：通过 createDb 将 D1 数据库实例与 schema 绑定，返回 DrizzleD1Database 实例
- 数据访问函数（db.ts）：封装常用查询、插入、会话校验、用户上下文聚合等逻辑
- 动态 SQL 工具（sql.ts）：提供动态更新语句构建与执行，适用于复杂或非标准化更新场景
- 迁移与修复（archive/*.sql）：版本化演进与性能优化，如索引优化与数据修复
- 路由层集成：业务路由通过 createDb 或直接使用 D1 实例进行查询与事务处理

章节来源
- [index.ts](file://backend/src/db/index.ts#L1-L7)
- [db.ts](file://backend/src/utils/db.ts#L1-L314)
- [sql.ts](file://backend/src/utils/sql.ts#L1-L75)
- [schema.ts](file://backend/src/db/schema.ts#L1-L644)
- [schema.sql](file://backend/src/db/schema.sql#L1-L662)

## 架构总览
Drizzle ORM 在 Cloudflare Workers 环境下通过 drizzle-orm/d1 适配器与 D1 数据库交互。路由层在请求生命周期内获取 D1 绑定，创建 Drizzle 实例，随后调用 db.ts 中的函数或直接使用 Drizzle 查询 DSL 完成业务操作。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Route as "业务路由(auth.ts/employees.ts/flows.ts)"
participant Env as "Worker 环境(wrangler.toml)"
participant D1 as "D1 数据库"
participant Drizzle as "DrizzleD1Database"
participant Utils as "db.ts/sql.ts"
Client->>Route : 发起请求
Route->>Env : 读取 DB 绑定
Route->>Drizzle : createDb(D1)
Drizzle->>D1 : 初始化连接
Route->>Utils : 调用数据访问函数/动态SQL
Utils->>D1 : 执行查询/更新
D1-->>Utils : 返回结果
Utils-->>Route : 结果集
Route-->>Client : 响应
```

图表来源
- [auth.ts](file://backend/src/routes/auth.ts#L1-L200)
- [employees.ts](file://backend/src/routes/employees.ts#L1-L200)
- [flows.ts](file://backend/src/routes/flows.ts#L1-L200)
- [wrangler.toml](file://backend/wrangler.toml#L1-L45)
- [index.ts](file://backend/src/db/index.ts#L1-L7)
- [db.ts](file://backend/src/utils/db.ts#L1-L314)
- [sql.ts](file://backend/src/utils/sql.ts#L1-L75)

## 详细组件分析

### 实体关系模型与类型推导
- schema.ts 使用 sqliteTable 定义了用户、员工、职位、部门、组织部门、账户、现金流、报销、借款、固定资产管理、租赁等核心业务实体
- 字段类型涵盖 text、integer、real、primaryKey 等，与 schema.sql 保持一致，确保类型安全
- 通过 Drizzle 的类型系统，查询返回值具备强类型推导，减少运行时错误

```mermaid
erDiagram
USERS {
text id PK
text email UK
text password_hash
integer active
integer must_change_password
integer password_changed
text totp_secret
integer last_login_at
text position_id
text department_id
text org_department_id
integer created_at
}
EMPLOYEES {
text id PK
text email UK
text name
text position_id
text org_department_id
text department_id
text join_date
integer probation_salary_cents
integer regular_salary_cents
integer living_allowance_cents
integer housing_allowance_cents
integer transportation_allowance_cents
integer meal_allowance_cents
text status
integer active
text phone
text usdt_address
text emergency_contact
text emergency_phone
text address
text memo
text birthday
text regular_date
text work_schedule
integer annual_leave_cycle_months
integer annual_leave_days
integer created_at
integer updated_at
}
POSITIONS {
text id PK
text code UK
text name
integer level
text function_role
integer can_manage_subordinates
text description
text permissions
integer sort_order
integer active
integer created_at
integer updated_at
}
ORG_DEPARTMENTS {
text id PK
text project_id
text parent_id
text name
text code
text description
text allowed_modules
text allowed_positions
text default_position_id
integer active
integer sort_order
integer created_at
integer updated_at
}
ACCOUNTS {
text id PK
text name
text type
text currency
text alias
text account_number
integer opening_cents
integer active
}
CASH_FLOWS {
text id PK
text voucher_no
text biz_date
text type
text account_id
text category_id
text method
integer amount_cents
text site_id
text department_id
text counterparty
text memo
text voucher_url
text created_by
integer created_at
}
USERS ||--o{ SESSIONS : "拥有"
EMPLOYEES ||--o{ SALARY_PAYMENTS : "关联"
EMPLOYEES ||--o{ EMPLOYEE_SALARIES : "关联"
EMPLOYEES ||--o{ EMPLOYEE_ALLOWANCES : "关联"
EMPLOYEES ||--o{ EMPLOYEE_LEAVES : "关联"
EMPLOYEES ||--o{ EXPENSE_REIMBURSEMENTS : "关联"
ORG_DEPARTMENTS ||--o{ EMPLOYEES : "包含"
POSITIONS ||--o{ EMPLOYEES : "分配"
ACCOUNTS ||--o{ CASH_FLOWS : "产生"
```

图表来源
- [schema.ts](file://backend/src/db/schema.ts#L1-L644)

章节来源
- [schema.ts](file://backend/src/db/schema.ts#L1-L644)
- [schema.sql](file://backend/src/db/schema.sql#L1-L662)

### Drizzle 初始化与 D1 连接管理
- createDb(d1: D1Database)：将 D1 数据库实例与 schema 绑定，返回 DrizzleD1Database 实例
- 路由层通常在每次请求中调用 createDb 获取会话级数据库句柄
- wrangler.toml 中通过 [[d1_databases]] binding 指定 DB 绑定名称，确保 Worker 可访问 D1

```mermaid
sequenceDiagram
participant Route as "路由"
participant Env as "Worker 环境"
participant D1 as "D1 数据库"
participant Drizzle as "DrizzleD1Database"
Route->>Env : 读取绑定 DB
Route->>Drizzle : createDb(D1)
Drizzle-->>Route : 返回 DrizzleD1Database 实例
```

图表来源
- [index.ts](file://backend/src/db/index.ts#L1-L7)
- [wrangler.toml](file://backend/wrangler.toml#L1-L45)

章节来源
- [index.ts](file://backend/src/db/index.ts#L1-L7)
- [wrangler.toml](file://backend/wrangler.toml#L1-L45)

### 类型安全查询与复杂场景
- db.ts 中的 getUserByEmail/getUserById/getSession 等函数展示了类型安全的查询写法：返回值类型由 Drizzle 推断，避免手动转换
- 复杂联表查询（getSessionWithUserAndPosition）通过 innerJoin/leftJoin 聚合用户、员工、职位、组织部门模块信息，返回强类型结果
- flows.ts 中对 cash_flows 的过滤逻辑使用 sql 条件拼接，结合 Drizzle 查询构建器实现灵活权限控制

```mermaid
flowchart TD
Start(["进入 getSessionWithUserAndPosition"]) --> BuildSelect["构建多表联接查询"]
BuildSelect --> JoinUsers["内连接 users"]
BuildSelect --> LeftJoinEmployees["左连接 employees"]
BuildSelect --> LeftJoinPositions["左连接 positions"]
BuildSelect --> LeftJoinOrgDepts["左连接 org_departments"]
JoinUsers --> ApplyWhere["应用 where 条件(会话未过期)"]
ApplyWhere --> Exec["执行查询"]
Exec --> Parse["解析返回结果(JSON字段)"]
Parse --> Return["返回强类型上下文"]
```

图表来源
- [db.ts](file://backend/src/utils/db.ts#L116-L222)

章节来源
- [db.ts](file://backend/src/utils/db.ts#L1-L314)
- [flows.ts](file://backend/src/routes/flows.ts#L120-L195)

### 自定义 SQL 工具与最佳实践
- sql.ts 提供动态更新语句构建与执行：
  - buildUpdateFields：根据传入字段映射构造更新片段与绑定值
  - buildUpdateSql：拼装最终 SQL 并追加 id 参数
  - executeUpdate：组合上述步骤并执行
- 最佳实践：
  - 仅在需要动态更新或非标准更新时使用
  - 对外部输入进行严格校验，防止注入
  - 与事务配合使用，保证原子性

```mermaid
flowchart TD
Enter(["调用 executeUpdate"]) --> BuildFields["buildUpdateFields(fieldMap)"]
BuildFields --> HasUpdates{"是否有更新字段?"}
HasUpdates --> |否| ThrowErr["抛出错误: 无更新字段"]
HasUpdates --> |是| BuildSql["buildUpdateSql(tableName, id, updates, binds)"]
BuildSql --> Run["db.prepare(sql).bind(...finalBinds).run()"]
Run --> Done(["完成"])
```

图表来源
- [sql.ts](file://backend/src/utils/sql.ts#L1-L75)

章节来源
- [sql.ts](file://backend/src/utils/sql.ts#L1-L75)

### 迁移脚本与版本控制策略
- 迁移脚本位于 backend/src/db/migration_*.sql 与 archive/*.sql
- 版本控制策略：
  - 以文件名前缀区分功能域（如 migration_performance_indexes.sql、fix_employees.sql）
  - 通过脚本注释记录创建时间与目的
  - 使用 wrangler d1 execute 执行，支持本地与远程数据库
- 索引优化脚本（migration_performance_indexes.sql）：
  - 为 cash_flows、borrowings、employee_leaves、expense_reimbursements、ar_ap_docs、employee_salaries、fixed_assets、sites 等表添加复合索引，提升常见查询性能
- 数据修复脚本（fix_employees.sql）：
  - 重建 employees 表并恢复唯一索引与常用索引，解决历史数据问题

```mermaid
flowchart TD
Plan["制定迁移计划"] --> Review["审查现有 schema.sql 与当前 D1 结构"]
Review --> Write["编写 migration_*.sql 或 archive/*.sql"]
Write --> Test["本地测试执行"]
Test --> Apply["执行 wrangler d1 execute 应用到目标数据库"]
Apply --> Verify["验证索引/数据是否正确"]
Verify --> Document["记录变更与回滚策略"]
```

图表来源
- [migration_performance_indexes.sql](file://backend/src/db/archive/migration_performance_indexes.sql#L1-L42)
- [fix_employees.sql](file://backend/src/db/archive/fix_employees.sql#L1-L26)
- [package.json](file://backend/package.json#L1-L43)

章节来源
- [migration_performance_indexes.sql](file://backend/src/db/archive/migration_performance_indexes.sql#L1-L42)
- [fix_employees.sql](file://backend/src/db/archive/fix_employees.sql#L1-L26)
- [package.json](file://backend/package.json#L1-L43)

### 会话与连接复用最佳实践
- getSession：从 sessions 表查询指定 id 的会话，并检查过期时间，返回 null 或会话对象
- 复用建议：
  - 在路由中间件中统一创建 Drizzle 实例（createDb），避免重复初始化
  - 对于高频查询，优先使用 Drizzle 查询构建器而非原生 SQL，以获得类型安全与可维护性
  - 对于复杂条件，可在服务层封装查询，路由层只负责参数校验与调用

```mermaid
sequenceDiagram
participant Route as "路由"
participant DB as "Drizzle 实例"
participant Store as "D1 存储"
Route->>DB : getSession(id)
DB->>Store : SELECT * FROM sessions WHERE id=?
Store-->>DB : 会话记录
DB-->>Route : 若未过期则返回会话，否则返回 null
```

图表来源
- [db.ts](file://backend/src/utils/db.ts#L41-L50)

章节来源
- [db.ts](file://backend/src/utils/db.ts#L1-L314)

## 依赖分析
- Drizzle ORM 依赖：drizzle-orm、drizzle-orm/d1
- Cloudflare Workers：wrangler、@cloudflare/workers-types
- 路由与 OpenAPI：@hono/zod-openapi、hono
- 测试：vitest、@cloudflare/vitest-pool-workers

```mermaid
graph LR
Pkg["package.json 依赖"] --> ORM["drizzle-orm"]
Pkg --> D1["drizzle-orm/d1"]
Pkg --> Hono["@hono/zod-openapi / hono"]
Pkg --> CF["wrangler / workers-types"]
Pkg --> Test["vitest / pool-workers"]
```

图表来源
- [package.json](file://backend/package.json#L1-L43)

章节来源
- [package.json](file://backend/package.json#L1-L43)

## 性能考量
- 索引优化：迁移脚本已为高频查询字段建立复合索引，建议持续监控慢查询并补充必要索引
- 查询模式：优先使用 Drizzle 查询构建器，减少手写 SQL；对复杂权限过滤，可在服务层封装
- 连接管理：在 Worker 请求生命周期内按需创建 Drizzle 实例，避免全局共享长连接
- 数据类型：金额类字段统一使用整数存储（cents），避免浮点误差

## 故障排查指南
- 迁移失败：
  - 检查 wrangler.toml 中 D1 绑定名称与数据库 ID 是否正确
  - 使用 package.json 中的 migrate/migrate:all 脚本逐个执行迁移脚本
- 类型不匹配：
  - 确认 schema.ts 与 schema.sql 字段定义一致
  - 使用 drizzle-kit 重新生成迁移或同步 schema
- 会话失效：
  - 检查 getSession 过期逻辑与时间戳单位（毫秒）
- 动态 SQL 注入风险：
  - 严格校验字段映射，避免直接拼接不受控输入
  - 使用绑定参数与白名单字段

章节来源
- [wrangler.toml](file://backend/wrangler.toml#L1-L45)
- [package.json](file://backend/package.json#L1-L43)
- [db.ts](file://backend/src/utils/db.ts#L41-L50)
- [sql.ts](file://backend/src/utils/sql.ts#L1-L75)

## 结论
本数据访问层以 Drizzle ORM 为核心，结合 Cloudflare D1 实现类型安全与高性能的数据访问。schema.ts 与 schema.sql 保持一致，配合迁移脚本与索引优化，确保系统在演进过程中保持稳定与高效。db.ts 与 sql.ts 分别覆盖常规查询与复杂动态更新场景，路由层通过 createDb 实现连接复用与类型安全。建议持续完善服务层封装与测试，进一步提升可维护性与可靠性。

## 附录
- Drizzle Kit 配置：drizzle.config.ts 指定方言、schema 文件与输出目录
- 路由示例：
  - 登录路由（auth.ts）：演示会话创建与用户上下文聚合
  - 员工路由（employees.ts）：展示列表与创建流程
  - 现金流路由（flows.ts）：演示复杂过滤与权限控制

章节来源
- [drizzle.config.ts](file://backend/drizzle.config.ts#L1-L8)
- [auth.ts](file://backend/src/routes/auth.ts#L1-L200)
- [employees.ts](file://backend/src/routes/employees.ts#L1-L200)
- [flows.ts](file://backend/src/routes/flows.ts#L1-L200)