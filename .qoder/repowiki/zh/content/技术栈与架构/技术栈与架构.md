# 技术栈与架构

<cite>
**本文档引用的文件**   
- [package.json](file://frontend/package.json)
- [package.json](file://backend/package.json)
- [package.json](file://email-worker/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)
- [wrangler.toml](file://backend/wrangler.toml)
- [wrangler.toml](file://email-worker/wrangler.toml)
- [main.tsx](file://frontend/src/main.tsx)
- [api.ts](file://frontend/src/config/api.ts)
- [useAppStore.ts](file://frontend/src/store/useAppStore.ts)
- [index.ts](file://backend/src/index.ts)
- [middleware.ts](file://backend/src/middleware.ts)
- [cloudflare.ts](file://backend/src/utils/cloudflare.ts)
- [drizzle.config.ts](file://backend/drizzle.config.ts)
- [schema.ts](file://backend/src/db/schema.ts)
- [index.tsx](file://frontend/src/router/index.tsx)
- [auth.ts](file://backend/src/routes/auth.ts)
</cite>

## 目录
1. [前端技术栈](#前端技术栈)
2. [后端技术栈](#后端技术栈)
3. [构建与部署工具链](#构建与部署工具链)
4. [基础设施与云服务](#基础设施与云服务)
5. [环境配置与差异](#环境配置与差异)
6. [技术决策与权衡](#技术决策与权衡)

## 前端技术栈

caiwu-main项目的前端部分采用现代化的React技术栈，结合Vite构建工具、Ant Design UI组件库、Zustand状态管理库和React Query数据获取库，构建了一个高效、可维护的单页应用（SPA）。

### React与Vite集成

前端框架基于React 18构建，利用其函数式组件和Hooks API实现组件化开发。构建工具采用Vite，通过其基于ES模块的原生浏览器支持，实现了极快的冷启动和热模块替换（HMR）速度。Vite配置文件（vite.config.ts）中定义了开发服务器代理，将API请求代理到后端Cloudflare Workers服务，解决了开发环境下的跨域问题。同时，配置了gzip和brotli压缩插件，优化了生产环境的资源加载性能。

### Ant Design组件库

UI组件库选用Ant Design（antd），提供了丰富的企业级UI组件，如表格、表单、模态框、布局等。在主入口文件（main.tsx）中，通过ConfigProvider组件全局配置了中文语言包（zhCN）和自定义主题，确保了应用的国际化和视觉一致性。Ant Design的组件被广泛应用于各个功能模块，如员工管理、财务流水、薪资发放等页面，提供了良好的用户体验。

### Zustand状态管理

状态管理采用Zustand库，替代了传统的Redux。在useAppStore.ts文件中，定义了全局应用状态，包括用户信息、认证状态、侧边栏折叠状态等。Zustand的轻量级和简单API使得状态管理更加直观和高效。通过persist中间件，将部分状态（如用户信息、token）持久化到localStorage中，实现了页面刷新后的状态保持。

### React Query数据获取

数据获取和缓存采用React Query（@tanstack/react-query），在main.tsx中创建了全局QueryClient实例，并配置了合理的缓存和重试策略。React Query的useQuery和useMutation Hooks被广泛应用于各个功能模块，如获取员工列表、提交薪资发放、审批报销等。它自动处理了数据的获取、缓存、同步和更新，大大简化了数据管理的复杂性。

**Section sources**
- [package.json](file://frontend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)
- [main.tsx](file://frontend/src/main.tsx)
- [useAppStore.ts](file://frontend/src/store/useAppStore.ts)
- [api.ts](file://frontend/src/config/api.ts)

## 后端技术栈

后端技术栈以Hono框架为核心，结合Drizzle ORM和Cloudflare Workers，构建了一个高性能、无服务器的API服务。

### Hono框架路由机制

Hono是一个轻量级、高性能的Web框架，专为现代JavaScript运行时（如Cloudflare Workers）设计。在backend/src/index.ts文件中，通过OpenAPIHono创建了应用实例，并定义了全局的错误处理、CORS中间件和路由注册。Hono的路由系统采用前缀匹配和链式调用，将不同的业务模块（如auth、employees、flows等）通过app.route()方法注册到/api前缀下。每个路由模块（如routes/auth.ts）都使用OpenAPI规范定义了接口的请求和响应格式，自动生成了Swagger UI文档，提高了API的可发现性和可维护性。

### Drizzle ORM类型安全优势

数据库操作采用Drizzle ORM，提供了类型安全的数据库查询。在drizzle.config.ts中配置了SQLite方言和Schema文件路径。src/db/schema.ts文件中定义了所有数据库表的结构，使用TypeScript类型系统确保了表、字段和关系的类型安全。Drizzle ORM的查询API是链式的，类似于Knex.js，但具有完整的TypeScript支持，可以在编译时捕获查询错误。例如，在auth.ts的登录处理中，通过eq()函数构建查询条件，确保了字段名的正确性。

### Cloudflare Workers无服务器特性

后端服务部署在Cloudflare Workers上，利用其边缘计算能力，实现了低延迟和高可用性。wrangler.toml配置文件中定义了Workers的名称、入口文件、兼容性日期和绑定资源（如D1数据库、R2存储桶、KV命名空间）。Workers的无服务器特性意味着无需管理服务器，按请求计费，极大地降低了运维成本和复杂性。同时，Workers的全球分布网络确保了无论用户身处何地，都能获得快速的响应。

**Section sources**
- [package.json](file://backend/package.json)
- [index.ts](file://backend/src/index.ts)
- [middleware.ts](file://backend/src/middleware.ts)
- [drizzle.config.ts](file://backend/drizzle.config.ts)
- [schema.ts](file://backend/src/db/schema.ts)
- [auth.ts](file://backend/src/routes/auth.ts)
- [wrangler.toml](file://backend/wrangler.toml)

## 构建与部署工具链

项目采用现代化的构建与部署工具链，确保了开发、测试和生产的高效和一致性。

### Vite构建工具

前端构建使用Vite，通过esbuild进行依赖预构建，利用Rollup进行生产构建。在vite.config.ts中配置了代码分割（manualChunks），将React、Ant Design等第三方库分离到不同的chunk中，实现了按需加载，优化了首屏加载时间。同时，配置了gzip和brotli压缩，进一步减小了资源体积。

### Wrangler部署工具

后端部署使用Wrangler CLI工具，通过wrangler deploy命令将代码部署到Cloudflare Workers。在backend/package.json中定义了deploy脚本，简化了部署流程。Wrangler还支持环境变量管理，通过wrangler secret put命令设置敏感信息（如JWT密钥），避免了明文泄露。

### Playwright测试工具

项目集成Playwright进行端到端（E2E）测试，位于frontend/tests/目录下。Playwright可以模拟真实用户操作，测试整个应用的工作流，如登录、创建员工、提交报销等。在package.json中定义了test脚本，通过Vitest运行单元测试和集成测试，确保了代码质量。

**Section sources**
- [package.json](file://frontend/package.json)
- [package.json](file://backend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)
- [wrangler.toml](file://backend/wrangler.toml)
- [playwright.config.ts](file://frontend/playwright.config.ts)

## 基础设施与云服务

项目选择Cloudflare生态作为基础设施，充分利用了其一体化的云服务。

### Cloudflare D1数据库

后端使用Cloudflare D1作为SQLite数据库服务。在wrangler.toml中通过[[d1_databases]]绑定，将数据库实例注入到Workers环境中。D1提供了无服务器的SQLite数据库，无需管理数据库服务器，按使用量计费。它与Workers无缝集成，提供了低延迟的数据访问。数据库模式通过SQL文件（如schema.sql）和Drizzle ORM进行管理，支持迁移脚本（migrate:all脚本）。

### Cloudflare Email服务

项目使用Cloudflare内置的Email服务发送通知邮件。在email-worker/wrangler.toml中通过[[send_email]]绑定，将邮件服务注入到独立的Workers中。在backend/src/utils/email.ts中，通过fetch API调用email-worker发送登录通知等邮件。这种分离架构确保了邮件发送不会阻塞主业务流程，提高了系统的可靠性和可扩展性。

### 其他Cloudflare服务

项目还利用了Cloudflare的其他服务，如R2对象存储（用于存储凭证文件）、KV命名空间（用于缓存会话数据）、IP Lists和自定义规则（用于实现IP白名单功能）。这些服务通过wrangler.toml中的绑定和API调用进行集成，构建了一个完整的云原生应用。

**Section sources**
- [wrangler.toml](file://backend/wrangler.toml)
- [wrangler.toml](file://email-worker/wrangler.toml)
- [cloudflare.ts](file://backend/src/utils/cloudflare.ts)

## 环境配置与差异

项目通过环境变量和配置文件区分开发、测试和生产环境。

### 环境变量管理

前端通过import.meta.env.DEV判断开发环境，在api.ts中配置不同的API基础URL。后端通过wrangler.toml的[env.dev.vars]配置开发环境变量（如AUTH_JWT_SECRET），生产环境的敏感变量通过wrangler secret命令设置。这种机制确保了不同环境的配置隔离和安全性。

### 配置差异

开发环境使用本地代理或直接访问本地Workers，便于调试。生产环境通过Cloudflare Pages绑定Workers，实现无缝的API调用。测试环境通过Vitest进行单元测试，使用内存数据库或模拟服务，确保测试的独立性和速度。

**Section sources**
- [api.ts](file://frontend/src/config/api.ts)
- [wrangler.toml](file://backend/wrangler.toml)

## 技术决策与权衡

### SQLite与传统关系型数据库

项目选择SQLite而非传统关系型数据库（如PostgreSQL、MySQL），主要基于以下权衡：
- **优势**：SQLite轻量、零配置、易于部署，非常适合无服务器架构。D1服务提供了全球分布的SQLite数据库，满足了基本的ACID特性。对于财务系统的核心数据（如员工、薪资、流水），其数据量和并发要求在SQLite的处理能力范围内。
- **劣势**：SQLite在高并发写入场景下性能较差，缺乏复杂的数据库管理功能（如用户权限、备份恢复）。项目通过优化查询、使用KV缓存、限制并发等手段缓解了这些问题。

### 无服务器架构

选择Cloudflare Workers的无服务器架构，带来了成本效益和全球低延迟的优势，但也引入了冷启动延迟和执行时间限制的挑战。项目通过优化代码、减少依赖、利用边缘缓存等策略，最大化了无服务器架构的效益。

**Section sources**
- [drizzle.config.ts](file://backend/drizzle.config.ts)
- [wrangler.toml](file://backend/wrangler.toml)