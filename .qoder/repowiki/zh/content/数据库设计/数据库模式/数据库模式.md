# 数据库模式

<cite>
**本文档引用的文件**
- [schema.ts](file://backend/src/db/schema.ts)
- [migration_add_salary_tables.sql](file://backend/src/db/migration_add_salary_tables.sql)
- [migration_add_cash_flow_reversal_fields.sql](file://backend/src/db/migration_add_cash_flow_reversal_fields.sql)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts)
- [SalaryPaymentService.ts](file://backend/src/services/SalaryPaymentService.ts)
- [FinanceService.ts](file://backend/src/services/FinanceService.ts)
- [FixedAssetService.ts](file://backend/src/services/FixedAssetService.ts)
- [RentalPropertyService.ts](file://backend/src/services/RentalPropertyService.ts)
- [optimistic-lock.ts](file://backend/src/utils/optimistic-lock.ts)
</cite>

## 目录
1. [引言](#引言)
2. [核心实体表](#核心实体表)
   1. [员工表 (employees)](#员工表-employees)
   2. [账户表 (accounts)](#账户表-accounts)
   3. [财务流水表 (cash_flows)](#财务流水表-cash_flows)
   4. [固定资产表 (fixed_assets)](#固定资产表-fixed_assets)
   5. [租赁物业表 (rental_properties)](#租赁物业表-rental_properties)
   6. [薪资发放表 (salary_payments)](#薪资发放表-salary_payments)
3. [主键与时间戳设计](#主键与时间戳设计)
4. [乐观锁机制](#乐观锁机制)
5. [附录：Drizzle ORM 语法示例](#附录drizzle-orm-语法示例)

## 引言

本数据库模式文档旨在详细阐述 `schema.ts` 文件中定义的所有数据表及其字段。文档将重点解析系统中的核心实体，包括员工、账户、财务流水、固定资产、租赁物业和薪资发放等。每个字段的数据类型、约束条件（如 NOT NULL、UNIQUE）、默认值及业务含义都将被逐一说明。此外，文档将特别解释合并后的员工认证字段、乐观锁版本号机制、主键设计策略以及时间戳的存储格式。

## 核心实体表

### 员工表 (employees)

`employees` 表是系统的核心，不仅存储员工的个人信息，还整合了用户认证相关的字段。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L14-L48)
- [EmployeeService.ts](file://backend/src/services/EmployeeService.ts#L139-L199)

#### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 业务含义 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | text | PRIMARY KEY | - | 员工唯一标识符，使用 UUID 生成。 |
| `email` | text | NOT NULL, UNIQUE | - | 员工的公司邮箱，用于系统登录和通信。 |
| `personalEmail` | text | - | - | 员工的个人邮箱，用于接收系统通知和邮件转发。 |
| `name` | text | - | - | 员工姓名。 |
| `positionId` | text | - | - | 关联 `positions` 表的外键，表示员工的职位。 |
| `orgDepartmentId` | text | - | - | 关联 `org_departments` 表的外键，表示员工的组织部门。 |
| `departmentId` | text | - | - | 关联 `departments` 表的外键，表示员工的行政/财务部门。 |
| `joinDate` | text | - | - | 员工入职日期，格式为 'YYYY-MM-DD'。 |
| `status` | text | - | - | 员工状态，如 'probation'（试用期）、'regular'（正式）、'left'（已离职）等。 |
| `active` | integer | - | 1 | 员工账户是否激活（1: 激活, 0: 未激活）。 |
| `phone` | text | - | - | 员工联系电话。 |
| `usdtAddress` | text | - | - | 员工的 USDT 钱包地址，用于加密货币薪资发放。 |
| `emergencyContact` | text | - | - | 紧急联系人姓名。 |
| `emergencyPhone` | text | - | - | 紧急联系人电话。 |
| `address` | text | - | - | 员工住址。 |
| `memo` | text | - | - | 备注信息。 |
| `birthday` | text | - | - | 员工生日，格式为 'YYYY-MM-DD'。 |
| `regularDate` | text | - | - | 员工转正日期，格式为 'YYYY-MM-DD'。 |
| `workSchedule` | text | - | - | 员工工作排班，以 JSON 字符串形式存储。 |
| `annualLeaveCycleMonths` | integer | - | - | 年假周期（月数）。 |
| `annualLeaveDays` | integer | - | - | 年假天数。 |
| `createdAt` | integer | - | - | 记录创建时间，存储为整数时间戳（毫秒）。 |
| `updatedAt` | integer | - | - | 记录最后更新时间，存储为整数时间戳（毫秒）。 |
| `passwordHash` | text | - | - | **认证字段**：用户密码的哈希值。 |
| `mustChangePassword` | integer | - | 0 | **认证字段**：是否必须修改密码（1: 是, 0: 否），用于首次登录强制改密。 |
| `passwordChanged` | integer | - | 0 | **认证字段**：密码是否已被修改（1: 已修改, 0: 未修改）。 |
| `totpSecret` | text | - | - | **认证字段**：TOTP（基于时间的一次性密码）的密钥，用于双因素认证。 |
| `lastLoginAt` | integer | - | - | **认证字段**：最后登录时间，存储为整数时间戳（毫秒）。 |
| `activationToken` | text | - | - | **认证字段**：账户激活令牌，用于新员工激活账户。 |
| `activationExpiresAt` | integer | - | - | **认证字段**：激活令牌过期时间，存储为整数时间戳（毫秒）。 |
| `resetToken` | text | - | - | **认证字段**：密码重置令牌。 |
| `resetExpiresAt` | integer | - | - | **认证字段**：密码重置令牌过期时间，存储为整数时间戳（毫秒）。 |

### 账户表 (accounts)

`accounts` 表用于管理公司的各类财务账户，如银行账户、现金账户等。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L139-L149)

#### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 业务含义 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | text | PRIMARY KEY | - | 账户唯一标识符，使用 UUID 生成。 |
| `name` | text | NOT NULL | - | 账户名称，如“招商银行-对公账户”。 |
| `type` | text | NOT NULL | - | 账户类型，如 'bank'（银行）、'cash'（现金）、'crypto'（加密货币）等。 |
| `currency` | text | NOT NULL | - | 账户币种，关联 `currencies.code`。 |
| `alias` | text | - | - | 账户别名，用于在界面中显示。 |
| `accountNumber` | text | - | - | 银行账号或账户号码。 |
| `openingCents` | integer | - | 0 | 期初余额，以“分”为单位存储，避免浮点数精度问题。 |
| `active` | integer | - | 1 | 账户是否启用（1: 启用, 0: 停用）。 |
| `version` | integer | - | 1 | **乐观锁版本号**：用于并发控制，每次更新时递增。 |

### 财务流水表 (cash_flows)

`cash_flows` 表记录了所有与账户相关的资金流入和流出。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L159-L187)
- [migration_add_cash_flow_reversal_fields.sql](file://backend/src/db/migration_add_cash_flow_reversal_fields.sql#L5-L8)
- [FinanceService.ts](file://backend/src/services/FinanceService.ts#L70-L199)

#### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 业务含义 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | text | PRIMARY KEY | - | 流水唯一标识符，使用 UUID 生成。 |
| `voucherNo` | text | - | - | 凭证号，系统自动生成，如 JZ20241219-001。 |
| `bizDate` | text | NOT NULL | - | 业务日期，格式为 'YYYY-MM-DD'，是记账的依据日期。 |
| `type` | text | NOT NULL | - | 流水类型，'income'（收入）或 'expense'（支出）。 |
| `accountId` | text | NOT NULL | - | 关联 `accounts.id` 的外键，表示此流水所属的账户。 |
| `categoryId` | text | - | - | 关联 `categories.id` 的外键，表示此流水的收支类别。 |
| `method` | text | - | - | 支付方式，如 'cash'（现金）、'bank_transfer'（银行转账）、'usdt'（USDT）等。 |
| `amountCents` | integer | NOT NULL | - | 金额，以“分”为单位存储。 |
| `siteId` | text | - | - | 关联 `sites.id` 的外键，表示此流水关联的站点。 |
| `departmentId` | text | - | - | 关联 `departments.id` 的外键，表示此流水关联的部门。 |
| `counterparty` | text | - | - | 交易对方，如供应商名称或客户名称。 |
| `memo` | text | - | - | 备注信息。 |
| `voucherUrl` | text | - | - | 凭证文件的存储路径（URL）。 |
| `createdBy` | text | - | - | 创建人，关联 `employees.id`。 |
| `createdAt` | integer | - | - | 记录创建时间，存储为整数时间戳（毫秒）。 |
| `isReversal` | integer | - | 0 | **红冲字段**：是否为红冲记录（0: 否, 1: 是）。 |
| `reversalOfFlowId` | text | - | - | **红冲字段**：被冲正的原始流水ID，关联 `cash_flows.id`。 |
| `isReversed` | integer | - | 0 | **红冲字段**：原始流水是否已被冲正（0: 否, 1: 是）。 |
| `reversedByFlowId` | text | - | - | **红冲字段**：冲正此记录的流水ID，关联 `cash_flows.id`。 |

### 固定资产表 (fixed_assets)

`fixed_assets` 表用于管理公司的固定资产，如设备、车辆、房产等。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L506-L530)
- [FixedAssetService.ts](file://backend/src/services/FixedAssetService.ts#L183-L200)

#### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 业务含义 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | text | PRIMARY KEY | - | 固定资产唯一标识符，使用 UUID 生成。 |
| `assetCode` | text | NOT NULL, UNIQUE | - | 资产编码，公司内部的唯一编号。 |
| `name` | text | NOT NULL | - | 资产名称。 |
| `category` | text | - | - | 资产类别，如 'computer'（电脑）、'vehicle'（车辆）、'furniture'（家具）等。 |
| `purchaseDate` | text | - | - | 购买日期，格式为 'YYYY-MM-DD'。 |
| `purchasePriceCents` | integer | NOT NULL | - | 购买价格，以“分”为单位存储。 |
| `currency` | text | NOT NULL | - | 购买币种，关联 `currencies.code`。 |
| `vendorId` | text | - | - | 关联 `vendors.id` 的外键，表示供应商。 |
| `departmentId` | text | - | - | 关联 `departments.id` 的外键，表示资产所属部门。 |
| `siteId` | text | - | - | 关联 `sites.id` 的外键，表示资产所在站点。 |
| `custodian` | text | - | - | 保管人姓名。 |
| `status` | text | - | 'in_use' | 资产状态，如 'in_use'（在用）、'idle'（闲置）、'maintenance'（维修中）、'scrapped'（已报废）、'sold'（已出售）等。 |
| `depreciationMethod` | text | - | - | 折旧方法，如 'straight_line'（直线法）、'declining_balance'（余额递减法）等。 |
| `usefulLifeYears` | integer | - | - | 预计使用年限（年）。 |
| `currentValueCents` | integer | - | - | 当前净值，以“分”为单位存储。 |
| `memo` | text | - | - | 备注信息。 |
| `saleDate` | text | - | - | 出售日期，格式为 'YYYY-MM-DD'。 |
| `salePriceCents` | integer | - | - | 出售价格，以“分”为单位存储。 |
| `saleBuyer` | text | - | - | 买家名称。 |
| `saleMemo` | text | - | - | 出售备注。 |
| `createdBy` | text | - | - | 创建人，关联 `employees.id`。 |
| `createdAt` | integer | - | - | 记录创建时间，存储为整数时间戳（毫秒）。 |
| `updatedAt` | integer | - | - | 记录最后更新时间，存储为整数时间戳（毫秒）。 |

### 租赁物业表 (rental_properties)

`rental_properties` 表用于管理公司租赁的各类物业，如办公室、宿舍、仓库等。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L576-L603)
- [RentalPropertyService.ts](file://backend/src/services/RentalPropertyService.ts#L86-L110)

#### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 业务含义 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | text | PRIMARY KEY | - | 物业唯一标识符，使用 UUID 生成。 |
| `propertyCode` | text | NOT NULL | - | 物业代码，公司内部的唯一编号。 |
| `name` | text | NOT NULL | - | 物业名称。 |
| `propertyType` | text | NOT NULL | - | 物业类型，如 'office'（办公室）、'dormitory'（宿舍）、'apartment'（公寓）、'warehouse'（仓库）等。 |
| `address` | text | - | - | 物业地址。 |
| `areaSqm` | real | - | - | 面积（平方米），使用 `real` 类型存储浮点数。 |
| `rentType` | text | - | 'monthly' | 租金类型，'monthly'（月租）或 'yearly'（年租）。 |
| `monthlyRentCents` | integer | - | - | 月租金，以“分”为单位存储。 |
| `yearlyRentCents` | integer | - | - | 年租金，以“分”为单位存储。 |
| `currency` | text | NOT NULL | - | 租金币种，关联 `currencies.code`。 |
| `paymentPeriodMonths` | integer | - | 1 | 支付周期（月数），如按季度支付则为3。 |
| `landlordName` | text | - | - | 房东姓名。 |
| `landlordContact` | text | - | - | 房东联系方式。 |
| `leaseStartDate` | text | - | - | 租赁开始日期，格式为 'YYYY-MM-DD'。 |
| `leaseEndDate` | text | - | - | 租赁结束日期，格式为 'YYYY-MM-DD'。 |
| `depositCents` | integer | - | - | 押金，以“分”为单位存储。 |
| `paymentMethod` | text | - | - | 支付方式。 |
| `paymentAccountId` | text | - | - | 关联 `accounts.id` 的外键，表示用于支付租金的账户。 |
| `paymentDay` | integer | - | 1 | 每月支付日（1-31）。 |
| `departmentId` | text | - | - | 关联 `departments.id` 的外键，表示负责此物业的部门。 |
| `status` | text | - | 'active' | 物业状态，'active'（活跃）或 'inactive'（非活跃）。 |
| `memo` | text | - | - | 备注信息。 |
| `contractFileUrl` | text | - | - | 租赁合同文件的存储路径（URL）。 |
| `createdBy` | text | - | - | 创建人，关联 `employees.id`。 |
| `createdAt` | integer | - | - | 记录创建时间，存储为整数时间戳（毫秒）。 |
| `updatedAt` | integer | - | - | 记录最后更新时间，存储为整数时间戳（毫秒）。 |

### 薪资发放表 (salary_payments)

`salary_payments` 表记录了员工薪资发放的完整流程和状态。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L286-L316)
- [SalaryPaymentService.ts](file://backend/src/services/SalaryPaymentService.ts#L117-L149)

#### 字段说明

| 字段名 | 数据类型 | 约束 | 默认值 | 业务含义 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | text | PRIMARY KEY | - | 薪资发放记录唯一标识符，使用 UUID 生成。 |
| `employeeId` | text | NOT NULL | - | 关联 `employees.id` 的外键，表示发放薪资的员工。 |
| `year` | integer | NOT NULL | - | 发放年份。 |
| `month` | integer | NOT NULL | - | 发放月份。 |
| `salaryCents` | integer | NOT NULL | - | 应发薪资总额，以“分”为单位存储。 |
| `status` | text | NOT NULL | - | 发放状态，如 'pending_employee_confirmation'（待员工确认）、'pending_finance_approval'（待财务审批）、'pending_payment'（待支付）、'completed'（已完成）等。 |
| `allocationStatus` | text | - | 'pending' | 货币分配状态，'pending'（待分配）、'requested'（已申请）、'approved'（已批准）。 |
| `employeeConfirmedBy` | text | - | - | 员工确认人，关联 `employees.id`。 |
| `employeeConfirmedAt` | integer | - | - | 员工确认时间，存储为整数时间戳（毫秒）。 |
| `financeApprovedBy` | text | - | - | 财务审批人，关联 `employees.id`。 |
| `financeApprovedAt` | integer | - | - | 财务审批时间，存储为整数时间戳（毫秒）。 |
| `accountId` | text | - | - | 关联 `accounts.id` 的外键，表示用于支付薪资的账户。 |
| `paymentTransferredBy` | text | - | - | 支付执行人，关联 `employees.id`。 |
| `paymentTransferredAt` | integer | - | - | 支付执行时间，存储为整数时间戳（毫秒）。 |
| `paymentVoucherPath` | text | - | - | 支付凭证文件的存储路径（URL）。 |
| `paymentConfirmedBy` | text | - | - | 支付确认人，关联 `employees.id`。 |
| `paymentConfirmedAt` | integer | - | - | 支付确认时间，存储为整数时间戳（毫秒）。 |
| `rollbackReason` | text | - | - | 回退原因。 |
| `rollbackBy` | text | - | - | 执行回退操作的用户，关联 `employees.id`。 |
| `rollbackAt` | integer | - | - | 回退操作时间，存储为整数时间戳（毫秒）。 |
| `version` | integer | - | 1 | **乐观锁版本号**：用于并发控制，每次更新时递增。 |
| `createdAt` | integer | - | - | 记录创建时间，存储为整数时间戳（毫秒）。 |
| `updatedAt` | integer | - | - | 记录最后更新时间，存储为整数时间戳（毫秒）。 |

## 主键与时间戳设计

### 主键设计策略

本系统所有核心表的主键均采用 `text` 类型，并使用 UUID（Universally Unique Identifier）作为主键值。这种设计策略具有以下优势：
1.  **全局唯一性**：UUID 算法保证了在分布式系统中生成的 ID 也具有极高的唯一性，避免了不同数据源合并时的主键冲突。
2.  **安全性**：与自增整数相比，UUID 作为主键更难被猜测，提高了系统的安全性，防止了通过枚举ID进行的恶意攻击。
3.  **灵活性**：在数据迁移、分库分表等场景下，UUID 主键无需重新生成或调整，极大地简化了操作。

### 时间戳存储格式

系统中所有与时间相关的字段（如 `createdAt`, `updatedAt`, `lastLoginAt` 等）均采用 `integer` 类型存储，其值为自 Unix 纪元（1970-01-01 00:00:00 UTC）以来的毫秒数。这种设计有以下优点：
1.  **精度高**：毫秒级精度足以满足绝大多数业务场景的需求。
2.  **计算方便**：整数类型便于进行时间的加减、比较等计算操作。
3.  **存储高效**：相比于存储字符串格式的日期（如 'YYYY-MM-DD HH:mm:ss'），整数存储更节省空间。
4.  **时区无关**：存储的是绝对时间戳，与客户端或服务器的时区设置无关，避免了时区转换带来的复杂性。

前端在展示时，会通过工具函数（如 `formatDateTime`）将时间戳转换为用户本地时区的可读日期时间。

## 乐观锁机制

为了防止在高并发环境下出现数据更新冲突（即“丢失更新”问题），系统在多个关键业务表（如 `accounts`, `salary_payments`, `employee_leaves`, `borrowings` 等）中引入了乐观锁机制。

### 实现方式

1.  **版本号字段**：每个支持乐观锁的表都包含一个名为 `version` 的 `integer` 类型字段，默认值为 1。
2.  **读取数据**：当客户端读取一条记录时，会同时获取其 `id` 和当前的 `version` 值。
3.  **更新数据**：客户端在提交更新请求时，必须提供它所读取到的 `version` 值（期望版本）。
4.  **数据库校验**：服务端在执行更新操作时，会在 `WHERE` 子句中同时检查 `id` 和 `version`。例如：
    ```sql
    UPDATE salary_payments 
    SET status = 'pending_finance_approval', version = version + 1, ... 
    WHERE id = ? AND version = ?
    ```
5.  **结果判断**：如果数据库返回的受影响行数为 0，则说明在客户端读取数据后，该记录已被其他用户修改，导致版本号不匹配。此时，服务端会抛出 `BUS_CONCURRENT_MODIFICATION` 错误，提示用户“数据已被其他用户修改，请刷新后重试”。

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L148)
- [optimistic-lock.ts](file://backend/src/utils/optimistic-lock.ts#L16-L39)
- [SalaryPaymentService.ts](file://backend/src/services/SalaryPaymentService.ts#L128-L130)

## 附录：Drizzle ORM 语法示例

以下代码片段展示了如何使用 Drizzle ORM 定义 `accounts` 表。这体现了本系统数据库模式的定义方式。

```typescript
export const accounts = sqliteTable('accounts', {
  id: text('id').primaryKey(),
  name: text('name').notNull(),
  type: text('type').notNull(),
  currency: text('currency').notNull(),
  alias: text('alias'),
  accountNumber: text('account_number'),
  openingCents: integer('opening_cents').default(0),
  active: integer('active').default(1),
  version: integer('version').default(1), // 乐观锁版本号
})
```

**Section sources**
- [schema.ts](file://backend/src/db/schema.ts#L139-L149)