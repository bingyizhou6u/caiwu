# 监控与日志

<cite>
**本文档引用的文件**  
- [wrangler.toml](file://backend/wrangler.toml)
- [logger.ts](file://backend/src/utils/logger.ts)
- [errors.ts](file://backend/src/utils/errors.ts)
- [audit.ts](file://backend/src/utils/audit.ts)
- [audit.ts](file://backend/src/routes/audit.ts)
- [AuditLogs.tsx](file://frontend/src/features/system/pages/AuditLogs.tsx)
- [cloudflare.ts](file://backend/src/utils/cloudflare.ts)
- [middleware.ts](file://backend/src/middleware.ts)
- [index.ts](file://backend/src/index.ts)
</cite>

## 目录
1. [日志与监控配置](#日志与监控配置)
2. [日志记录规范](#日志记录规范)
3. [审计日志实现](#审计日志实现)
4. [错误处理与日志](#错误处理与日志)
5. [日志查询与告警](#日志查询与告警)
6. [常见错误模式识别](#常见错误模式识别)
7. [性能瓶颈排查](#性能瓶颈排查)

## 日志与监控配置

根据 `wrangler.toml` 文件中的配置，系统的可观测性（observability）功能已通过 Cloudflare Workers 的原生支持进行配置。日志功能已启用，并设置了采样率。

```toml
[observability]
enabled = false

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
```

- **日志启用状态**：`observability.logs.enabled = true` 表示日志功能已开启，所有请求的执行日志将被记录。
- **采样率配置**：`head_sampling_rate = 1` 表示采样率为 100%，即所有请求的日志都会被记录，无任何采样丢弃。
- **调用日志**：`invocation_logs = true` 确保每个函数调用的详细日志（包括开始、结束、执行上下文等）都会被输出。

此配置确保了系统在生产环境中具备完整的日志追踪能力，便于后续的审计、调试和性能分析。

**Section sources**
- [wrangler.toml](file://backend/wrangler.toml)

## 日志记录规范

系统通过 `src/utils/logger.ts` 提供了一个统一的日志工具，支持结构化日志输出和多级别日志控制。

### 日志级别
日志工具定义了四个级别，按严重性递增：
- `debug`：调试信息，用于开发环境详细追踪。
- `info`：一般信息，如请求记录、认证事件。
- `warn`：警告信息，表示潜在问题。
- `error`：错误信息，表示系统异常或业务失败。

### 日志级别控制
生产环境默认日志级别为 `info`，即 `debug` 级别的日志不会输出，以减少日志量。开发环境可调整为 `debug` 级别以获取更详细信息。

### 结构化日志
所有日志输出均为结构化 JSON 格式，包含时间戳、日志级别、消息和上下文信息。上下文（`LogContext`）可包含 `requestId`、`userId`、`action` 等字段，便于日志关联和分析。

### 专用日志方法
日志工具提供了便捷方法用于特定场景：
- `logger.request()`：记录 HTTP 请求。
- `logger.db()`：记录数据库操作（仅在 `debug` 级别输出）。
- `logger.auth()`：记录认证相关事件。

这些规范确保了日志的一致性和可读性，为运维和开发提供了清晰的系统行为视图。

**Section sources**
- [logger.ts](file://backend/src/utils/logger.ts)

## 审计日志实现

系统实现了完整的审计日志功能，用于记录所有关键业务操作，确保操作可追溯。

### 数据库表结构
审计日志存储在 `audit_logs` 表中，包含操作者（`actorId`）、操作类型（`action`）、操作对象（`entity`）、操作时间（`at`）、IP地址（`ip`）和IP归属地（`ipLocation`）等字段。

### IP信息记录
通过 Cloudflare 提供的请求头（如 `cf-connecting-ip`, `cf-ipcountry`, `cf-ipcity`），系统在记录审计日志时自动捕获操作者的IP地址和地理位置信息，增强了审计的完整性。

### 日志记录流程
1. **触发**：业务逻辑中调用 `logAuditAction(c, action, entity, entityId, detail)`。
2. **信息收集**：从请求上下文（`c`）中获取 `userId` 和 IP 信息。
3. **异步写入**：使用 `c.executionCtx.waitUntil()` 将日志写入操作放入异步队列，避免阻塞主业务流程。
4. **持久化**：日志通过 D1 数据库的 `INSERT` 语句写入 `audit_logs` 表。

前端通过 `/api/audit-logs` 接口查询审计日志，支持按操作类型、操作对象、操作者、时间范围等条件过滤。

**Section sources**
- [audit.ts](file://backend/src/utils/audit.ts)
- [audit.ts](file://backend/src/routes/audit.ts)
- [AuditLogs.tsx](file://frontend/src/features/system/pages/AuditLogs.tsx)

## 错误处理与日志

系统采用统一的错误处理机制，确保错误信息被正确记录和响应。

### 统一错误类
`AppError` 类定义了标准化的错误结构，包含 `statusCode`、`code`、`message` 和 `details` 字段，便于前端识别和处理不同类型的错误。

### 全局错误中间件
在 `src/index.ts` 中注册了全局错误处理中间件 `errorHandler`。该中间件会：
1. **结构化错误日志**：将错误信息（包括请求URL、方法、用户ID、IP、User-Agent、错误堆栈等）以 JSON 格式记录。
2. **区分错误类型**：
   - `AppError`：业务错误，使用 `info` 级别记录。
   - `ZodError`：参数验证错误，使用 `info` 级别记录。
   - 其他未预期错误：使用 `error` 级别记录，并返回 500 响应。
3. **返回标准化响应**：向客户端返回包含错误码和消息的 JSON 响应。

此机制确保了所有错误都被捕获和记录，同时避免了敏感信息（如完整堆栈）在生产环境中暴露给前端。

**Section sources**
- [errors.ts](file://backend/src/utils/errors.ts)
- [index.ts](file://backend/src/index.ts)

## 日志查询与告警

运维人员可以通过以下方式查询日志和设置告警。

### 通过 Cloudflare 仪表板查询
1. 登录 Cloudflare 控制台。
2. 导航至 Workers & Pages -> 选择 `caiwu-backend` Worker。
3. 在 "Logs" 标签页中，可以实时查看所有日志输出。
4. 使用查询语言（如 `http.status:500`）过滤特定日志。

### 通过 Cloudflare API 查询
可以使用 Cloudflare Logs API 通过编程方式获取日志数据，用于自动化分析和集成。

### 设置告警规则
1. 在 Cloudflare 仪表板中，进入 "Logs" -> "Logpush"。
2. 配置日志推送目标（如 AWS S3、Datadog 等）。
3. 在目标系统（如 Datadog）中创建监控仪表板和告警规则。
   - **示例告警**：当 `error` 级别日志数量在 5 分钟内超过 10 条时，触发告警。
   - **示例告警**：当 HTTP 5xx 错误率超过 1% 时，发送通知。

### 内部审计日志查询
系统提供了 `/api/audit-logs` API 接口，前端 `AuditLogs` 页面提供了图形化查询界面，支持导出 CSV 报告。

**Section sources**
- [cloudflare.ts](file://backend/src/utils/cloudflare.ts)
- [AuditLogs.tsx](file://frontend/src/features/system/pages/AuditLogs.tsx)

## 常见错误模式识别

通过分析日志，可以识别以下常见错误模式：

### 1. 认证失败 (`UNAUTHORIZED`)
- **日志特征**：`error` 级别日志，消息为 "unauthorized"，`url` 为受保护的API端点。
- **原因**：JWT 过期、无效或缺失。
- **排查**：检查客户端是否正确发送了 `Authorization` 头或 `sid` Cookie。

### 2. 权限不足 (`FORBIDDEN`)
- **日志特征**：`error` 级别日志，`code: "FORBIDDEN"`。
- **原因**：用户角色或职位权限不足。
- **排查**：检查 `userPosition` 和 `departmentModules` 上下文，确认权限配置。

### 3. 数据库查询失败
- **日志特征**：`error` 级别日志，包含 `DB prepare` 或 `D1_EXEC_ERROR`。
- **原因**：SQL 语法错误、D1 限制或临时故障。
- **排查**：检查 SQL 语句和 D1 文档，确认查询复杂度。

### 4. 审计日志写入失败
- **日志特征**：`error` 级别日志，消息为 "Audit log error:"。
- **原因**：数据库连接问题或 `waitUntil` 超时。
- **注意**：此类错误为异步记录，不影响主业务流程。

**Section sources**
- [errors.ts](file://backend/src/utils/errors.ts)
- [middleware.ts](file://backend/src/middleware.ts)

## 性能瓶颈排查

通过日志分析，可以定位以下性能瓶颈：

### 1. 数据库查询延迟
- **识别**：`logger.db()` 记录的 `debug` 日志显示某些查询耗时过长。
- **工具**：结合 D1 的查询性能分析。
- **优化**：检查是否缺少索引，优化 SQL 查询。

### 2. 高频请求导致 Worker 冷启动
- **识别**：Cloudflare 日志中出现大量 `Cold Start` 标记。
- **影响**：首次请求延迟较高。
- **优化**：考虑使用 Durable Objects 或调整 Worker 资源。

### 3. 复杂业务逻辑阻塞
- **识别**：单个请求处理时间过长，日志中存在长时间的同步操作。
- **优化**：将耗时操作（如文件导出、邮件发送）移至异步队列（如 Queues）。

### 4. KV 缓存未命中
- **识别**：`middleware.ts` 中从数据库查询 session 的频率过高。
- **优化**：确保 `SESSIONS_KV` 配置正确，提高缓存命中率。

通过持续监控日志中的 `info` 和 `warn` 级别信息，可以提前发现性能退化趋势，及时进行优化。

**Section sources**
- [middleware.ts](file://backend/src/middleware.ts)
- [logger.ts](file://backend/src/utils/logger.ts)