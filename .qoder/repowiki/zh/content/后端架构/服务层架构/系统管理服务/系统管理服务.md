# 系统管理服务

<cite>
**本文档引用的文件**  
- [MasterDataService.ts](file://backend/src/services/MasterDataService.ts)
- [SystemConfigService.ts](file://backend/src/services/SystemConfigService.ts)
- [AuthService.ts](file://backend/src/services/AuthService.ts)
- [PermissionService.ts](file://backend/src/services/PermissionService.ts)
- [IPWhitelistService.ts](file://backend/src/services/IPWhitelistService.ts)
- [ImportService.ts](file://backend/src/services/ImportService.ts)
- [ReportService.ts](file://backend/src/services/ReportService.ts)
- [AuditService.ts](file://backend/src/services/AuditService.ts)
- [system-config.ts](file://backend/src/routes/v2/system-config.ts)
- [auth.ts](file://backend/src/routes/v2/auth.ts)
- [auth.ts](file://backend/src/utils/auth.ts)
- [TrustedDeviceService.ts](file://backend/src/services/TrustedDeviceService.ts)
- [permission.ts](file://backend/src/middleware/permission.ts)
- [ipWhitelist.ts](file://backend/src/middleware/ipWhitelist.ts)
</cite>

## 目录
1. [引言](#引言)
2. [主数据服务](#主数据服务)
3. [系统配置服务](#系统配置服务)
4. [认证服务](#认证服务)
5. [权限与安全服务](#权限与安全服务)
6. [数据导入与报表服务](#数据导入与报表服务)
7. [审计日志服务](#审计日志服务)
8. [服务协同工作场景](#服务协同工作场景)
9. [结论](#结论)

## 引言

本系统管理服务模块是整个财务管理系统的核心基础，负责管理组织架构、部门、职位、币种等主数据，提供系统参数配置、用户认证、权限控制、数据导入、报表生成和审计日志等关键功能。该模块采用微服务架构，各服务职责清晰，通过门面模式（Facade Pattern）对外提供统一接口，确保了系统的可维护性和扩展性。

## 主数据服务

`MasterDataService` 是一个门面服务，它不直接处理业务逻辑，而是将请求委托给具体的主数据服务类，如 `DepartmentService`、`CurrencyService`、`PositionService` 等。这种设计模式简化了客户端的调用，隐藏了系统内部的复杂性。

该服务统一管理以下核心主数据：
- **部门管理**：支持部门的增删改查，是组织架构的基础。
- **站点管理**：管理业务发生的物理或逻辑站点。
- **账户管理**：管理财务账户，支持账户交易查询。
- **供应商管理**：维护供应商信息。
- **总部管理**：定义公司总部信息。
- **币种管理**：支持多币种业务，提供币种的增删改查及批量操作。
- **类别管理**：对财务流水进行分类。
- **职位管理**：定义组织内的职位，并提供可用职位查询。
- **组织部门管理**：管理项目与部门的关联关系。

通过 `MasterDataService`，前端可以使用统一的API端点 `/api/v2/master-data` 来访问所有主数据，而无需关心后端具体的服务划分。

**Section sources**
- [MasterDataService.ts](file://backend/src/services/MasterDataService.ts)

## 系统配置服务

`SystemConfigService` 负责管理系统的全局配置参数。所有配置项都存储在数据库的 `system_config` 表中，以键值对（key-value）的形式存在。

该服务提供了以下核心功能：
- **获取配置** (`get`)：根据配置键获取配置值。服务会尝试将值字段从JSON字符串解析为对象，以支持复杂数据结构。
- **获取所有配置** (`getAll`)：返回所有配置项的列表，同样会进行JSON解析。
- **设置配置** (`set`)：创建或更新配置项。该操作使用了 `ON CONFLICT DO UPDATE` 语法，实现了“存在则更新，不存在则插入”的原子操作，确保了数据的一致性。

系统配置被广泛应用于控制系统的各种行为，例如通过 `2fa_enabled` 键来控制双因素认证是否强制开启。

**Section sources**
- [SystemConfigService.ts](file://backend/src/services/SystemConfigService.ts)
- [system-config.ts](file://backend/src/routes/v2/system-config.ts)

## 认证服务

`AuthService` 是系统安全的门户，负责处理用户登录、登出、密码重置、账号激活和双因素认证（2FA）等所有与身份验证相关的操作。

### JWT生成与会话管理

认证成功后，服务会创建一个会话（Session）。会话信息同时存储在两个地方：
1.  **持久化存储 (D1 Database)**：作为备份和审计日志的依据。
2.  **高性能缓存 (KV Namespace)**：用于快速验证，提升系统性能。

会话创建时，会生成一个JWT（JSON Web Token），其中包含了会话ID（`sid`）、用户ID（`sub`）、邮箱、姓名和职位信息。该JWT通过 `signAuthToken` 函数签名，并设置7天的过期时间。客户端在后续请求中通过 `Authorization` 头或Cookie携带此Token，服务端通过 `verifyAuthToken` 函数验证其有效性。

### TOTP双因素验证

系统集成了基于TOTP（基于时间的一次性密码）的双因素验证机制，以增强安全性。
- **生成TOTP**：`generateTotpForActivation` 方法使用 `otplib` 库为用户生成一个密钥和对应的二维码（SVG格式），供用户在Google Authenticator等应用中扫描绑定。
- **验证TOTP**：`verifyTotp` 函数用于验证用户输入的6位验证码是否正确。
- **信任设备**：为了提升用户体验，系统引入了“信任设备”机制。当用户在新设备上登录并成功验证TOTP后，该设备的指纹（由用户ID、IP和User-Agent生成的SHA-256哈希）会被记录。在90天的有效期内，用户再次从此设备登录时无需重复验证TOTP。

### 认证流程

完整的登录流程如下：
1.  用户提交邮箱和密码。
2.  服务验证凭据。
3.  检查系统是否强制开启2FA以及用户是否已绑定TOTP。
4.  如果是新设备且需要2FA，则要求用户提供TOTP验证码。
5.  验证成功后，创建会话，生成JWT，并返回给客户端。

**Section sources**
- [AuthService.ts](file://backend/src/services/AuthService.ts)
- [auth.ts](file://backend/src/routes/v2/auth.ts)
- [auth.ts](file://backend/src/utils/auth.ts)
- [TrustedDeviceService.ts](file://backend/src/services/TrustedDeviceService.ts)

## 权限与安全服务

### 权限控制

`PermissionService` 实现了基于角色的访问控制（RBAC）。它通过检查用户（actor）的职位级别（`level`）和职位代码（`code`）来决定其是否有权执行特定操作。

核心权限检查方法包括：
- **`canViewEmployee`**：检查用户是否有权查看目标员工的数据。例如，总部人员（`level=1`）可以查看所有人，而工程师只能查看自己。
- **`canApproveApplication`**：检查用户是否有权审批（如请假、报销）申请。例如，项目主管可以审批本项目的所有申请，而组长只能审批本组工程师的申请。

该服务通过查询数据库中的 `employees` 和 `positions` 表来获取必要的信息，并根据预定义的规则进行判断。

### IP白名单

`IPWhitelistService` 与Cloudflare的防火墙规则集成，实现IP地址白名单功能。
- **管理IP列表**：可以在Cloudflare的IP列表中添加、删除和批量操作IP地址。
- **控制访问规则**：可以创建、启用或禁用基于该IP列表的防火墙规则。
- **中间件集成**：`createIPWhitelistMiddleware` 中间件在请求到达业务逻辑前进行拦截。它会检查客户端IP是否在白名单中。该中间件使用了内存缓存来存储IP列表和规则状态，以减少对Cloudflare API的频繁调用，提高性能。

**Section sources**
- [PermissionService.ts](file://backend/src/services/PermissionService.ts)
- [IPWhitelistService.ts](file://backend/src/services/IPWhitelistService.ts)
- [permission.ts](file://backend/src/middleware/permission.ts)
- [ipWhitelist.ts](file://backend/src/middleware/ipWhitelist.ts)

## 数据导入与报表服务

### 数据导入处理

`ImportService` 负责处理CSV文件的数据导入，特别是财务流水（`cash_flows`）的导入。
- **CSV解析**：使用 `parseCsv` 工具函数将CSV内容解析为二维数组。
- **数据验证**：检查必要的表头（如 `biz_date`, `type`, `account_id`, `amount`）是否存在。
- **事务处理**：整个导入过程在一个数据库事务中执行，确保数据的原子性。如果导入失败，所有已插入的数据都会回滚。
- **余额计算**：在插入每条流水前，会计算该账户在该业务日期之前的余额，以确保账户余额的准确性。

### 报表生成机制

`ReportService` 是一个门面服务，它将报表请求委托给具体的报表服务类，如 `DashboardReportService`、`FinancialReportService` 和 `BusinessReportService`。
- **门面模式**：通过 `ReportService`，前端可以调用统一的方法（如 `getDashboardStats`, `getArApSummary`）来获取不同类型的报表，而无需直接与多个服务交互。
- **功能委托**：该服务在构造函数中实例化了各个具体的报表服务，并在相应的方法中调用它们的实现。

**Section sources**
- [ImportService.ts](file://backend/src/services/ImportService.ts)
- [ReportService.ts](file://backend/src/services/ReportService.ts)

## 审计日志服务

`AuditService` 负责记录系统中所有关键操作的审计日志，以满足安全和合规性要求。
- **日志记录**：`log` 方法是核心，它将操作的执行者（`actorId`）、操作类型（`action`）、操作对象（`entity`）、对象ID（`entityId`）、详细信息（`detail`）和IP地址等信息记录到 `audit_logs` 表中。
- **标准化操作类型**：服务定义了 `AUDIT_ACTIONS` 常量对象，对登录、创建、更新、删除、审批等操作进行了标准化，确保日志的一致性。
- **便捷方法**：提供了 `logCreate`, `logUpdate`, `logDelete`, `logApproval` 等便捷方法，简化了常见操作的日志记录。
- **日志查询**：`getAuditLogs` 方法支持根据操作类型、实体类型、执行者、时间范围等条件查询审计日志，并支持分页。`getAuditLogOptions` 方法用于获取查询下拉框的选项（如所有可能的操作类型）。

**Section sources**
- [AuditService.ts](file://backend/src/services/AuditService.ts)

## 服务协同工作场景

让我们通过“用户登录”这一场景，来展示这些服务是如何协同工作的：

1.  **请求到达**：用户在前端输入邮箱、密码和TOTP（如果需要），发起登录请求。
2.  **中间件处理**：请求首先经过 `loginRateLimit` 中间件，防止暴力破解。
3.  **认证服务**：`AuthService.login` 方法被调用。
    -   `EmployeeService` 被用来根据邮箱查找用户。
    -   `SystemConfigService` 被查询以确定2FA是否开启。
    -   `TrustedDeviceService` 被用来生成设备指纹并检查是否为信任设备。
    -   如果需要验证TOTP，`auth.ts` 中的 `verifyTotp` 函数会被调用。
4.  **会话创建**：认证成功后，`AuthService.createSession` 被调用，同时写入D1数据库和KV缓存。
5.  **审计记录**：`AuditService.log` 被调用，记录一次 `login` 操作。
6.  **生成响应**：`AuthService` 生成JWT和包含用户信息的响应载荷。
7.  **返回客户端**：登录成功，客户端收到JWT并存储，后续请求将携带此Token。

这个流程清晰地展示了 `AuthService` 如何作为核心，协调 `SystemConfigService`、`TrustedDeviceService` 和 `AuditService` 共同完成一次安全的用户认证。

## 结论

系统管理服务模块设计精良，各服务职责单一且高度内聚。通过门面模式、中间件和清晰的依赖关系，构建了一个安全、可靠且易于维护的系统基础。`MasterDataService` 和 `ReportService` 提供了统一的访问入口，`AuthService` 和 `PermissionService` 构成了坚固的安全防线，而 `AuditService` 则为系统的可追溯性提供了保障。这些服务的协同工作，确保了整个财务管理系统能够稳定、安全地运行。