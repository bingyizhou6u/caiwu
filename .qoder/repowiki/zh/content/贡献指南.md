# 贡献指南

<cite>
**本文档引用的文件**  
- [.cursorrules](file://.cursorrules)
- [backend/.lintstagedrc.json](file://backend/.lintstagedrc.json)
- [backend/.prettierrc.json](file://backend/.prettierrc.json)
- [backend/eslint.config.js](file://backend/eslint.config.js)
- [backend/package.json](file://backend/package.json)
- [backend/README.md](file://backend/README.md)
- [frontend/package.json](file://frontend/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [开发环境设置](#开发环境设置)
3. [代码贡献流程](#代码贡献流程)
4. [技术规范与工具](#技术规范与工具)
5. [代码风格指南](#代码风格指南)
6. [PR审查与分支管理](#pr审查与分支管理)
7. [版本发布周期](#版本发布周期)

## 简介
本贡献指南旨在为开发者提供清晰的代码贡献流程和技术规范，确保团队协作高效有序。文档涵盖开发环境配置、测试运行、代码格式化、lint检查、commit提交规范以及AI辅助开发中的配置说明。通过遵循本文档，所有贡献者能够保持一致的代码质量和开发实践。

## 开发环境设置

### 前置要求
- Node.js 18+
- npm 或 yarn 包管理器
- Cloudflare 账户（用于部署）
- Wrangler CLI（本地开发和部署）

### 安装依赖
```bash
# 后端
cd backend && npm install

# 前端
cd frontend && npm install
```

### 环境配置
1. **登录 Cloudflare**
```bash
npx wrangler login
```

2. **配置环境变量**
在 `wrangler.toml` 文件中设置必要的环境变量：
```toml
[vars]
CF_ACCOUNT_ID = "your-account-id"
CF_ZONE_ID = "your-zone-id"
CF_IP_LIST_ID = "your-ip-list-id"
```

3. **设置 Secret**
```bash
# JWT 密钥
wrangler secret put AUTH_JWT_SECRET

# 邮件服务 Token
wrangler secret put EMAIL_TOKEN
```

### 启动开发服务器
```bash
# 后端 (端口 8787)
cd backend && npm run dev

# 前端 (端口 5173)
cd frontend && npm run dev
```

**Section sources**
- [backend/README.md](file://backend/README.md#L49-L53)
- [frontend/README.md](file://frontend/README.md#L32-L35)

## 代码贡献流程

### 标准贡献步骤
1. 从 `develop` 分支创建新特性分支
2. 实现功能或修复问题
3. 运行测试并确保通过
4. 提交代码（自动触发 lint 和格式化）
5. 推送分支并创建 Pull Request
6. 等待审查并根据反馈修改
7. 合并到 `develop` 分支

### Git Hooks 自动化
项目配置了 Git Hooks，在提交代码前自动执行：
- 运行 ESLint 检查和修复
- 运行 Prettier 格式化
- 执行 TypeScript 类型检查

### 提交信息规范
- 使用中文编写提交信息
- 清晰描述改动内容
- 遵循 Conventional Commits 规范
- 包含相关 issue 编号（如适用）

**Section sources**
- [backend/README.md](file://backend/README.md#L130-L137)
- [frontend/README.md](file://frontend/README.md#L86)

## 技术规范与工具

### 代码格式化 (Prettier)
项目使用 Prettier 统一代码格式，配置如下：
```json
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "avoid",
  "endOfLine": "lf"
}
```

常用命令：
```bash
# 格式化代码
npm run format

# 检查代码格式
npm run format:check
```

### Lint 检查 (ESLint)
ESLint 配置确保代码质量和最佳实践：
```javascript
export default [
  js.configs.recommended,
  {
    files: ['**/*.ts'],
    languageOptions: {
      parser: tsparser,
      parserOptions: {
        ecmaVersion: 2022,
        sourceType: 'module',
        project: './tsconfig.json',
      },
    },
    plugins: {
      '@typescript-eslint': tseslint,
    },
    rules: {
      '@typescript-eslint/no-explicit-any': 'warn',
      '@typescript-eslint/no-unused-vars': 'warn',
      'no-console': ['warn', { allow: ['warn', 'error', 'log'] }],
      'prefer-const': 'warn',
      'no-var': 'error',
      eqeqeq: ['warn', 'always'],
    },
  },
]
```

常用命令：
```bash
# 代码检查
npm run lint

# 自动修复代码问题
npm run lint:fix
```

### 提交前检查 (lint-staged)
`.lintstagedrc.json` 配置提交前的自动化检查：
```json
{
  "*.ts": [
    "eslint --fix",
    "prettier --write"
  ],
  "*.json": [
    "prettier --write"
  ]
}
```

此配置确保所有 TypeScript 和 JSON 文件在提交前自动格式化和修复。

### 测试执行
```bash
# 运行所有测试
npm test

# 运行测试并生成覆盖率报告
npm run test:coverage

# 类型检查
npm run typecheck
```

**Section sources**
- [backend/.prettierrc.json](file://backend/.prettierrc.json)
- [backend/eslint.config.js](file://backend/eslint.config.js)
- [backend/.lintstagedrc.json](file://backend/.lintstagedrc.json)
- [backend/package.json](file://backend/package.json#L24-L27)

## 代码风格指南

### TypeScript 类型使用
- 使用 TypeScript 严格模式
- 避免使用 `any` 类型，使用 `unknown` 或具体类型替代
- 充分利用泛型提高代码复用性
- 使用 Zod 进行运行时类型验证
- 所有金额以整数（cents）存储，变量命名如 `amountCents`

### 函数命名规范
- 使用驼峰命名法 (camelCase)
- 函数名应清晰表达其功能
- 动词开头，如 `getUser`, `createEmployee`, `validateInput`
- 异步函数使用 `async` 关键字，并考虑返回 Promise 类型

### 注释规范
- 所有函数和类使用中文注释
- 复杂逻辑添加行内注释说明
- 注释应解释"为什么"而不仅仅是"做什么"
- 保持注释与代码同步更新
- 使用 JSDoc 风格为公共 API 添加文档

### 错误处理模式
- 使用 try-catch 处理异步操作
- 创建统一的错误处理中间件
- 返回结构化的错误响应
- 记录错误日志用于调试
- 对用户友好的错误消息，避免暴露敏感信息

**Section sources**
- [backend/README.md](file://backend/README.md#L285-L291)
- [.cursorrules](file://.cursorrules#L271-L277)

## PR审查与分支管理

### 分支管理策略
- `main` 分支：生产环境代码，受保护
- `develop` 分支：集成分支，包含所有已完成的功能
- 特性分支：从 `develop` 创建，命名格式 `feature/xxx` 或 `bugfix/xxx`
- 发布分支：`release/vX.X.X`，用于版本发布准备

### PR审查流程
1. **创建 PR**：从特性分支向 `develop` 分支创建 Pull Request
2. **自动检查**：CI/CD 流水线运行测试、lint 和类型检查
3. **人工审查**：至少一名核心成员审查代码
4. **反馈与修改**：根据审查意见进行修改
5. **批准合并**：满足所有条件后批准合并

### 审查要点
- 代码功能是否满足需求
- 是否遵循代码风格指南
- 是否有足够的测试覆盖
- 是否有潜在的性能问题
- 错误处理是否完善
- 文档是否更新

### 合并要求
- 所有自动化检查通过
- 至少一名审查者批准
- 分支与 `develop` 最新代码合并
- 相关测试用例完整

**Section sources**
- [backend/README.md](file://backend/README.md#L293-L297)

## 版本发布周期

### 发布流程
1. 从 `develop` 分支创建 `release/vX.X.X` 分支
2. 进行发布前测试和修复
3. 更新版本号和变更日志
4. 合并到 `main` 分支并打标签
5. 部署到生产环境
6. 合并回 `develop` 分支

### 版本号规范
遵循语义化版本控制 (SemVer)：
- 主版本号：重大变更，不兼容的API修改
- 次版本号：新增功能，向后兼容
- 修订号：bug修复，向后兼容

### 自动化部署
```bash
# 部署到生产环境
npm run deploy

# 部署到预览环境
wrangler deploy --env preview
```

### 数据库迁移
发布时可能需要数据库迁移：
```bash
# 本地迁移
npm run migrate:up

# 远程迁移（生产环境）
npm run migrate:up:remote

# 应用所有迁移
npm run migrate:all
```

**Section sources**
- [backend/README.md](file://backend/README.md#L241-L251)
- [backend/package.json](file://backend/package.json#L8-L9)