# 部署指南

<cite>
**本文档中引用的文件**  
- [wrangler.toml](file://backend/wrangler.toml)
- [package.json](file://backend/package.json)
- [package.json](file://frontend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)
- [cloudflare.ts](file://backend/src/utils/cloudflare.ts)
- [middleware.ts](file://backend/src/middleware.ts)
- [index.ts](file://backend/src/index.ts)
- [monitoring.ts](file://backend/src/utils/monitoring.ts)
- [logger.ts](file://backend/src/utils/logger.ts)
- [_worker.ts](file://frontend/_worker.ts)
- [email-worker/wrangler.toml](file://email-worker/wrangler.toml)
</cite>

## 目录
1. [简介](#简介)
2. [后端服务部署](#后端服务部署)
3. [前端静态资源部署](#前端静态资源部署)
4. [环境配置管理](#环境配置管理)
5. [健康检查与监控](#健康检查与监控)
6. [日志收集方案](#日志收集方案)
7. [总结](#总结)

## 简介
本指南详细说明了如何将caiwu-main系统部署到生产环境。文档涵盖了使用Wrangler CLI将后端服务发布到Cloudflare Workers的完整流程，包括环境变量配置、D1数据库绑定、KV命名空间设置和域名映射。同时描述了前端静态资源的构建（vite build）与部署到Cloudflare Pages或类似平台的方法。提供了不同环境（开发、测试、生产）的配置管理策略，并包含健康检查接口（/api/health）的监控配置建议和日志收集方案，确保系统可观察性。

## 后端服务部署

### 使用Wrangler CLI部署到Cloudflare Workers
后端服务基于Hono框架构建，部署到Cloudflare Workers平台。部署流程通过Wrangler CLI工具完成，核心配置文件为`backend/wrangler.toml`。

部署步骤如下：
1. 确保已安装最新版本的Wrangler CLI
2. 在`backend`目录下执行`wrangler deploy`命令
3. 部署过程中会自动处理D1数据库、R2存储桶和KV命名空间的绑定

```toml
name = "caiwu-backend"
main = "src/index.ts"
compatibility_date = "2024-11-21"
compatibility_flags = ["nodejs_compat"]

[[d1_databases]]
binding = "DB"
database_name = "caiwu-db"
database_id = "582b2cc8-fb7f-47a3-9b12-a264621c2eeb"

[[r2_buckets]]
binding = "VOUCHERS"
bucket_name = "caiwu-vouchers"

[[kv_namespaces]]
binding = "SESSIONS_KV"
id = "35e234c4fcf04c5e84b814e0aed53788"
```

**后端部署流程**
1. 初始化项目：`cd backend && npm install`
2. 构建项目：`npm run build`（如果需要）
3. 部署到生产环境：`wrangler deploy src/index.ts`
4. 验证部署状态：`wrangler tail` 查看实时日志

**Section sources**
- [wrangler.toml](file://backend/wrangler.toml)
- [package.json](file://backend/package.json)

### 环境变量配置
生产环境的敏感信息通过Cloudflare Secret进行管理，避免明文存储。关键环境变量包括：

- `AUTH_JWT_SECRET`：JWT令牌签名密钥，通过`wrangler secret put AUTH_JWT_SECRET`设置
- `CF_IP_LISTS_TOKEN`：Cloudflare API令牌，用于IP白名单管理
- `CF_FIREWALL_TOKEN`：Cloudflare防火墙API令牌
- `CF_EMAIL_TOKEN`：邮件服务API令牌

开发环境使用`wrangler.toml`中的`[env.dev.vars]`部分进行配置，生产环境则通过Wrangler CLI的secret命令设置。

```bash
# 设置生产环境密钥
wrangler secret put AUTH_JWT_SECRET
wrangler secret put CF_IP_LISTS_TOKEN
wrangler secret put CF_FIREWALL_TOKEN
wrangler secret put CF_EMAIL_TOKEN
```

**Section sources**
- [wrangler.toml](file://backend/wrangler.toml)
- [cloudflare.ts](file://backend/src/utils/cloudflare.ts)

### D1数据库绑定与迁移
系统使用Cloudflare D1作为关系型数据库。部署时需要确保D1数据库已正确绑定，并执行数据库迁移。

数据库迁移脚本位于`backend/src/db/migration_*.sql`，通过以下命令执行迁移：

```bash
# 执行所有迁移脚本
npm run migrate:all

# 或逐个执行
wrangler d1 execute caiwu-db --remote --file="src/db/migration_add_departments_sort_order.sql"
```

首次部署时，系统会自动检查数据库是否为空，并通过`/api/v2/init-if-empty`接口初始化基础数据（如管理员账户、总部信息等）。

**Section sources**
- [package.json](file://backend/package.json)
- [index.ts](file://backend/src/index.ts)

### KV命名空间设置
系统使用Cloudflare KV存储会话信息，命名空间为`SESSIONS_KV`。KV命名空间在`wrangler.toml`中声明，并通过`SESSIONS_KV`绑定在代码中使用。

会话管理通过JWT令牌与KV存储结合实现，用户认证成功后，会话信息存储在KV中，有效期为7天，并支持滑动窗口续期。

```typescript
// 会话缓存逻辑
let sessionData = (await c.env.SESSIONS_KV.get(`session:${payload.sid}`, 'json')) as any

if (!sessionData) {
  sessionData = await getSessionWithUserAndPosition(c.env.DB, payload.sid)
  
  if (sessionData && sessionData.session) {
    const ttl = Math.floor((sessionData.session.expires_at - Date.now()) / 1000)
    if (ttl > 0) {
      c.executionCtx.waitUntil(
        c.env.SESSIONS_KV.put(`session:${payload.sid}`, JSON.stringify(sessionData), {
          expirationTtl: ttl,
        })
      )
    }
  }
}
```

**Section sources**
- [wrangler.toml](file://backend/wrangler.toml)
- [middleware.ts](file://backend/src/middleware.ts)

### 域名映射
生产环境的域名映射通过Cloudflare DNS和Workers路由规则配置。建议将后端服务部署到专用子域名（如`api.yourdomain.com`），并通过Workers路由规则将`/api/*`请求指向后端服务。

在Cloudflare控制面板中：
1. 添加CNAME记录指向Workers域名
2. 配置Workers路由规则，将API请求转发到后端服务
3. 配置SSL证书以支持HTTPS

**Section sources**
- [wrangler.toml](file://backend/wrangler.toml)

## 前端静态资源部署

### 构建前端资源
前端使用Vite构建工具，构建命令定义在`frontend/package.json`中：

```json
"scripts": {
  "dev": "vite",
  "build": "vite build && npm run build-worker",
  "build-worker": "esbuild _worker.ts --bundle --format=esm --outfile=dist/_worker.js --platform=neutral --target=es2022",
  "preview": "vite preview --port 5173"
}
```

构建过程包括：
1. 执行`vite build`生成静态资源
2. 使用esbuild打包`_worker.ts`作为Pages Functions
3. 输出到`dist`目录

```typescript
export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url)

    // 处理 /api/* 请求
    if (url.pathname.startsWith('/api/')) {
      try {
        const apiPath = url.pathname
        const backendUrl = BACKEND_URL + apiPath + url.search

        // 复制请求头
        const headers = new Headers()
        request.headers.forEach((value, key) => {
          if (!['host', 'cf-connecting-ip', 'cf-ray', 'cf-visitor'].includes(key.toLowerCase())) {
            headers.set(key, value)
          }
        })
        
        return fetch(backendUrl, {
          method: request.method,
          headers,
          body: request.method !== 'GET' && request.method !== 'HEAD' ? request.body : undefined,
        })
      } catch (error: unknown) {
        const message = error instanceof Error ? error.message : String(error)
        console.error('API proxy error:', message)
        return new Response(JSON.stringify({ error: 'API proxy error', detail: message }), {
          status: 502,
          headers: { 'Content-Type': 'application/json' }
        })
      }
    }

    // 其他请求，返回静态资源
    return env.ASSETS.fetch(request)
  }
}
```

**Section sources**
- [package.json](file://frontend/package.json)
- [_worker.ts](file://frontend/_worker.ts)

### 部署到Cloudflare Pages
前端静态资源可部署到Cloudflare Pages或其他静态网站托管平台。部署到Cloudflare Pages的步骤如下：

1. 在Cloudflare Pages控制面板创建新项目
2. 连接GitHub/GitLab仓库
3. 配置构建设置：
   - 构建命令：`npm run build`
   - 输出目录：`dist`
4. 部署并配置自定义域名

部署后，Pages Functions会自动处理API请求代理，将`/api/*`请求转发到后端Workers服务。

**Section sources**
- [vite.config.ts](file://frontend/vite.config.ts)

## 环境配置管理

### 多环境配置策略
系统支持开发、测试、生产三种环境的配置管理。配置策略如下：

- **开发环境**：使用`wrangler.toml`中的`[env.dev]`配置，包含明文测试密钥
- **测试环境**：使用独立的Wrangler环境配置，通过`wrangler deploy --env staging`部署
- **生产环境**：所有敏感信息通过Cloudflare Secret管理，避免明文存储

环境变量通过`process.env.NODE_ENV`区分，不同环境加载不同的配置。

```typescript
// 开发环境配置示例
[env.dev.vars]
AUTH_JWT_SECRET = "dev-jwt-secret-for-local-testing-only"
```

**Section sources**
- [wrangler.toml](file://backend/wrangler.toml)

### 配置文件结构
核心配置文件包括：

- `backend/wrangler.toml`：Workers核心配置，包含绑定、环境变量等
- `frontend/vite.config.ts`：前端构建配置，包含代理、压缩等设置
- `backend/package.json`：构建和部署脚本定义

```typescript
// 前端构建配置
export default defineConfig({
  plugins: [
    react(),
    viteCompression({
      algorithm: 'gzip',
      ext: '.gz',
    }),
    viteCompression({
      algorithm: 'brotliCompress',
      ext: '.br',
    }),
  ],
  server: {
    proxy: {
      '/api': {
        target: 'https://caiwu-backend.bingyizhou6u.workers.dev',
        changeOrigin: true
      }
    }
  },
  build: {
    outDir: 'dist',
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'antd': ['antd'],
        },
      },
    },
  }
})
```

**Section sources**
- [vite.config.ts](file://frontend/vite.config.ts)

## 健康检查与监控

### 健康检查接口
系统提供`/api/health`接口用于健康检查，该接口检查所有关键依赖的连通性：

- D1数据库连接
- KV命名空间可用性
- R2存储桶可用性

```typescript
app.get('/api/health', async c => {
  const checks = {
    db: false,
    kv: false,
    r2: false,
  }

  // 1. Check DB
  try {
    const r = await Promise.race([
      c.env.DB.prepare('select 1 as ok').first<{ ok: number }>(),
      new Promise<null>((_, reject) => setTimeout(() => reject(new Error('db timeout')), 2000)),
    ]).catch(() => null)
    checks.db = r ? r.ok === 1 : false
  } catch (error) {
    Logger.error('Health check DB error', { error })
  }

  // 2. Check KV (Sessions)
  try {
    await Promise.race([
      c.env.SESSIONS_KV.list({ limit: 1 }),
      new Promise((_, reject) => setTimeout(() => reject(new Error('kv timeout')), 2000)),
    ])
    checks.kv = true
  } catch (error) {
    Logger.error('Health check KV error', { error })
  }

  // 3. Check R2 (Vouchers)
  try {
    await Promise.race([
      c.env.VOUCHERS.list({ limit: 1 }),
      new Promise((_, reject) => setTimeout(() => reject(new Error('r2 timeout')), 2000)),
    ])
    checks.r2 = true
  } catch (error) {
    Logger.error('Health check R2 error', { error })
  }

  const healthy = checks.db && checks.kv && checks.r2
  
  return c.json(
    {
      status: healthy ? 'healthy' : 'degraded',
      checks,
      timestamp: new Date().toISOString(),
    },
    healthy ? 200 : 503
  )
})
```

**Section sources**
- [index.ts](file://backend/src/index.ts)

### 监控配置建议
系统内置基本的监控能力，包括性能指标收集和错误统计。建议配置以下监控：

1. **健康检查监控**：定期调用`/api/health`接口，确保服务可用性
2. **性能监控**：收集请求处理时间、数据库查询时间等指标
3. **错误监控**：记录和分析系统错误

```typescript
// 性能监控中间件
export function performanceMonitor(): MiddlewareHandler<{
  Bindings: Env
  Variables: AppVariables
}> {
  return async (c, next) => {
    const monitoring = getMonitoringService()
    const requestStartTime = performance.now()

    try {
      await next()
      const requestDuration = performance.now() - requestStartTime
      
      monitoring.recordMetric('http.request.duration', requestDuration, 'ms', {
        method: c.req.method,
        path: c.req.path,
        status: c.res.status.toString(),
      })
    } catch (error) {
      const requestDuration = performance.now() - requestStartTime
      monitoring.recordMetric('http.request.duration', requestDuration, 'ms', {
        method: c.req.method,
        path: c.req.path,
        status: 'error',
      })
      throw error
    }
  }
}
```

**Section sources**
- [monitoring.ts](file://backend/src/utils/monitoring.ts)

## 日志收集方案

### 日志格式与级别
系统使用结构化日志格式，包含时间戳、日志级别、请求ID、用户ID等信息。日志级别包括INFO、WARN、ERROR、DEBUG。

```typescript
interface LogEntry {
  timestamp: string
  level: LogLevel
  requestId: string
  userId?: string
  ip?: string
  message: string
  data?: any
}
```

敏感信息（如密码、令牌）在日志中自动脱敏，替换为`******`。

```typescript
private static readonly SENSITIVE_KEYS = new Set([
  'password',
  'password_confirmation',
  'token',
  'access_token',
  'refresh_token',
  'secret',
  'api_key',
  'authorization',
  'cookie',
  'totp',
  'totpSecret',
  'totpCode',
])
```

**Section sources**
- [logger.ts](file://backend/src/utils/logger.ts)

### 日志收集与分析
Cloudflare Workers的日志可通过以下方式收集：

1. **Wrangler Tail**：实时查看日志流，用于调试
2. **Cloudflare Logpush**：将日志推送到云存储（如AWS S3、Google Cloud Storage）
3. **第三方监控服务**：集成Sentry、Datadog等进行错误跟踪和性能分析

建议配置Logpush将日志持久化存储，并设置告警规则，当错误率超过阈值时通知运维人员。

**Section sources**
- [logger.ts](file://backend/src/utils/logger.ts)

## 总结
本部署指南详细说明了caiwu-main系统的完整部署流程。通过Wrangler CLI将后端服务部署到Cloudflare Workers，前端资源部署到Cloudflare Pages，实现了全栈无服务器架构。系统具备完善的健康检查、监控和日志收集能力，确保生产环境的稳定性和可观察性。建议在生产部署前充分测试，并根据实际需求调整配置。