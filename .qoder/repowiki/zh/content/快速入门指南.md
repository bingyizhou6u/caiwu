# 快速入门指南

<cite>
**本文档中引用的文件**
- [backend/package.json](file://backend/package.json)
- [backend/wrangler.toml](file://backend/wrangler.toml)
- [backend/drizzle.config.ts](file://backend/drizzle.config.ts)
- [backend/scripts/migrate-up.ts](file://backend/scripts/migrate-up.ts)
- [backend/scripts/generate-seed.ts](file://backend/scripts/generate-seed.ts)
- [backend/src/index.ts](file://backend/src/index.ts)
- [backend/src/db/schema.ts](file://backend/src/db/schema.ts)
- [backend/src/config/paths.ts](file://backend/src/config/paths.ts)
- [backend/README.md](file://backend/README.md)
- [frontend/package.json](file://frontend/package.json)
- [frontend/README.md](file://frontend/README.md)
- [backend/.cloudflare-tokens](file://backend/.cloudflare-tokens)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [环境准备](#环境准备)
3. [克隆仓库与安装依赖](#克隆仓库与安装依赖)
4. [配置环境变量](#配置环境变量)
5. [启动开发服务器](#启动开发服务器)
6. [初始化数据库](#初始化数据库)
7. [生成种子数据](#生成种子数据)
8. [访问API文档](#访问api文档)
9. [常见问题排查](#常见问题排查)
10. [验证安装成功](#验证安装成功)

## 项目概述

caiwu-main 是一个企业级财务管理系统，采用前后端分离架构。后端基于 Cloudflare Workers + Hono + Drizzle ORM 构建，前端基于 React + TypeScript + Vite 构建。本指南将指导您如何在本地搭建完整的开发环境。

**本文档中引用的文件**
- [backend/README.md](file://backend/README.md)
- [frontend/README.md](file://frontend/README.md)

## 环境准备

在开始之前，请确保您的开发环境已安装以下必要工具：

- **Node.js 18+**: 项目依赖的 Node.js 版本
- **npm 或 yarn**: 包管理工具
- **Wrangler CLI**: Cloudflare Workers 的命令行工具，用于本地开发和部署
- **Git**: 代码版本控制工具

您可以通过以下命令验证工具是否已正确安装：

```bash
node --version
npm --version
npx wrangler --version
git --version
```

## 克隆仓库与安装依赖

### 1. 克隆仓库

首先，使用 Git 克隆 caiwu-main 项目仓库到本地：

```bash
git clone https://github.com/your-organization/caiwu-main.git
cd caiwu-main
```

### 2. 安装后端依赖

进入 `backend` 目录并安装 Node.js 依赖包：

```bash
cd backend
npm install
```

### 3. 安装前端依赖

返回项目根目录，进入 `frontend` 目录并安装依赖：

```bash
cd ../frontend
npm install
```

**本文档中引用的文件**
- [backend/package.json](file://backend/package.json)
- [frontend/package.json](file://frontend/package.json)

## 配置环境变量

### 1. 登录 Cloudflare

在本地开发前，需要使用 Wrangler CLI 登录您的 Cloudflare 账户：

```bash
npx wrangler login
```

此命令会打开浏览器窗口，引导您完成授权流程。

### 2. 配置 wrangler.toml

项目根目录下的 `backend/wrangler.toml` 文件包含了 Cloudflare Workers 的配置。对于本地开发，大部分配置已预设，您通常无需修改。

```toml
name = "caiwu-backend"
main = "src/index.ts"
compatibility_date = "2024-11-21"
compatibility_flags = ["nodejs_compat"]
```

### 3. 设置 Secret

生产环境的敏感信息（如 JWT 密钥）通过 Cloudflare Secret 管理。对于本地开发，这些值已在 `wrangler.toml` 的 `[env.dev.vars]` 部分预设。

如果您需要更新 JWT 密钥，可以运行以下命令：

```bash
# 此命令仅用于生产环境部署
wrangler secret put AUTH_JWT_SECRET
```

**本文档中引用的文件**
- [backend/wrangler.toml](file://backend/wrangler.toml)
- [backend/.cloudflare-tokens](file://backend/.cloudflare-tokens)

## 启动开发服务器

### 1. 启动后端服务

在 `backend` 目录下，使用以下命令启动后端开发服务器：

```bash
npm run dev
```

成功启动后，您将看到类似以下的输出：

```
> caiwu-backend@0.1.0 dev
> wrangler dev src/index.ts

⬣  Built successfully, built project size is 1.5 MiB.
⬣  Successfully synced triggers
Local mode activated, you can now run Workers on your local machine.
Your worker has access to the following bindings:
- D1 Database: DB (caiwu-db)
- R2 Bucket: VOUCHERS (caiwu-vouchers)
- KV Namespace: SESSIONS_KV
- Service: EMAIL_SERVICE (caiwu-email)
Listening on http://127.0.0.1:8787
```

后端服务默认在 `http://localhost:8787` 上运行。

### 2. 启动前端服务

在另一个终端窗口中，进入 `frontend` 目录并启动前端开发服务器：

```bash
npm run dev
```

成功启动后，您将看到：

```
> caiwu-frontend@0.1.0 dev
> vite

  VITE v5.4.8  ready in 1234 ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
```

前端服务默认在 `http://localhost:5173` 上运行。

**本文档中引用的文件**
- [backend/package.json](file://backend/package.json)
- [frontend/package.json](file://frontend/package.json)

## 初始化数据库

本项目使用 Cloudflare D1（基于 SQLite）作为数据库，并通过 Drizzle ORM 进行迁移管理。

### 1. 了解数据库迁移

数据库迁移文件位于 `backend/src/db/` 目录下，以 `migration_` 开头。迁移状态由 `schema_migrations` 表追踪。

### 2. 执行数据库迁移

在 `backend` 目录下，运行以下命令来应用所有未执行的迁移：

```bash
npm run migrate:up
```

此命令会执行 `scripts/migrate-up.ts` 脚本，该脚本会：
1.  确保 `schema_migrations` 追踪表存在
2.  扫描所有 `migration_*.sql` 文件
3.  检查每个迁移是否已执行
4.  按文件名排序，依次执行未执行的迁移

预期输出示例：
```
开始迁移检查 (本地数据库)...
✓ 迁移追踪表已创建或已存在
找到 5 个迁移文件
执行迁移: migration_add_departments_sort_order.sql
✓ 迁移 migration_add_departments_sort_order.sql 执行成功并已记录
执行迁移: migration_add_salary_tables.sql
✓ 迁移 migration_add_salary_tables.sql 执行成功并已记录
...

迁移完成: 执行了 5 个新迁移，跳过了 0 个已执行的迁移
```

**本文档中引用的文件**
- [backend/package.json](file://backend/package.json)
- [backend/scripts/migrate-up.ts](file://backend/scripts/migrate-up.ts)
- [backend/src/db/schema.ts](file://backend/src/db/schema.ts)

## 生成种子数据

为了方便开发和测试，项目提供了一个脚本来生成初始的种子数据。

### 1. 运行种子数据生成脚本

在 `backend` 目录下，执行以下命令：

```bash
npm run seed
```

此命令会执行 `scripts/generate-seed.ts` 脚本，该脚本会：
1.  生成包含初始数据的 SQL 语句
2.  将 SQL 语句写入 `src/db/seed.sql`
3.  使用 `wrangler d1 execute` 命令将数据插入数据库

### 2. 种子数据内容

生成的种子数据包括：
- **总部**: "Global HQ"
- **部门**: 财务部 (FIN)、工程部 (ENG)、人力资源部 (HR)
- **职位**: 管理员 (ADMIN)、经理 (MGR)、工程师 (ENG)、财务专员 (FIN)
- **管理员员工**: 邮箱 `admin@example.com`，密码 `password123`

**本文档中引用的文件**
- [backend/package.json](file://backend/package.json)
- [backend/scripts/generate-seed.ts](file://backend/scripts/generate-seed.ts)

## 访问API文档

项目集成了 Swagger UI，用于可视化地浏览和测试 API。

### 1. 访问 Swagger UI

在后端服务运行后，打开浏览器并访问：

```
http://localhost:8787/api/ui
```

您将看到一个交互式的 API 文档界面，其中列出了所有可用的 API 端点。

### 2. API 文档路径

根据 `backend/src/index.ts` 中的配置，API 文档的路径如下：
- **OpenAPI 规范**: `http://localhost:8787/api/doc`
- **Swagger UI**: `http://localhost:8787/api/ui`

这些路径在 `src/config/paths.ts` 中被定义为公开路径，无需认证即可访问。

**本文档中引用的文件**
- [backend/src/index.ts](file://backend/src/index.ts)
- [backend/src/config/paths.ts](file://backend/src/config/paths.ts)

## 常见问题排查

### 1. 端口冲突

**问题**: `npm run dev` 启动失败，提示端口 8787 已被占用。

**解决方案**:
-   使用 `lsof -i :8787` (macOS/Linux) 或 `netstat -ano | findstr :8787` (Windows) 查找占用端口的进程。
-   终止占用端口的进程，或修改 Wrangler 的端口。Wrangler 支持 `--port` 参数：
    ```bash
    npx wrangler dev --port 8788
    ```

### 2. 权限错误

**问题**: 执行 `wrangler` 命令时出现权限不足的错误。

**解决方案**:
-   确保您已运行 `npx wrangler login` 并成功登录 Cloudflare 账户。
-   检查您的 Cloudflare 账户是否有权限访问指定的 Workers、D1 数据库和 R2 存储桶。

### 3. 数据库连接失败

**问题**: 启动后端服务时，日志显示无法连接到 D1 数据库。

**解决方案**:
-   检查 `backend/wrangler.toml` 文件中的 `database_id` 是否正确。
-   确认 `wrangler login` 已成功执行。
-   检查您的网络连接，确保可以访问 Cloudflare 服务。

### 4. 依赖安装失败

**问题**: `npm install` 过程中出现网络错误或包下载失败。

**解决方案**:
-   尝试更换 npm 源，例如使用淘宝镜像：
    ```bash
    npm config set registry https://registry.npmmirror.com
    ```
-   清除 npm 缓存后重试：
    ```bash
    npm cache clean --force
    rm -rf node_modules package-lock.json
    npm install
    ```

**本文档中引用的文件**
- [backend/README.md](file://backend/README.md)
- [backend/wrangler.toml](file://backend/wrangler.toml)

## 验证安装成功

完成以上所有步骤后，您可以通过以下方式验证开发环境已成功搭建：

1.  **访问前端页面**: 打开 `http://localhost:5173`，您应该能看到前端应用的登录页面。
2.  **访问API文档**: 打开 `http://localhost:8787/api/ui`，您应该能看到完整的 Swagger UI 文档。
3.  **测试健康检查**: 使用 curl 或浏览器访问 `http://localhost:8787/api/health`，应返回包含数据库、KV、R2 健康状态的 JSON 响应。
4.  **尝试登录**: 使用种子数据中的管理员账号 (`admin@example.com` / `password123`) 尝试登录，如果能成功获取 JWT Token 并进入系统，则表明前后端服务、数据库和认证流程均已正常工作。

至此，您已成功在本地搭建了 caiwu-main 项目的完整开发环境，可以开始进行开发和调试了。

**本文档中引用的文件**
- [backend/src/index.ts](file://backend/src/index.ts)
- [backend/README.md](file://backend/README.md)