# ARå…¬å¸è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ - AI åŠ©æ‰‹é…ç½®

> æœ¬æ–‡ä»¶ä¸º Antigravity AI åŠ©æ‰‹æä¾›é¡¹ç›®ä¸Šä¸‹æ–‡ï¼Œæ¯æ¬¡å¯¹è¯æ—¶è‡ªåŠ¨åŠ è½½ã€‚

---

## é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: caiwu-main 
**ç±»å‹**: ä¼ä¸šè´¢åŠ¡ç®¡ç†ç³»ç»Ÿ 
**æŠ€æœ¯æ ˆ**: React + TypeScript + Vite (å‰ç«¯) | Hono + Cloudflare Workers + D1 (åç«¯) 
**è¯­è¨€**: ä»£ç ç”¨è‹±æ–‡ï¼Œæ³¨é‡Šå’Œæ–‡æ¡£ç”¨ä¸­æ–‡ 
**å¼€å‘é˜¶æ®µ**: **å¼€å‘é˜¶æ®µ** (ä¸è€ƒè™‘å‘åå…¼å®¹ï¼Œæ–°åŠŸèƒ½å¿…é¡»å®Œæ•´æ¨å¹¿)

---

## ğŸš¨ æ ¸å¿ƒæ¶æ„äº‹å® (å¿…è¯»)

> **è¯·å§‹ç»ˆç‰¢è®°ä»¥ä¸‹äº‹å®ï¼Œä¸è¦é‡å¤è¯¢é—®ï¼š**

1. **éƒ¨ç½²æ¶æ„**:
   - **å‰ç«¯**: Cloudflare Pages
   - **åç«¯**: Cloudflare Workers
   - **æ•°æ®åº“**: Cloudflare D1 (SQLite)
   - **å­˜å‚¨**: Cloudflare R2 & KV

2. **å…³é”®æŠ€æœ¯å†³ç­–**:
   - **ORM**: å¿…é¡»ä½¿ç”¨ **Drizzle ORM** (ä¸¥ç¦ä½¿ç”¨ Prisma)
   - **çŠ¶æ€ç®¡ç†**: å¿…é¡»ä½¿ç”¨ **React Query** (ä¸¥ç¦ä½¿ç”¨ Redux)
   - **ç”¨æˆ·è¡¨**: ä¸¥ç¦å¯»æ‰¾ `users` è¡¨ï¼Œæ‰€æœ‰ç”¨æˆ·æ•°æ®éƒ½åœ¨ `employees` è¡¨ä¸­
   - **é‡‘é¢æ ¼å¼**: æ‰€æœ‰é‡‘é¢ä»¥ **æ•´æ•° (cents)** å­˜å‚¨

3. **å¼€å‘è§„èŒƒ**:
   - **æ–°åŠŸèƒ½å¿…é¡»å®Œæ•´æ¨å¹¿**: å¦‚æœå¢åŠ äº†æ–°çš„ä¼˜åŒ–å·¥å…·æˆ–åŠŸèƒ½ï¼Œå¿…é¡»åœ¨æ‰€æœ‰ç›¸å…³ä½ç½®å®Œæ•´æ¨å¹¿ä½¿ç”¨
   - **ç¦æ­¢éƒ¨åˆ†ä½¿ç”¨**: ä¸å…è®¸éƒ¨åˆ†æ–¹æ³•ä½¿ç”¨æ–°å·¥å…·ï¼Œéƒ¨åˆ†ä½¿ç”¨æ—§æ–¹å¼
   - **å¿…é¡»æ€§èƒ½ç›‘æ§**: æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢å¿…é¡»æ·»åŠ æ€§èƒ½ç›‘æ§
   - **å¿…é¡»æ‰¹é‡ä¼˜åŒ–**: æ‰€æœ‰æ‰¹é‡æ“ä½œå¿…é¡»ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢å·¥å…·

---

## å¼€å‘è§„èŒƒï¼ˆé‡è¦ï¼‰

### æ–°åŠŸèƒ½å®Œæ•´æ¨å¹¿åŸåˆ™

**æ ¸å¿ƒåŸåˆ™**: å¼€å‘é˜¶æ®µä¸è€ƒè™‘å‘åå…¼å®¹ï¼Œæ–°åŠŸèƒ½å¿…é¡»åœ¨æ‰€æœ‰ç›¸å…³ä½ç½®å®Œæ•´æ¨å¹¿ä½¿ç”¨ã€‚

**å¿…é¡»éµå¾ªçš„è§„èŒƒ**:

1. **æ•°æ®åº“æŸ¥è¯¢**:
   - âœ… æ‰€æœ‰æŸ¥è¯¢å¿…é¡»ä½¿ç”¨ `DBPerformanceTracker.track()` è¿›è¡Œæ€§èƒ½ç›‘æ§
   - âœ… æ‰€æœ‰æ‰¹é‡æ“ä½œå¿…é¡»ä½¿ç”¨ `BatchQuery` å·¥å…·
   - âœ… æ¨èä½¿ç”¨ `QueryHelpers` è¾…åŠ©ç±»ç®€åŒ–ä»£ç 

2. **ç¼“å­˜ä½¿ç”¨**:
   - âœ… ä¸»æ•°æ®æŸ¥è¯¢å¿…é¡»ä½¿ç”¨ `KVCachedMasterDataService`ï¼ˆå·²ç»Ÿä¸€å¯ç”¨ï¼‰
   - âœ… æ–°å¢ä¸»æ•°æ®æ—¶å¿…é¡»åŒæ—¶æ·»åŠ ç¼“å­˜ç‰ˆæœ¬å’Œå¤±æ•ˆæœºåˆ¶

3. **æœåŠ¡ç»„ç»‡**:
   - âœ… æ‰€æœ‰æœåŠ¡å¿…é¡»æ”¾åœ¨å¯¹åº”çš„ä¸šåŠ¡åŸŸç›®å½•ï¼ˆhr/finance/assets/reports/system/auth/commonï¼‰
   - âœ… ç¦æ­¢åœ¨ services æ ¹ç›®å½•åˆ›å»ºæœåŠ¡æ–‡ä»¶

4. **é”™è¯¯å¤„ç†**:
   - âœ… å¿…é¡»ä½¿ç”¨ `Errors` å¯¹è±¡æŠ›å‡ºé”™è¯¯
   - âœ… è·¯ç”±å±‚ç»Ÿä¸€ä½¿ç”¨ `errorHandlerV2`

**ç¦æ­¢äº‹é¡¹**:
- âŒ ç¦æ­¢éƒ¨åˆ†ä½¿ç”¨æ–°å·¥å…·ï¼Œéƒ¨åˆ†ä¿ç•™æ—§å®ç°
- âŒ ç¦æ­¢è·³è¿‡æ€§èƒ½ç›‘æ§
- âŒ ç¦æ­¢åœ¨æ ¹ç›®å½•åˆ›å»ºæœåŠ¡æ–‡ä»¶

**å‚è€ƒæ–‡æ¡£**: `docs/DEVELOPMENT_STANDARDS.md`

---

## æ ¸å¿ƒæŠ€æœ¯å†³ç­–

### å·²ç¡®å®šçš„æ¶æ„å†³ç­–

1. **æƒé™ç³»ç»Ÿ**: 5å±‚å®‰å…¨æ¶æ„
   - ç½‘ç»œå±‚: IPç™½åå•
   - è®¤è¯å±‚: JWT + TOTPåŒå› ç´ 
   - åŠŸèƒ½æƒé™å±‚: RBACåŸºäºèŒä½
   - æ•°æ®èŒƒå›´å±‚: getDataAccessFilter
   - å®¡æ‰¹æµç¨‹å±‚: ApprovalService

2. **ç”¨æˆ·æ¨¡å‹**: å·²åˆ é™¤ `users` è¡¨ï¼Œç”¨æˆ·ä¿¡æ¯åˆå¹¶åˆ° `employees` è¡¨

3. **å‰ç«¯çŠ¶æ€**: ä½¿ç”¨ React Query ç®¡ç†æœåŠ¡ç«¯çŠ¶æ€ï¼Œä¸ç”¨ Redux

4. **UIç»„ä»¶åº“**: Ant Design

5. **éƒ¨ç½²å¹³å°**: Cloudflare Workers + Pages

6. **æœåŠ¡å±‚ç»„ç»‡**: æŒ‰ä¸šåŠ¡åŸŸåˆ†ç»„ï¼ˆhr/finance/assets/reports/system/auth/commonï¼‰

7. **ç¼“å­˜ç­–ç•¥**: ä¸»æ•°æ®ä½¿ç”¨ KV ç¼“å­˜ï¼Œå·²ç»Ÿä¸€å¯ç”¨

8. **æ€§èƒ½ç›‘æ§**: æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢å¿…é¡»æ·»åŠ æ€§èƒ½ç›‘æ§

### ç¼–ç è§„èŒƒ

- åç«¯æœåŠ¡ç±»å‘½å: `XxxService.ts`
- åç«¯è·¯ç”±å‘½å: `xxx.ts` (å°å†™å¤æ•°)
- å‰ç«¯é¡µé¢å‘½å: `XxxPage.tsx`
- API è·¯å¾„: `/api/xxx`
- æŸ¥è¯¢åç§°æ ¼å¼: `ServiceName.methodName.queryName`

---

## å…³é”®ç›®å½•ç»“æ„

```
backend/src/
â”œâ”€â”€ services/      # ä¸šåŠ¡é€»è¾‘å±‚ (æŒ‰ä¸šåŠ¡åŸŸåˆ†ç»„)
â”‚   â”œâ”€â”€ hr/        # äººäº‹ç›¸å…³
â”‚   â”œâ”€â”€ finance/   # è´¢åŠ¡ç›¸å…³
â”‚   â”œâ”€â”€ assets/    # èµ„äº§ç®¡ç†
â”‚   â”œâ”€â”€ reports/   # æŠ¥è¡¨
â”‚   â”œâ”€â”€ system/    # ç³»ç»Ÿç®¡ç†
â”‚   â”œâ”€â”€ auth/      # è®¤è¯
â”‚   â””â”€â”€ common/    # é€šç”¨æœåŠ¡
â”œâ”€â”€ routes/        # API è·¯ç”±
â”œâ”€â”€ db/schema.ts   # æ•°æ®åº“è¡¨å®šä¹‰ (æ ¸å¿ƒ)
â”œâ”€â”€ middleware/    # ä¸­é—´ä»¶
â””â”€â”€ utils/         # å·¥å…·å‡½æ•°
    â”œâ”€â”€ query-helpers.ts    # æŸ¥è¯¢è¾…åŠ©å·¥å…·ï¼ˆæ¨èä½¿ç”¨ï¼‰
    â”œâ”€â”€ batch-query.ts      # æ‰¹é‡æŸ¥è¯¢å·¥å…·
    â”œâ”€â”€ db-performance.ts   # æ€§èƒ½ç›‘æ§å·¥å…·
    â””â”€â”€ kv-cache.ts         # KV ç¼“å­˜å·¥å…·

frontend/src/
â”œâ”€â”€ features/      # åŠŸèƒ½æ¨¡å— (æŒ‰ä¸šåŠ¡åˆ’åˆ†)
â”œâ”€â”€ hooks/         # è‡ªå®šä¹‰ Hooks
â”œâ”€â”€ components/    # å…¬å…±ç»„ä»¶
â””â”€â”€ config/menu.ts # èœå•é…ç½®
```

---

## ä¼˜åŒ–å·¥å…·ä½¿ç”¨

### æŸ¥è¯¢è¾…åŠ©å·¥å…·ï¼ˆæ¨èï¼‰

ä½¿ç”¨ `QueryHelpers` å¯ä»¥è‡ªåŠ¨åº”ç”¨æ€§èƒ½ç›‘æ§å’Œæ‰¹é‡ä¼˜åŒ–ï¼š

```typescript
import { query, getByIds } from '../utils/query-helpers.js'

// å•ä¸ªæŸ¥è¯¢ï¼ˆè‡ªåŠ¨æ€§èƒ½ç›‘æ§ï¼‰
const employee = await query(
  this.db,
  'EmployeeService.getById',
  () => this.db.select().from(employees).where(eq(employees.id, id)).get(),
  c
)

// æ‰¹é‡è·å–ï¼ˆè‡ªåŠ¨æ€§èƒ½ç›‘æ§ + æ‰¹é‡ä¼˜åŒ–ï¼‰
const employees = await getByIds(
  this.db,
  employees,
  employeeIds,
  'EmployeeService.getByIds',
  { batchSize: 100, parallel: true },
  c
)
```

### æ‰¹é‡æŸ¥è¯¢å·¥å…·

```typescript
import { BatchQuery } from '../utils/batch-query.js'
import { DBPerformanceTracker } from '../utils/db-performance.js'

const employees = await DBPerformanceTracker.track(
  'ServiceName.methodName',
  () => BatchQuery.getByIds(db, table, ids, {
    batchSize: 100,
    parallel: true,
    queryName: 'getEmployees'
  }),
  c
)
```

### KV ç¼“å­˜

ä¸»æ•°æ®æœåŠ¡å·²ç»Ÿä¸€å¯ç”¨ KV ç¼“å­˜ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

---

## é¡¹ç›®æ–‡æ¡£

å®Œæ•´æ–‡æ¡£ä½äº `.qoder/repowiki/zh/content/`ï¼ŒåŒ…å«ï¼š
- ç³»ç»Ÿæ¦‚è¿°å’Œå¿«é€Ÿå…¥é—¨
- æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯´æ˜
- API å‚è€ƒæ–‡æ¡£
- æ•°æ®åº“è®¾è®¡æ–‡æ¡£
- è®¤è¯ä¸æƒé™ç³»ç»Ÿè¯´æ˜

**å¼€å‘è§„èŒƒ**: `docs/DEVELOPMENT_STANDARDS.md`  
**ä½¿ç”¨æŒ‡å—**: `docs/USAGE_GUIDE.md`  
**çŸ¥è¯†ç´¢å¼•**: `.agent/KNOWLEDGE_INDEX.md`

---

## å½“å‰å¼€å‘é‡ç‚¹

- è´¢åŠ¡æµç¨‹ä¼˜åŒ–
- æŠ¥è¡¨åŠŸèƒ½å®Œå–„
- æ€§èƒ½ä¼˜åŒ–
- **æ–°åŠŸèƒ½å®Œæ•´æ¨å¹¿**

---

## ç”¨æˆ·åå¥½

- å›å¤è¯­è¨€: **ä¸­æ–‡**
- ä»£ç æ³¨é‡Š: **ä¸­æ–‡**
- è§£é‡Šé£æ ¼: **ç®€æ´ç›´æ¥**
- é”™è¯¯å¤„ç†: **è¯¦ç»†è¯´æ˜åŸå› **
- **å¼€å‘è§„èŒƒ**: **æ–°åŠŸèƒ½å¿…é¡»å®Œæ•´æ¨å¹¿ï¼Œä¸è€ƒè™‘å‘åå…¼å®¹**

---

## å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘ç¯å¢ƒ
cd backend && npm run dev    # åç«¯ :8787
cd frontend && npm run dev   # å‰ç«¯ :5173

# æ•°æ®åº“è¿ç§»
cd backend && npm run migrate:all

# è¿è¡Œæµ‹è¯•
cd backend && npm test
cd frontend && npx playwright test
```

---

## æ³¨æ„äº‹é¡¹

1. åç«¯è¿è¡Œåœ¨ Cloudflare Workers ç¯å¢ƒï¼Œä¸æ”¯æŒ Node.js åŸç”Ÿ API
2. æ•°æ®åº“æ˜¯ SQLite (D1)ï¼Œè¯­æ³•ä¸ MySQL ä¸åŒ
3. ä¿®æ”¹ schema.ts åéœ€è¦ç”Ÿæˆè¿ç§»æ–‡ä»¶
4. æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€API Keyï¼‰ä¸è¦ç¡¬ç¼–ç 
5. **æ–°åŠŸèƒ½å¿…é¡»å®Œæ•´æ¨å¹¿ï¼Œä¸å…è®¸éƒ¨åˆ†ä½¿ç”¨**
6. **æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢å¿…é¡»æ·»åŠ æ€§èƒ½ç›‘æ§**
7. **æ‰€æœ‰æ‰¹é‡æ“ä½œå¿…é¡»ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢å·¥å…·**

---

## æ ¸å¿ƒæ•°æ®è¡¨

### ç»„ç»‡æ¶æ„
| è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|---------|
| `employees` | å‘˜å·¥ä¿¡æ¯ï¼ˆå«è®¤è¯ï¼‰ | id, email, name, positionId, departmentId, passwordHash, totpSecret |
| `positions` | èŒä½å®šä¹‰ | code, level, functionRole, permissions |
| `departments` | é¡¹ç›®/éƒ¨é—¨ | hqId, name |
| `headquarters` | æ€»éƒ¨ | name |
| `orgDepartments` | ç»„ç»‡æ¶æ„éƒ¨é—¨ | projectId, parentId, allowedModules |

### è´¢åŠ¡ç›¸å…³
| è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|---------|
| `accounts` | è´¦æˆ· | name, type, currency, openingCents |
| `cashFlows` | ç°é‡‘æµæ°´ | type(income/expense), accountId, amountCents |
| `arApDocs` | åº”æ”¶åº”ä»˜å•æ® | kind(AR/AP), amountCents, status |
| `settlements` | ç»“ç®—è®°å½• | docId, flowId, settleAmountCents |
| `accountTransfers` | è´¦æˆ·è½¬è´¦ | fromAccountId, toAccountId, exchangeRate |

### è–ªèµ„è¡¥è´´
| è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|---------|
| `employeeSalaries` | å‘˜å·¥è–ªèµ„æ ‡å‡† | salaryType(probation/regular), amountCents |
| `salaryPayments` | è–ªèµ„å‘æ”¾è®°å½• | status, allocationStatus |
| `salaryPaymentAllocations` | è–ªèµ„åˆ†é…ï¼ˆå¤šå¸ç§ï¼‰ | currencyId, amountCents |
| `employeeAllowances` | å‘˜å·¥è¡¥è´´æ ‡å‡† | allowanceType, amountCents |
| `allowancePayments` | è¡¥è´´å‘æ”¾è®°å½• | year, month, paymentDate |

### èµ„äº§ç®¡ç†
| è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|---------|
| `fixedAssets` | å›ºå®šèµ„äº§ | assetCode, status, currentValueCents |
| `fixedAssetAllocations` | èµ„äº§åˆ†é… | assetId, employeeId |
| `rentalProperties` | ç§Ÿèµç‰©ä¸š | propertyType, monthlyRentCents |
| `dormitoryAllocations` | å®¿èˆåˆ†é… | propertyId, employeeId |

### å€Ÿæ¬¾æŠ¥é”€
| è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|---------|
| `borrowings` | å€Ÿæ¬¾ | userId, amountCents, status |
| `repayments` | è¿˜æ¬¾ | borrowingId, amountCents |
| `expenseReimbursements` | è´¹ç”¨æŠ¥é”€ | expenseType, status |

---

## æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. è–ªèµ„å‘æ”¾æµç¨‹
```
ç”Ÿæˆè–ªèµ„ â†’ å‘˜å·¥ç¡®è®¤ â†’ è´¢åŠ¡å®¡æ‰¹ â†’ è´§å¸åˆ†é…ç”³è¯· â†’ åˆ†é…å®¡æ‰¹ â†’ è½¬è´¦æ”¯ä»˜ â†’ ç¡®è®¤å®Œæˆ
```
çŠ¶æ€æµè½¬: `pending_employee_confirmation` â†’ `pending_finance_approval` â†’ `pending_payment` â†’ `pending_payment_confirmation` â†’ `completed`

### 2. å€Ÿæ¬¾æµç¨‹
```
å‘˜å·¥ç”³è¯·å€Ÿæ¬¾ â†’ å®¡æ‰¹ â†’ æ”¾æ¬¾ï¼ˆåˆ›å»ºæµæ°´ï¼‰ â†’ è¿˜æ¬¾ï¼ˆå¤šæ¬¡ï¼‰ â†’ ç»“æ¸…
```
çŠ¶æ€: `pending` â†’ `approved` â†’ `outstanding` â†’ `partial` â†’ `repaid`

### 3. åº”æ”¶åº”ä»˜ç»“ç®—
```
åˆ›å»º AR/AP å•æ® â†’ å…³è”ç°é‡‘æµæ°´ â†’ åˆ›å»ºç»“ç®—è®°å½• â†’ æ›´æ–°å•æ®çŠ¶æ€
```
çŠ¶æ€: `open` â†’ `partial` â†’ `settled`

### 4. å‘˜å·¥å…¥èŒæµç¨‹
```
åˆ›å»ºå‘˜å·¥ â†’ è®¾ç½®è–ªèµ„/è¡¥è´´ â†’ å‘é€æ¿€æ´»é‚®ä»¶ â†’ é¦–æ¬¡ç™»å½•æ”¹å¯†ç  â†’ ç»‘å®š TOTP
```

---

## å…³é”®æœåŠ¡ç±»

| æœåŠ¡ | èŒè´£ | å…³é”®æ–¹æ³• |
|------|------|---------|
| `EmployeeService` | å‘˜å·¥ CRUDã€çŠ¶æ€ç®¡ç† | create, update, changeStatus |
| `AuthService` | è®¤è¯ã€JWTã€å¯†ç  | login, verifyTotp, changePassword |
| `FinanceService` | è´¢åŠ¡æµæ°´ã€è´¦æˆ· | createFlow, getAccountBalance |
| `SalaryService` | è–ªèµ„å‘æ”¾å…¨æµç¨‹ | generatePayment, confirmPayment |
| `MasterDataService` | ä¸»æ•°æ®ç®¡ç†ï¼ˆå·²å¯ç”¨KVç¼“å­˜ï¼‰ | å„ç±»åŸºç¡€æ•°æ® CRUD |
| `ApprovalService` | å®¡æ‰¹æµç¨‹ | approve, reject |
| `ReportService` | æŠ¥è¡¨ç”Ÿæˆ | å„ç±»ç»Ÿè®¡æŠ¥è¡¨ |

---

## æƒé™å±‚çº§è¯´æ˜

```
èŒä½å±‚çº§ (level):
 1 - è¶…çº§ç®¡ç†å‘˜ (hq_manager)
 2 - é¡¹ç›®ä¸»ç®¡ (project_manager)
 3 - ç»„é•¿ (team_leader)
 4 - é«˜çº§å·¥ç¨‹å¸ˆ (senior_engineer)
 5 - å·¥ç¨‹å¸ˆ (engineer)

åŠŸèƒ½è§’è‰² (functionRole):
 - manager: ç®¡ç†ç±»
 - finance: è´¢åŠ¡ç±»
 - hr: äººäº‹ç±»
 - engineer: å·¥ç¨‹ç±»

æ•°æ®èŒƒå›´:
 - æ€»éƒ¨ä¸»ç®¡: å¯è§æ‰€æœ‰é¡¹ç›®
 - é¡¹ç›®ä¸»ç®¡: ä»…å¯è§æœ¬é¡¹ç›®
 - ç»„é•¿åŠä»¥ä¸‹: ä»…å¯è§æœ¬ç»„
```

---

## å¸¸è§å¼€å‘ä»»åŠ¡

### æ·»åŠ æ–°çš„ API ç«¯ç‚¹
1. åœ¨ `backend/src/routes/v2/` åˆ›å»ºæˆ–ä¿®æ”¹è·¯ç”±æ–‡ä»¶
2. åœ¨ `backend/src/services/` å¯¹åº”ä¸šåŠ¡åŸŸç›®å½•æ·»åŠ ä¸šåŠ¡é€»è¾‘
3. åœ¨ `backend/src/index.ts` æ³¨å†Œè·¯ç”±
4. æ·»åŠ æƒé™æ£€æŸ¥ (`protectRoute` æˆ– `hasPermission`)
5. **å¿…é¡»æ·»åŠ æ€§èƒ½ç›‘æ§**

### æ·»åŠ æ–°çš„æ•°æ®è¡¨
1. åœ¨ `backend/src/db/schema.ts` å®šä¹‰è¡¨ç»“æ„
2. è¿è¡Œ `npm run generate` ç”Ÿæˆè¿ç§»
3. è¿è¡Œ `npm run migrate:all` åº”ç”¨è¿ç§»

### æ·»åŠ å‰ç«¯é¡µé¢
1. åœ¨ `frontend/src/features/xxx/` åˆ›å»ºé¡µé¢ç»„ä»¶
2. åœ¨ `frontend/src/router/index.tsx` æ·»åŠ è·¯ç”±
3. åœ¨ `frontend/src/config/menu.ts` æ·»åŠ èœå•é¡¹

### æ·»åŠ æ–°çš„æœåŠ¡
1. **ç¡®å®šä¸šåŠ¡åŸŸ**ï¼Œåœ¨å¯¹åº”ç›®å½•åˆ›å»ºæœåŠ¡æ–‡ä»¶
2. åœ¨ `backend/src/middleware/di.ts` æ³¨å†ŒæœåŠ¡
3. **ä½¿ç”¨ QueryHelpers æˆ–æ·»åŠ æ€§èƒ½ç›‘æ§**
4. **æ‰¹é‡æ“ä½œå¿…é¡»ä½¿ç”¨ BatchQuery**

### è°ƒè¯• API é—®é¢˜
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„ç½‘ç»œè¯·æ±‚
2. åç«¯æ—¥å¿—åœ¨ Wrangler ç»ˆç«¯è¾“å‡º
3. ä½¿ç”¨ `console.log` è°ƒè¯•ï¼ˆWorkers ç¯å¢ƒæ”¯æŒï¼‰
4. æŸ¥çœ‹æ€§èƒ½ç›‘æ§æ•°æ®ï¼ˆ`/api/health`ï¼‰

---

## é‡‘é¢å¤„ç†è§„èŒƒ

- **æ‰€æœ‰é‡‘é¢å­˜å‚¨ä¸ºæ•´æ•° (cents)**ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
- å‰ç«¯æ˜¾ç¤ºæ—¶é™¤ä»¥ 100
- å˜é‡å‘½å: `amountCents`, `salaryCents`, `priceCents`
- é‡‘é¢è®¡ç®—ç”¨ `Math.round()` ç¡®ä¿æ•´æ•°

---

## Cloudflare éƒ¨ç½²é…ç½®

### æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Cloudflare å¹³å°                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ caiwu-backendâ”‚  â”‚  caiwu-email â”‚  â”‚ Cloudflare   â”‚       â”‚
â”‚  â”‚  (Workers)   â”‚â”€â”€â”‚  (Workers)   â”‚  â”‚   Pages      â”‚       â”‚
â”‚  â”‚  :8787       â”‚  â”‚              â”‚  â”‚  (Frontend)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  D1 Database â”‚  â”‚   R2 Bucket  â”‚  â”‚   KV Store   â”‚       â”‚
â”‚  â”‚  (caiwu-db)  â”‚  â”‚  (vouchers)  â”‚  â”‚  (sessions)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èµ„æºç»‘å®š

| æœåŠ¡ | åç§° | ç»‘å®šå˜é‡ | ç”¨é€” |
|------|------|---------|------|
| **Workers** | caiwu-backend | - | åç«¯ API |
| **Workers** | caiwu-email | EMAIL_SERVICE | é‚®ä»¶å‘é€ |
| **D1** | caiwu-db | DB | SQLite æ•°æ®åº“ |
| **R2** | caiwu-vouchers | VOUCHERS | å‡­è¯å›¾ç‰‡å­˜å‚¨ |
| **KV** | sessions | SESSIONS_KV | ä¼šè¯å­˜å‚¨ + ä¸»æ•°æ®ç¼“å­˜ |

### ç¯å¢ƒå˜é‡

| å˜é‡ | è¯´æ˜ | è®¾ç½®æ–¹å¼ |
|------|------|---------|
| `AUTH_JWT_SECRET` | JWT ç­¾åå¯†é’¥ | `wrangler secret put` |
| `EMAIL_TOKEN` | é‚®ä»¶æœåŠ¡ Token | `wrangler secret put` |
| `CF_ACCOUNT_ID` | Cloudflare è´¦æˆ· ID | wrangler.toml ä¸­é…ç½® |
| `CF_ZONE_ID` | åŸŸå Zone ID | wrangler.toml ä¸­é…ç½® |
| `CF_IP_LIST_ID` | IP ç™½åå•åˆ—è¡¨ ID | wrangler.toml ä¸­é…ç½® |

### éƒ¨ç½²å‘½ä»¤

```bash
# åç«¯éƒ¨ç½²
cd backend && npm run deploy

# å‰ç«¯æ„å»ºï¼ˆéƒ¨ç½²åˆ° Pages éœ€è¦åœ¨ Cloudflare Dashboard é…ç½®ï¼‰
cd frontend && npm run build

# é‚®ä»¶æœåŠ¡éƒ¨ç½²
cd email-worker && wrangler deploy
```

### æ•°æ®åº“è¿ç§»

```bash
# æœ¬åœ°è¿ç§»ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
cd backend && npm run migrate

# è¿œç¨‹è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
cd backend && npm run migrate:remote

# è¿ç§»æ‰€æœ‰æ–‡ä»¶
cd backend && npm run migrate:all
```

### Secret ç®¡ç†

```bash
# è®¾ç½® JWT å¯†é’¥ï¼ˆåç«¯ï¼‰
cd backend && wrangler secret put AUTH_JWT_SECRET

# è®¾ç½®é‚®ä»¶ Tokenï¼ˆé‚®ä»¶æœåŠ¡ï¼‰
cd email-worker && wrangler secret put EMAIL_TOKEN

# æŸ¥çœ‹å·²è®¾ç½®çš„ Secret
wrangler secret list
```

### wrangler.toml å…³é”®é…ç½®

```toml
# åç«¯é…ç½®ç¤ºä¾‹
name = "caiwu-backend"
main = "src/index.ts"
compatibility_date = "2024-11-21"
compatibility_flags = ["nodejs_compat"]

# D1 æ•°æ®åº“ç»‘å®š
[[d1_databases]]
binding = "DB"
database_name = "caiwu-db"

# R2 å­˜å‚¨ç»‘å®š
[[r2_buckets]]
binding = "VOUCHERS"
bucket_name = "caiwu-vouchers"

# KV å‘½åç©ºé—´ç»‘å®š
[[kv_namespaces]]
binding = "SESSIONS_KV"

# é‚®ä»¶æœåŠ¡ç»‘å®š
[[services]]
binding = "EMAIL_SERVICE"
service = "caiwu-email"
```

### å¸¸è§éƒ¨ç½²é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| "binding not found" | æ£€æŸ¥ wrangler.toml ä¸­çš„ binding åç§°æ˜¯å¦æ­£ç¡® |
| "D1_ERROR" | è¿è¡Œ `npm run migrate:remote` åº”ç”¨è¿ç§» |
| "Authentication failed" | è¿è¡Œ `wrangler login` é‡æ–°ç™»å½• |
| "Secret not found" | è¿è¡Œ `wrangler secret put <KEY>` è®¾ç½®å¯†é’¥ |
| "Pages éƒ¨ç½²å¤±è´¥" | æ£€æŸ¥ `npm run build` æ˜¯å¦æˆåŠŸï¼ŒæŸ¥çœ‹æ„å»ºæ—¥å¿— |

### æœ¬åœ°å¼€å‘ vs ç”Ÿäº§ç¯å¢ƒ

| é…ç½® | æœ¬åœ° (dev) | ç”Ÿäº§ (production) |
|------|-----------|------------------|
| æ•°æ®åº“ | æœ¬åœ° SQLite | Cloudflare D1 |
| API åœ°å€ | localhost:8787 | your-domain.workers.dev |
| JWT Secret | env.dev.vars ä¸­é…ç½® | wrangler secret |
| æ—¥å¿— | ç»ˆç«¯è¾“å‡º | Cloudflare Dashboard |
