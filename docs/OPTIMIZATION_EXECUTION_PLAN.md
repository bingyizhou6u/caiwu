# 代码规范优化执行计划

**创建时间**: 2025-01-27  
**执行方式**: 按模块逐步优化  
**预计完成时间**: 2-3周

---

## 🎯 执行策略

### 策略：模块化、渐进式优化

1. **按模块优化** - 降低风险，便于测试
2. **优先核心服务** - 先优化高频使用的服务
3. **逐步验证** - 每个模块优化后立即测试
4. **文档同步** - 优化过程中同步更新文档

---

## 📅 详细执行计划

### 第1周：核心模块优化

#### Day 1-2: HR 模块 - EmployeeService

**目标**: 修复 EmployeeService 中所有查询的性能监控

**任务清单**:
- [ ] 修复 create 方法中的查询（5处）
- [ ] 修复 resendActivationEmail 方法（1处）
- [ ] 修复 resetTotp 方法（1处）
- [ ] 修复 changeStatus 方法（2处）
- [ ] 修复 update 方法（1处）
- [ ] 修复 getById 方法（1处）
- [ ] 修复 getByEmail 方法（1处）
- [ ] 修复其他方法（3处）

**修复步骤**:
1. 备份文件
2. 逐个方法修复
3. 运行测试验证
4. 提交代码

**验收标准**:
- [ ] 所有查询都使用 `query()` 或 `DBPerformanceTracker.track()`
- [ ] 查询名称符合规范
- [ ] 代码通过类型检查
- [ ] 单元测试通过

---

#### Day 3: HR 模块 - 其他服务

**目标**: 修复其他 HR 服务的性能监控

**任务清单**:
- [ ] SalaryPaymentGenerationService - 完善性能监控（1处）
- [ ] SalaryPaymentProcessingService - 添加性能监控（2处）

**验收标准**:
- [ ] 所有查询都添加了性能监控
- [ ] 测试通过

---

#### Day 4-5: Finance 模块

**目标**: 修复 Finance 模块所有服务的性能监控和批量查询

**任务清单**:
- [ ] FinanceService - 添加性能监控（1处）
- [ ] ArApService - 添加性能监控（4处）
- [ ] AccountTransferService - 优化批量查询（1处）

**验收标准**:
- [ ] 所有查询都添加了性能监控
- [ ] 批量查询都使用了批量查询工具
- [ ] 测试通过

---

### 第2周：其他模块优化

#### Day 6-7: Assets 模块

**目标**: 修复 Assets 模块所有服务的性能监控和批量查询

**任务清单**:
- [ ] FixedAssetService - 添加性能监控（10处）
- [ ] FixedAssetAllocationService - 添加性能监控（2处）+ 优化批量查询（1处）
- [ ] FixedAssetDepreciationService - 添加性能监控（1处）
- [ ] FixedAssetChangeService - 添加性能监控（1处）

**验收标准**:
- [ ] 所有查询都添加了性能监控
- [ ] 批量查询都使用了批量查询工具
- [ ] 测试通过

---

#### Day 8: System 模块

**目标**: 修复 System 模块的性能监控

**任务清单**:
- [ ] SystemConfigService - 添加性能监控（2处）
- [ ] 检查其他 System 服务

**验收标准**:
- [ ] 所有查询都添加了性能监控
- [ ] 测试通过

---

#### Day 9: Auth 模块

**目标**: 修复 Auth 模块的性能监控

**任务清单**:
- [ ] AuthService - 添加性能监控（3处）

**验收标准**:
- [ ] 所有查询都添加了性能监控
- [ ] 测试通过

---

#### Day 10: Common 模块

**目标**: 完善 Common 模块的性能监控

**任务清单**:
- [ ] ApprovalService - 完善性能监控（1处）
- [ ] 检查其他 Common 服务

**验收标准**:
- [ ] 所有查询都添加了性能监控
- [ ] 测试通过

---

### 第3周：测试和优化

#### Day 11-12: 全面测试

**任务清单**:
- [ ] 运行所有单元测试
- [ ] 运行集成测试
- [ ] 性能测试
- [ ] 修复测试中发现的问题

---

#### Day 13-14: 优化和文档

**任务清单**:
- [ ] 性能优化
- [ ] 代码审查
- [ ] 更新文档
- [ ] 生成最终报告

---

## 🛠️ 修复工具和资源

### 1. 修复模板

参考: `docs/FIX_TEMPLATES.md`

### 2. 检查清单

参考: `docs/MODULE_FIX_CHECKLIST.md`

### 3. 检查脚本

运行检查脚本验证修复：
```bash
cd backend
tsx scripts/check-standards.ts
```

---

## ✅ 每日检查清单

### 开始修复前

- [ ] 阅读修复模板
- [ ] 理解代码逻辑
- [ ] 确认 Context 可用性
- [ ] 备份文件

### 修复过程中

- [ ] 使用 QueryHelpers 或 DBPerformanceTracker
- [ ] 查询名称符合规范
- [ ] 保持原有逻辑
- [ ] 处理 Context 参数

### 修复完成后

- [ ] 代码通过类型检查
- [ ] 运行相关测试
- [ ] 检查性能监控是否工作
- [ ] 更新修复清单
- [ ] 提交代码

---

## 📊 进度跟踪

### 每日进度更新

**格式**:
```
## Day X: [模块名]

### 完成
- [x] 文件1 - 修复X处查询
- [x] 文件2 - 修复X处查询

### 进行中
- [ ] 文件3 - 修复中

### 问题
- 问题描述和解决方案

### 明日计划
- 计划内容
```

---

## 🎯 成功标准

### 模块级别

- [ ] 所有查询都添加了性能监控
- [ ] 所有批量查询都使用了批量查询工具
- [ ] 代码通过类型检查
- [ ] 所有测试通过
- [ ] 性能指标正常

### 项目级别

- [ ] 性能监控覆盖率 100%
- [ ] 批量查询优化率 100%
- [ ] 所有测试通过
- [ ] 性能测试通过
- [ ] 文档更新完成

---

## 📝 注意事项

### 1. 风险控制

- **备份代码**: 修复前备份文件
- **小步提交**: 每个方法修复后提交
- **及时测试**: 修复后立即测试

### 2. 代码质量

- **保持逻辑不变**: 只添加性能监控，不改变业务逻辑
- **命名规范**: 查询名称必须符合规范
- **类型安全**: 确保类型检查通过

### 3. 性能考虑

- **批量大小**: 根据数据量调整 batchSize
- **并行/串行**: 查询并行，更新/插入串行
- **Context 传递**: 尽量传递 Context 获取更好的监控数据

---

## 🔄 更新记录

- 2025-01-27: 创建执行计划

---

**计划创建时间**: 2025-01-27  
**预计开始时间**: 2025-01-28  
**预计完成时间**: 2025-02-17
