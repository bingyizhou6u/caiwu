# å®‰å…¨ä¼˜åŒ–æ€»ç»“

**ä¼˜åŒ–æ—¥æœŸ**: 2025-01-27  
**ä¼˜åŒ–èŒƒå›´**: æ–‡ä»¶ä¸Šä¼ å®‰å…¨ã€é”™è¯¯å¤„ç†ã€å¥åº·æ£€æŸ¥ç«¯ç‚¹ã€è¾“å…¥éªŒè¯

---

## å·²å®Œæˆçš„ä¼˜åŒ–

### 1. æ–‡ä»¶å†…å®¹éªŒè¯ï¼ˆMagic Numberï¼‰âœ…

**é—®é¢˜**: ä»…ä¾èµ– MIME ç±»å‹éªŒè¯æ–‡ä»¶ï¼Œå¯èƒ½è¢«ç»•è¿‡

**è§£å†³æ–¹æ¡ˆ**: åˆ›å»ºäº† `file-validation.ts` å·¥å…·ï¼Œå®ç° Magic Number éªŒè¯

**å®ç°**:
- âœ… JPEG: `FF D8 FF E0/E1/E2/E3/DB`
- âœ… PNG: `89 50 4E 47`
- âœ… GIF: `47 49 46 38 37/39 61`
- âœ… WebP: `52 49 46 46` + `WEBP` ç­¾å
- âœ… PDF: `25 50 44 46` (%PDF)

**ä»£ç ä½ç½®**: `backend/src/utils/file-validation.ts`

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
import { validateImageFile, generateSafeFileName } from '../../utils/file-validation.js'

const validation = await validateImageFile(file, ['image/webp'])
if (!validation.valid) {
  throw Errors.VALIDATION_ERROR(validation.error)
}
```

### 2. æ–‡ä»¶åå®‰å…¨å¤„ç†âœ…

**é—®é¢˜**: ç”¨æˆ·æ§åˆ¶çš„æ–‡ä»¶åå¯èƒ½å¯¼è‡´è·¯å¾„éå†æ”»å‡»

**è§£å†³æ–¹æ¡ˆ**: å®ç° `generateSafeFileName` å‡½æ•°

**ç‰¹æ€§**:
- âœ… ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºå­—ç¬¦ä¸²ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
- âœ… ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢è·¯å¾„éå†
- âœ… é™åˆ¶æ–‡ä»¶åé•¿åº¦

### 3. CORS é…ç½®ä¼˜åŒ–âœ…

**é—®é¢˜**: ä½¿ç”¨ `includes` æ£€æŸ¥å¯èƒ½è¢«ç»•è¿‡ï¼ˆå¦‚ `evil.pages.dev`ï¼‰

**è§£å†³æ–¹æ¡ˆ**: æ”¹ä¸ºç²¾ç¡®åŒ¹é…ç™½åå•

**å®ç°**:
```typescript
const ALLOWED_ORIGINS = [
  'http://localhost:5173',
  'http://127.0.0.1:5173',
  // ç”Ÿäº§ç¯å¢ƒéœ€è¦é…ç½®å®é™…åŸŸå
]
```

**ä»£ç ä½ç½®**: `backend/src/index.ts:60-90`

### 4. è¾“å…¥éªŒè¯å¢å¼ºâœ…

**é—®é¢˜**: å¹´ä»½å‚æ•°ç¼ºå°‘æ ¼å¼éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´ SQL æ³¨å…¥

**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ å¹´ä»½æ ¼å¼éªŒè¯ï¼ˆ4ä½æ•°å­—ï¼‰

**å®ç°**:
```typescript
if (params.year && !/^\d{4}$/.test(params.year)) {
  throw Errors.VALIDATION_ERROR('å¹´ä»½æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º4ä½æ•°å­—ï¼ˆå¦‚ï¼š2023ï¼‰')
}
```

**ä»£ç ä½ç½®**: `backend/src/services/hr/EmployeeLeaveService.ts`

### 5. é”™è¯¯å¤„ç†ä¼˜åŒ–âœ…

**é—®é¢˜**: ç”Ÿäº§ç¯å¢ƒè¿”å›è¯¦ç»†é”™è¯¯å †æ ˆï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**: æ ¹æ®ç¯å¢ƒåˆ¤æ–­ï¼Œç”Ÿäº§ç¯å¢ƒè¿”å›é€šç”¨é”™è¯¯æ¶ˆæ¯

**å®ç°**:
```typescript
const isProduction = c.req.url.includes('https://') && !c.req.url.includes('localhost')

return c.json({
  error: {
    code: ErrorCodes.SYS_INTERNAL_ERROR,
    message: isProduction ? 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' : err.message,
    ...(isProduction ? {} : { stack: err.stack }),
  }
}, 500)
```

**ä»£ç ä½ç½®**: `backend/src/utils/errors.ts`

### 6. å¥åº·æ£€æŸ¥ç«¯ç‚¹ä¼˜åŒ–âœ…

**é—®é¢˜**: å¥åº·æ£€æŸ¥ç«¯ç‚¹å¯èƒ½æ³„éœ²ç³»ç»Ÿæ•æ„Ÿä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**: ç”Ÿäº§ç¯å¢ƒéšè—è¯¦ç»†æŒ‡æ ‡å’Œç¼“å­˜ç»Ÿè®¡

**å®ç°**:
```typescript
const isProduction = c.req.url.includes('https://') && !c.req.url.includes('localhost')

return c.json({
  status: healthy ? 'healthy' : 'degraded',
  checks,
  timestamp: new Date().toISOString(),
  // ç”Ÿäº§ç¯å¢ƒä¸è¿”å›è¯¦ç»†æŒ‡æ ‡
  ...(isProduction ? {} : { metrics: {...}, cache: {...} }),
})
```

**ä»£ç ä½ç½®**: `backend/src/index.ts:122-230`

---

## æ–°å¢å·¥å…·å’Œå‡½æ•°

### `file-validation.ts`

**å¯¼å‡ºå‡½æ•°**:
1. `validateFileMagicNumber()` - éªŒè¯æ–‡ä»¶ Magic Number
2. `validatePdfMagicNumber()` - éªŒè¯ PDF æ–‡ä»¶
3. `validateImageFile()` - éªŒè¯å›¾ç‰‡æ–‡ä»¶ï¼ˆåŒ…å« Magic Numberï¼‰
4. `validatePdfFile()` - éªŒè¯ PDF æ–‡ä»¶ï¼ˆåŒ…å« Magic Numberï¼‰
5. `validateFileName()` - éªŒè¯æ–‡ä»¶åå®‰å…¨æ€§
6. `generateSafeFileName()` - ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å

---

## å®‰å…¨æ”¹è¿›ç»Ÿè®¡

| ç±»åˆ« | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|------|--------|--------|------|
| æ–‡ä»¶éªŒè¯ | MIME ç±»å‹ | MIME + Magic Number | âœ… å¢å¼º |
| CORS é…ç½® | `includes` æ£€æŸ¥ | ç²¾ç¡®åŒ¹é… | âœ… å¢å¼º |
| è¾“å…¥éªŒè¯ | éƒ¨åˆ†éªŒè¯ | å®Œæ•´éªŒè¯ | âœ… å¢å¼º |
| é”™è¯¯å¤„ç† | è¿”å›å †æ ˆ | ç¯å¢ƒåˆ¤æ–­ | âœ… å¢å¼º |
| å¥åº·æ£€æŸ¥ | è¿”å›æ‰€æœ‰ä¿¡æ¯ | ç”Ÿäº§ç¯å¢ƒéšè— | âœ… å¢å¼º |

---

## æµ‹è¯•å»ºè®®

1. **æ–‡ä»¶ä¸Šä¼ æµ‹è¯•**:
   - æµ‹è¯•ä¼ªé€  MIME ç±»å‹çš„æ–‡ä»¶ï¼ˆå¦‚å°† .exe æ”¹ä¸º .webpï¼‰
   - éªŒè¯ Magic Number æ£€æŸ¥æ˜¯å¦ç”Ÿæ•ˆ

2. **CORS æµ‹è¯•**:
   - æµ‹è¯• `evil.pages.dev` æ˜¯å¦è¢«æ‹’ç»
   - éªŒè¯ç²¾ç¡®åŒ¹é…æ˜¯å¦ç”Ÿæ•ˆ

3. **é”™è¯¯å¤„ç†æµ‹è¯•**:
   - åœ¨ç”Ÿäº§ç¯å¢ƒè§¦å‘é”™è¯¯ï¼ŒéªŒè¯ä¸è¿”å›å †æ ˆ
   - åœ¨å¼€å‘ç¯å¢ƒè§¦å‘é”™è¯¯ï¼ŒéªŒè¯è¿”å›è¯¦ç»†ä¿¡æ¯

---

## åç»­å»ºè®®

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

1. **æ–‡ä»¶å†…å®¹æ‰«æ**: è€ƒè™‘æ·»åŠ ç—…æ¯’æ‰«æï¼ˆå¦‚éœ€è¦ï¼‰
2. **æ–‡ä»¶å¤§å°é™åˆ¶**: æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ä¸åŒæ–‡ä»¶ç±»å‹çš„é™åˆ¶
3. **æ–‡ä»¶å­˜å‚¨åŠ å¯†**: è€ƒè™‘å¯¹æ•æ„Ÿæ–‡ä»¶è¿›è¡ŒåŠ å¯†å­˜å‚¨

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-01-27  
**ä¼˜åŒ–äººå‘˜**: AI Security Optimizer

